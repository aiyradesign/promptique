<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Prompt Generator – Classic Studio | prompt.ique</title>
    <meta name="description" content="Buat prompt AI untuk desain action figure dengan gaya visual studio klasik yang elegan.">
    
    <meta property="og:title" content="Promptique | AI Prompt Generator Classic Studio">
    <meta property="og:description" content="Buat prompt AI untuk desain action figure keren dengan tema studio klasik. Siap digunakan di ChatGPT, Midjourney, dan AI Studio.">
    <meta property="og:image" content="https://promptique.my.id/generator-figure/action_poster_classic.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:url" content="https://promptique.my.id/generator-figure">
    <meta property="og:type" content="website">

    <link rel="icon" href="../icon.png" type="image/png" />
    
    <!-- Tailwind CSS & Font Awesome -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Exo+2:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- CYBERPUNK (DARK) THEME --- */
        :root {
            --cp-bg: #0a0f2c;
            --cp-panel-bg: rgba(15, 23, 42, 0.8);
            --cp-border: #3d5afe; /* Neon Blue */
            --cp-text-primary: #e0e0e0;
            --cp-text-secondary: #89a1c9;
            --cp-accent-magenta: #ff00ff;
            --cp-accent-cyan: #00ffff;
            --cp-accent-yellow: #fffb00;
            --cp-error: #ff3366;
            --cp-success: #00ffaa;
        }

        @keyframes flicker {
            0%, 100% { opacity: 1; text-shadow: 0 0 5px var(--cp-accent-cyan), 0 0 10px var(--cp-accent-cyan), 0 0 15px var(--cp-accent-cyan); }
            50% { opacity: 0.8; text-shadow: 0 0 2px var(--cp-accent-cyan), 0 0 5px var(--cp-accent-cyan); }
        }
        
        @keyframes scanlines {
            0% { background-position: 0 0; }
            100% { background-position: 0 100%; }
        }

        body {
            font-family: 'Exo 2', sans-serif;
            background-color: var(--cp-bg);
            color: var(--cp-text-primary);
            background-image: 
                linear-gradient(rgba(10, 15, 44, 0.95), rgba(10, 15, 44, 0.95)),
                url('https://www.transparenttextures.com/patterns/carbon-fibre.png');
            position: relative;
            transition: background-color 0.5s, color 0.5s;
        }
        
        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(0deg, rgba(0, 255, 255, 0.03), rgba(0, 255, 255, 0.04) 1px, transparent 1px, transparent 4px);
            animation: scanlines 1s linear infinite;
            pointer-events: none;
            z-index: -1;
            transition: opacity 0.5s;
        }

        .gradient-text {
            font-family: 'Orbitron', sans-serif;
            font-weight: 900;
            background: linear-gradient(90deg, var(--cp-accent-cyan), var(--cp-accent-magenta), var(--cp-accent-yellow));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-fill-color: transparent;
            animation: flicker 3s infinite;
            text-shadow: 0 0 3px rgba(255, 0, 255, 0.5);
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--cp-text-secondary);
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 1px;
            text-shadow: 0 0 2px var(--cp-accent-cyan);
            transition: color 0.3s;
        }

        .form-input, .form-textarea, .form-select {
            width: 100%;
            background-color: rgba(10, 15, 44, 0.7);
            border: 1px solid var(--cp-border);
            border-radius: 4px; /* Sharper corners */
            padding: 0.75rem 1rem;
            color: var(--cp-text-primary);
            transition: all 0.3s ease;
            box-shadow: inset 0 0 5px rgba(0, 255, 255, 0.2);
        }

        .form-input:focus, .form-textarea:focus, .form-select:focus {
            border-color: var(--cp-accent-magenta);
            box-shadow: 0 0 10px var(--cp-accent-magenta), inset 0 0 8px rgba(255, 0, 255, 0.3);
            outline: none;
        }

        .form-select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%2300ffff' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        
        .panel {
            background-color: var(--cp-panel-bg);
            border: 1px solid var(--cp-border);
            border-radius: 4px;
            backdrop-filter: blur(5px);
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.2), inset 0 0 10px rgba(61, 90, 254, 0.15);
            clip-path: polygon(0 0, 100% 0, 100% calc(100% - 15px), calc(100% - 15px) 100%, 0 100%);
            transition: background-color 0.3s, border-color 0.3s, box-shadow 0.3s, clip-path 0.3s;
        }

        .btn {
            border-radius: 4px;
            transition: all 0.3s ease;
            text-transform: uppercase;
            font-family: 'Orbitron', sans-serif;
            font-weight: 700;
            letter-spacing: 1px;
            clip-path: polygon(0 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%);
        }
        .btn-primary {
            background-color: var(--cp-accent-magenta); color: #fff;
            border: 1px solid var(--cp-accent-magenta);
            box-shadow: 0 0 5px var(--cp-accent-magenta), 0 0 10px var(--cp-accent-magenta);
        }
        .btn-primary:hover {
            box-shadow: 0 0 15px var(--cp-accent-magenta), 0 0 25px var(--cp-accent-magenta);
            transform: translateY(-2px);
        }
        .btn-secondary {
            background-color: transparent; color: var(--cp-accent-cyan);
            border: 1px solid var(--cp-accent-cyan);
            box-shadow: 0 0 5px var(--cp-accent-cyan);
        }
        .btn-secondary:hover {
            background-color: rgba(0, 255, 255, 0.1);
            box-shadow: 0 0 15px var(--cp-accent-cyan);
        }
        .btn-danger {
            background-color: transparent; color: var(--cp-error);
            border: 1px solid var(--cp-error);
        }
        .btn-danger:hover {
            background-color: rgba(255, 51, 102, 0.1);
            box-shadow: 0 0 15px var(--cp-error);
        }
        
        .navbar-desktop {
            background-color: rgba(10, 15, 44, 0.7);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--cp-border);
            box-shadow: 0 0 15px rgba(61, 90, 254, 0.3);
            z-index: 1000;
        }
        .nav-btn {
            background-color: transparent; color: var(--cp-accent-cyan);
            border: 1px solid var(--cp-accent-cyan); border-radius: 4px;
        }
        .nav-btn:hover {
            background-color: rgba(0, 255, 255, 0.1);
            box-shadow: 0 0 10px var(--cp-accent-cyan);
        }

        .modal-overlay {
            position: fixed; inset: 0; background-color: rgba(10, 15, 44, 0.8);
            backdrop-filter: blur(8px); display: flex; align-items: center; justify-content: center;
            padding: 1rem; z-index: 1050;
            opacity: 0; transition: opacity 0.3s ease; pointer-events: none;
        }
        .modal-overlay.show { opacity: 1; pointer-events: auto; }
        .modal-content {
            background-color: var(--cp-panel-bg); border: 1px solid var(--cp-accent-magenta);
            border-radius: 4px; width: 100%; max-width: 500px;
            transform: scale(0.95); transition: transform 0.3s ease;
            box-shadow: 0 0 25px rgba(255, 0, 255, 0.4);
            clip-path: polygon(0 0, calc(100% - 20px) 0, 100% 20px, 100% 100%, 20px 100%, 0 calc(100% - 20px));
        }
        .modal-overlay.show .modal-content { transform: scale(1); }

        .custom-alert-overlay {
            position: fixed; inset: 0; background-color: rgba(10, 15, 44, 0.6);
            backdrop-filter: blur(5px); display: flex; align-items: center; justify-content: center;
            padding: 1rem; z-index: 1060;
            opacity: 0; transition: opacity 0.3s ease; pointer-events: none;
        }
        .custom-alert-overlay.show { opacity: 1; pointer-events: auto; }
        .custom-alert-box {
            background-color: var(--cp-panel-bg); border: 1px solid;
            border-radius: 4px; width: 100%; max-width: 400px; padding: 2rem; text-align: center;
            transform: scale(0.95); transition: transform 0.3s ease, background-color 0.3s, border-color 0.3s;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .custom-alert-overlay.show .custom-alert-box { transform: scale(1); }
        .custom-alert-icon {
            width: 4rem; height: 4rem; border-radius: 50%;
            display: inline-flex; align-items: center; justify-content: center;
            margin-bottom: 1rem; font-size: 2rem; border: 2px solid;
        }
        .custom-alert-icon.success { border-color: var(--cp-success); color: var(--cp-success); box-shadow: 0 0 10px var(--cp-success); }
        .custom-alert-icon.error { border-color: var(--cp-error); color: var(--cp-error); box-shadow: 0 0 10px var(--cp-error); }
        .custom-alert-icon.info { border-color: var(--cp-accent-cyan); color: var(--cp-accent-cyan); box-shadow: 0 0 10px var(--cp-accent-cyan); }
        .custom-alert-box.success { border-color: var(--cp-success); }
        .custom-alert-box.error { border-color: var(--cp-error); }
        .custom-alert-box.info { border-color: var(--cp-accent-cyan); }

        #offcanvas-overlay { z-index: 1030; }
        #offcanvas-menu {
            transition: transform .3s ease-in-out; background-color: var(--cp-bg);
            border-left: 1px solid var(--cp-accent-magenta);
            box-shadow: -10px 0 20px rgba(255, 0, 255, 0.2); z-index: 1040;
        }
        #offcanvas-menu.open { transform: translateX(0); }
        .loading-spinner {
            border: 3px solid rgba(255, 255, 255, 0.2); width: 20px; height: 20px;
            border-radius: 50%; border-left-color: var(--cp-accent-cyan);
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        fieldset:disabled { opacity: 0.4; filter: grayscale(50%); pointer-events: none; }

        /* --- SCANDINAVIAN (LIGHT) THEME --- */
        body.light-theme {
            --sc-bg: #f4f6f8;
            --sc-panel-bg: #ffffff;
            --sc-border: #e2e8f0;
            --sc-text-primary: #2d3748; /* slate-800 */
            --sc-text-secondary: #475569; /* slate-600, Darkened for contrast */
            --sc-accent: #5e81ac; /* Muted Blue */
            --sc-error: #bf616a; /* Muted Red */
            --sc-success: #a3be8c; /* Muted Green */
            
            font-family: 'Exo 2', sans-serif;
            background-color: var(--sc-bg);
            color: var(--sc-text-primary);
            background-image: none;
        }
        body.light-theme::after { opacity: 0; }
        body.light-theme .gradient-text {
            background: none;
            -webkit-text-fill-color: var(--sc-text-primary);
            animation: none;
            text-shadow: none;
        }
        body.light-theme .form-label {
            color: var(--sc-text-secondary);
            text-shadow: none;
        }
        body.light-theme .form-input, body.light-theme .form-textarea, body.light-theme .form-select {
            background-color: #fff;
            border: 1px solid var(--sc-border);
            border-radius: 8px;
            color: var(--sc-text-primary);
            box-shadow: none;
        }
        body.light-theme .form-input:focus, body.light-theme .form-textarea:focus, body.light-theme .form-select:focus {
            border-color: var(--sc-accent);
            box-shadow: 0 0 0 3px rgba(94, 129, 172, 0.2);
        }
        body.light-theme .form-select {
             background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%23718096' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
        }
        body.light-theme .panel {
            background-color: var(--sc-panel-bg);
            border: 1px solid var(--sc-border);
            border-radius: 12px;
            backdrop-filter: none;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            clip-path: none;
        }
        body.light-theme .btn {
            clip-path: none;
            border-radius: 8px;
            box-shadow: 0 1px 2px 0 rgba(0,0,0,0.05);
        }
        body.light-theme .btn-primary {
            background-color: var(--sc-accent); color: #fff;
            border: 1px solid var(--sc-accent);
            box-shadow: 0 1px 2px 0 rgba(0,0,0,0.05);
        }
        body.light-theme .btn-primary:hover {
            background-color: #4c566a;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        }
        body.light-theme .btn-secondary {
            background-color: #fff; color: var(--sc-accent);
            border: 1px solid var(--sc-border);
        }
        body.light-theme .btn-secondary:hover {
            background-color: #f8fafc;
            border-color: #d1d5db;
        }
        body.light-theme .btn-danger {
            background-color: var(--sc-error); color: #fff;
            border: 1px solid var(--sc-error);
        }
        body.light-theme .btn-danger:hover {
            background-color: #d08770;
        }
        body.light-theme .navbar-desktop {
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--sc-border);
            box-shadow: none;
        }
        body.light-theme .nav-btn {
            background-color: #fff; color: var(--sc-text-secondary);
            border: 1px solid var(--sc-border);
            border-radius: 8px;
        }
        body.light-theme .nav-btn:hover {
            background-color: #f8fafc;
            border-color: #d1d5db;
        }
        body.light-theme .modal-overlay {
            background-color: rgba(45, 55, 72, 0.6);
            backdrop-filter: blur(4px);
        }
        body.light-theme .modal-content {
            background-color: var(--sc-panel-bg);
            border: 1px solid var(--sc-border);
            border-radius: 12px;
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
            clip-path: none;
        }
        body.light-theme .modal-content .text-white { color: var(--sc-text-primary) !important; }
        body.light-theme .custom-alert-overlay {
            background-color: rgba(45, 55, 72, 0.4);
        }
        body.light-theme .custom-alert-box {
            background-color: #fff;
            border-radius: 12px;
            color: var(--sc-text-primary);
        }
        body.light-theme .custom-alert-box .text-white, body.light-theme .custom-alert-box .text-slate-300 {
             color: var(--sc-text-primary) !important;
        }
        body.light-theme .custom-alert-icon.success { border-color: var(--sc-success); color: var(--sc-success); box-shadow: none; }
        body.light-theme .custom-alert-icon.error { border-color: var(--sc-error); color: var(--sc-error); box-shadow: none; }
        body.light-theme .custom-alert-icon.info { border-color: var(--sc-accent); color: var(--sc-accent); box-shadow: none; }
        body.light-theme #offcanvas-menu {
            background-color: #fff;
            border-left: 1px solid var(--sc-border);
            box-shadow: -5px 0 15px rgba(0,0,0,0.05);
        }
        body.light-theme #offcanvas-menu .text-slate-300 { color: var(--sc-text-primary); }
        body.light-theme #offcanvas-menu .hover\:bg-slate-700:hover { background-color: #f1f5f9; }

        /* Light Theme Text Contrast Fixes */
        body.light-theme .text-slate-200,
        body.light-theme .text-slate-300,
        body.light-theme .text-slate-400,
        body.light-theme .text-slate-500 {
            color: var(--sc-text-secondary);
        }
        body.light-theme .modal-content h2,
        body.light-theme .modal-content h3,
        body.light-theme #library-list {
            color: var(--sc-text-primary) !important;
        }
        body.light-theme .modal-content .text-blue-200 { color: #1e40af; }
        body.light-theme .modal-content .bg-blue-900\/20 { background-color: #eff6ff; }
        body.light-theme .modal-content .text-yellow-200 { color: #9a3412; }
        body.light-theme .modal-content .bg-yellow-900\/20 { background-color: #fefce8; }
        body.light-theme .modal-content a.text-teal-300 { color: #115e59; }

        /* API Key Selection Buttons */
        .api-select-btn {
            background-color: transparent;
            border: 1px solid var(--cp-border);
            color: var(--cp-text-secondary);
            opacity: 0.6;
        }
        .api-select-btn.selected {
            border-color: var(--cp-accent-magenta);
            color: var(--cp-accent-magenta);
            opacity: 1;
            box-shadow: 0 0 10px var(--cp-accent-magenta);
        }
        body.light-theme .api-select-btn {
            border-color: var(--sc-border);
            background-color: var(--sc-panel-bg);
            color: var(--sc-text-secondary);
            opacity: 0.7;
        }
        body.light-theme .api-select-btn.selected {
            border-color: var(--sc-accent);
            background-color: #fff;
            color: var(--sc-accent);
            opacity: 1;
            box-shadow: 0 0 0 3px rgba(94, 129, 172, 0.2);
        }
        .api-select-btn .check-icon {
            display: none;
        }
        .api-select-btn.selected .check-icon {
            display: inline-block;
        }
    </style>
</head>
<body class="antialiased">

    <!-- Universal Navbar -->
    <header class="navbar-desktop flex sticky top-0">
        <div class="container mx-auto px-4">
            <div class="flex items-center justify-between h-16">
                <!-- Left: Logo -->
                <div class="flex-shrink-0">
                    <a href="#" class="text-xl font-bold gradient-text flex items-center gap-2">
                        <i class="fas fa-robot"></i>
                        <span id="nav-title" class="hidden sm:inline">Promptique Generator</span>
                    </a>
                </div>

                <!-- Right: Actions -->
                <div class="flex items-center gap-2">
                    <button id="language-toggle" class="nav-btn px-3 py-2 text-sm transition-colors flex items-center">
                        <i class="fas fa-language"></i>
                        <span class="hidden md:inline ml-2" id="lang-btn-text">ID</span>
                    </button>
                    <button id="riwayat-btn" class="nav-btn px-3 py-2 text-sm transition-colors flex items-center">
                        <i class="fas fa-folder-open"></i>
                        <span class="hidden md:inline ml-2" id="history-btn-text">Riwayat</span>
                    </button>
                    <button id="api-key-modal-btn" class="nav-btn px-3 py-2 text-sm transition-colors flex items-center">
                        <i class="fas fa-key"></i>
                        <span class="hidden md:inline ml-2" id="api-btn-text">API Key</span>
                    </button>
                    <!-- Desktop-only buttons -->
                    <div class="hidden md:flex items-center gap-2">
                         <button id="logout-btn" class="nav-btn h-10 w-10 flex items-center justify-center transition-colors hidden" title="Kunci Ulang">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                        <button id="theme-toggle" class="nav-btn h-10 w-10 flex items-center justify-center transition-colors" title="Ganti Tema">
                            <i class="fas fa-sun"></i>
                        </button>
                    </div>
                    <!-- Mobile Menu Button -->
                    <div class="md:hidden">
                        <button id="menu-toggle" class="nav-btn h-10 w-10 flex items-center justify-center">
                            <i class="fas fa-bars"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Off-canvas Menu -->
    <div id="offcanvas-overlay" class="fixed inset-0 bg-black/50 hidden"></div>
    <div id="offcanvas-menu" class="fixed top-0 right-0 h-full w-64 p-6 transform translate-x-full">
        <h2 class="text-lg font-bold text-slate-300 mb-6">Menu</h2>
        <nav class="flex flex-col gap-4">
             <button id="mobile-logout-btn" class="w-full text-left p-3 rounded-lg hover:bg-slate-700 text-slate-300 transition-colors hidden" title="Kunci Ulang">
                <i class="fas fa-sign-out-alt w-6"></i>
                <span id="mobile-logout-text">Kunci Ulang</span>
            </button>
            <button id="mobile-theme-toggle" class="w-full text-left p-3 rounded-lg hover:bg-slate-700 text-slate-300 transition-colors" title="Ganti Tema">
                <i class="fas fa-sun w-6"></i>
                <span id="mobile-theme-text">Ganti Tema</span>
           </button>
        </nav>
    </div>


    <main class="container mx-auto max-w-4xl px-4 py-8 sm:py-12">

        <!-- Login Section -->
        <section id="password-section" class="panel p-6 sm:p-8 mb-8" style="display: none;">
            <h3 class="text-2xl font-bold text-center gradient-text mb-4" id="login-title">Akses Terminal</h3>
            <div class="max-w-sm mx-auto">
                <label for="appPasswordInput" class="form-label" id="password-label">Kode Akses</label>
                <div class="flex flex-col sm:flex-row gap-2 mb-3">
                    <div class="relative flex-grow">
                        <input type="password" id="appPasswordInput" class="form-input w-full pr-10 text-center sm:text-left" placeholder="MASUKKAN KODE...">
                        <button type="button" id="togglePasswordBtn" class="absolute inset-y-0 right-0 px-3 flex items-center text-slate-400 hover:text-slate-200" aria-label="Toggle password visibility">
                            <i class="fas fa-eye" id="password-eye-icon"></i>
                        </button>
                    </div>
                    <button id="unlockBtn" class="w-full sm:w-auto btn btn-primary py-2 px-6 flex-shrink-0" id="login-button">Masuk</button>
                </div>
                 <a id="getPassBtn" href="https://lynk.id/aiyradesign/e39qnxl23nl3" target="_blank" class="block w-full btn btn-secondary py-2 px-6 text-center">
                    <i class="fas fa-shopping-cart mr-2"></i><span id="get-password-btn-text">Dapatkan Kode Akses</span>
                </a>
            </div>
        </section>

        <!-- Generator Fieldset -->
        <fieldset id="generator-fieldset" disabled>
            <!-- Hero Section -->
            <section class="text-center mb-12">
                <h1 id="hero-title" class="text-4xl sm:text-6xl font-extrabold tracking-tight gradient-text">
                    Action Figure Prompt Generator
                </h1>
                <p id="hero-subtitle" class="mt-4 text-lg text-slate-400 max-w-2xl mx-auto">
                    // Generate Prompt AI untuk Action Figure dengan cepat //
                </p>
            </section>

            <!-- Content Area -->
            <div class="space-y-8">
                <!-- AI Assistant Card -->
                <section class="panel p-6 sm:p-8">
                    <h3 class="text-xl font-bold mb-6 text-center gradient-text">
                        <i class="fas fa-magic-wand-sparkles mr-2"></i> <span id="ai-assistant-title">AI Assistant</span>
                    </h3>
                    <div class="space-y-6">
                        <div>
                            <label for="ceritaKarakter" class="form-label"><i class="fas fa-feather-alt w-5 mr-1"></i><span id="story-label">Ceritakan singkat tentang karakter Anda</span></label>
                            <textarea id="ceritaKarakter" rows="4" class="form-textarea" placeholder="Contoh: Seorang ksatria dengan zirah perak yang menjaga kastil kuno..."></textarea>
                        </div>
                        <div>
                            <label for="nuansaTemaAi" class="form-label"><i class="fas fa-palette w-5 mr-1"></i><span id="theme-label">Pilih Nuansa Tema</span></label>
                            <select id="nuansaTemaAi" class="form-select">
                                <option value="KlasikStudio" selected>Klasik Studio</option>
                                <option value="Cyberpunk">Cyberpunk</option>
                                <option value="FantasiMistis">Fantasi Mistis</option>
                                <option value="PascaApokaliptik">Pasca-Apokaliptik</option>
                                <option value="Steampunk">Steampunk</option>
                                <option value="Kosmik">Kosmik Fiksi Ilmiah</option>
                                <option value="HororGotik">Horor Gotik</option>
                                <option value="BioLuminescent">Hutan Bio-Luminescent</option>
                                <option value="MesirKuno">Mesir Kuno Mistis</option>
                                <option value="KerajaanLangit">Kerajaan di Atas Awan</option>
                                <option value="PasirPantaiTropis">Pasir Pantai Tropis</option>
                                <option value="InteriorDojoJepang">Interior Dojo Jepang</option>
                                <option value="LaboratoriumSciFi">Laboratorium Sci-Fi</option>
                                <option value="DekKapalBajakLaut">Dek Kapal Bajak Laut</option>
                                <option value="TamanBungaSakura">Taman Bunga Sakura</option>
                                <option value="ReruntuhanHutanKuno">Reruntuhan Hutan Kuno</option>
                                <option value="KotaBawahAir">Kota Bawah Air</option>
                                <option value="ArenaGladiator">Arena Gladiator</option>
                                <option value="IstanaEsArktik">Istana Es Arktik</option>
                                <option value="DuniaPermen">Dunia Permen</option>
                            </select>
                        </div>
                        <div class="text-center">
                            <button id="aiBtn" class="w-full sm:w-auto inline-flex items-center justify-center px-8 py-3 btn btn-primary">
                                <span id="aiBtnTextContainer" class="inline-flex items-center">
                                    <i class="fas fa-lightbulb mr-3"></i>
                                    <span id="aiBtnText">Sesuaikan dengan AI</span>
                                </span>
                                <span id="aiBtnLoadingContainer" class="hidden items-center">
                                    <div class="loading-spinner"></div>
                                    <span id="aiBtnLoadingText" class="ml-3"></span>
                                </span>
                            </button>
                        </div>
                    </div>
                </section>

                <!-- Detail Manual Card -->
                <section class="panel p-6 sm:p-8">
                    <h3 class="text-xl font-bold mb-6 text-center gradient-text">
                        <i class="fas fa-pencil-alt mr-2"></i> <span id="manual-detail-title">Detail Manual</span>
                    </h3>
                    <form id="promptForm" class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div><label for="namaKarakter" class="form-label" id="name-label">Nama Karakter</label><input type="text" id="namaKarakter" class="form-input" placeholder="Contoh: Arthur"></div>
                            <div><label for="gender" class="form-label" id="gender-label">Gender / Jenis</label><select id="gender" class="form-select"><option value="" selected>Pilih...</option><option value="Pria">Pria</option><option value="Wanita">Wanita</option><option value="Hewan">Hewan</option><option value="Non-biner">Non-biner</option></select></div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div><label for="deskripsiKarakter" class="form-label" id="char-desc-label">Deskripsi Karakter</label><textarea id="deskripsiKarakter" rows="3" class="form-textarea" placeholder="Rambut pirang, mata biru, wajah tegas..."></textarea></div>
                            <div><label for="deskripsiKostum" class="form-label" id="costume-desc-label">Deskripsi Kostum</label><textarea id="deskripsiKostum" rows="3" class="form-textarea" placeholder="Zirah perak berkilauan dengan jubah merah..."></textarea></div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div><label for="senjataAtauBenda" class="form-label" id="weapon-label">Senjata / Benda</label><textarea id="senjataAtauBenda" rows="3" class="form-textarea" placeholder="Pedang Excalibur yang tertancap di batu..."></textarea></div>
                            <div><label for="deskripsiPose" class="form-label" id="pose-label">Pose dan Ekspresi</label><textarea id="deskripsiPose" rows="3" class="form-textarea" placeholder="Berdiri gagah dengan tangan di gagang pedang..."></textarea></div>
                        </div>
                         <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div><label for="astralMagis" class="form-label" id="creature-label">Hewan/Makhluk</label><textarea id="astralMagis" rows="3" class="form-textarea" placeholder="Seekor griffin emas di sampingnya..."></textarea></div>
                            <div><label for="lingkungan" class="form-label" id="base-detail-label">Detail Spesifik Alas</label><textarea id="lingkungan" rows="3" class="form-textarea" placeholder="Reruntuhan kastil dengan pilar-pilar batu..."></textarea></div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div><label for="bentukAlas" class="form-label" id="base-shape-label">Bentuk Alas</label><select id="bentukAlas" class="form-select"><option value="Bulat" selected>Bulat</option><option value="Persegi">Persegi</option></select></div>
                            <div>
                                <label for="gayaVisual" class="form-label" id="visual-style-label">Gaya Visual</label>
                                <select id="gayaVisual" class="form-select">
                                    <option value="4D Hyper Realism" selected>4D Hyper Realism</option>
                                    <option value="3D Chibi Stylized">3D Chibi Stylized</option>
                                    <option value="3D Vector Ilustrasi">3D Vector Ilustrasi</option>
                                    <option value="3D Lego Modern">3D Lego Modern</option>
                                    <option value="3D Brick Block Toy">3D Brick Block Toy</option>
                                </select>
                            </div>
                        </div>
                        <div><label for="generateBy" class="form-label" id="generate-by-label">Generate By</label><input type="text" id="generateBy" class="form-input" value="PROMPT BY AIYRA DESIGN"></div>
                        
                        <!-- Actions Buttons -->
                        <div class="pt-6 border-t border-slate-700">
                            <div class="grid grid-cols-3 gap-3">
                                <div class="col-span-1">
                                    <button type="button" id="resetBtn" class="w-full h-full px-4 py-3 btn btn-danger flex items-center justify-center">
                                        <i class="fas fa-rotate-left"></i>
                                        <span id="reset-btn-text" class="hidden sm:inline ml-2">Reset</span>
                                    </button>
                                </div>
                                <div class="col-span-2">
                                    <button type="button" id="generateBtn" class="w-full h-full btn btn-primary py-3 px-8 flex items-center justify-center">
                                        <i class="fas fa-cogs mr-2"></i>
                                        <span id="generate-btn-text">Hasilkan Prompt</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </section>

                <!-- Result Section -->
                <div id="result-section" class="mt-10 pt-6 border-t border-slate-700 space-y-6" style="display: none;">
                    <div>
                        <h3 class="text-lg font-semibold mb-2 text-slate-300" id="result-title-id">Prompt Final (Bahasa Indonesia):</h3>
                        <div class="relative">
                            <textarea id="outputPrompt" rows="12" class="form-textarea font-mono text-sm" readonly></textarea>
                            <button id="copyBtn" class="absolute top-3 right-3 btn btn-secondary text-sm flex items-center justify-center px-3 py-2">
                                <i class="fas fa-copy mr-2"></i><span id="copy-text-id">Salin</span>
                            </button>
                        </div>
                    </div>
                    <div id="translate-section" class="text-center" style="display: none;">
                        <button type="button" id="translateBtn" class="w-full sm:w-auto inline-flex items-center justify-center px-8 py-3 btn btn-secondary">
                            <span id="translateBtnTextContainer"><i class="fas fa-language mr-3"></i><span id="translateBtnText">Terjemahkan ke Bahasa Inggris</span></span>
                            <div id="translateBtnSpinner" class="loading-spinner ml-3 hidden"></div>
                        </button>
                    </div>
                    <div id="english-prompt-section" style="display: none;">
                        <h3 class="text-lg font-semibold mb-2 text-slate-300" id="result-title-en">Final Prompt (English):</h3>
                        <div class="relative">
                            <textarea id="outputPromptEn" rows="12" class="form-textarea font-mono text-sm" readonly></textarea>
                            <button id="copyBtnEn" class="absolute top-3 right-3 btn btn-secondary text-sm flex items-center justify-center px-3 py-2">
                                <i class="fas fa-copy mr-2"></i><span id="copy-text-en">Copy</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </fieldset>
    </main>
    
    <!-- Modals -->
    <div id="apiKeyModal" class="modal-overlay">
        <div class="modal-content p-6 max-h-[90vh] overflow-y-auto">
            <div class="modal-header flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-white"><i class="fas fa-key mr-2"></i><span id="api-modal-title">Pengaturan API Key</span></h2>
                <button class="close-modal-btn text-slate-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div class="space-y-4">
                <p class="text-sm text-slate-400" id="api-info-text">Pilih sumber Kunci API yang ingin Anda gunakan.</p>
                
                <!-- API Key Selection Buttons -->
                <div class="space-y-3">
                    <button id="select-system-api-btn" class="w-full p-4 rounded-lg flex justify-between items-center transition-all duration-200 api-select-btn">
                        <span>
                            <span id="api-select-system-title" class="font-bold block text-left">Gunakan API Sistem</span>
                            <span id="api-select-system-subtitle" class="text-xs font-normal block text-left">Menggunakan kunci bawaan (ada batasan)</span>
                        </span>
                        <i class="fas fa-check-circle text-xl check-icon"></i>
                    </button>
                    <button id="select-your-api-btn" class="w-full p-4 rounded-lg flex justify-between items-center transition-all duration-200 api-select-btn">
                        <span>
                            <span id="api-select-your-title" class="font-bold block text-left">Gunakan API Pribadi Anda</span>
                            <span id="api-select-your-subtitle" class="text-xs font-normal block text-left">Masukkan kunci API Gemini Anda sendiri</span>
                        </span>
                        <i class="fas fa-check-circle text-xl check-icon"></i>
                    </button>
                </div>

                <!-- System API Content -->
                <div id="system-api-content" class="hidden p-4 bg-blue-900/20 border border-blue-500/30 rounded-lg space-y-3">
                    <p class="text-sm text-blue-200" id="system-api-note"><strong class="font-semibold">Catatan:</strong> Kunci ini digunakan bersama dan mungkin memiliki batasan. Untuk pengalaman terbaik, kami sangat menyarankan menggunakan Kunci API Anda sendiri.</p>
                </div>

                <!-- User API Content -->
                <div id="your-api-content" class="hidden space-y-4">
                     <h3 class="font-semibold text-white" id="your-api-guide-title">Cara mendapatkan API Key:</h3>
                    <!-- Desktop Guide -->
                    <div class="hidden md:block">
                        <ol class="list-decimal list-inside text-slate-400 text-sm space-y-1">
                            <li>Kunjungi <a href="https://aistudio.google.com/" target="_blank" class="text-teal-300 hover:underline">Google AI Studio</a>.</li>
                            <li>Masuk dengan akun Google Anda.</li>
                            <li>Klik tombol <strong class="text-slate-200">Get API key</strong> yang ada di menu sebelah kiri.</li>
                            <li>Pilih atau buat proyek, lalu klik <strong class="text-slate-200">Create API key</strong>.</li>
                        </ol>
                    </div>
                    <!-- Mobile Guide -->
                    <div class="md:hidden">
                        <ol class="list-decimal list-inside text-slate-400 text-sm space-y-1">
                            <li>Kunjungi <a href="https://aistudio.google.com/" target="_blank" class="text-teal-300 hover:underline">Google AI Studio</a>.</li>
                            <li>Masuk dengan akun Google Anda.</li>
                            <li>Ketuk ikon menu (<strong><i class="fas fa-bars"></i></strong>) di pojok kiri atas.</li>
                            <li>Pilih menu <strong class="text-slate-200">Get API key</strong>.</li>
                            <li>Pilih atau buat proyek, lalu ketuk <strong class="text-slate-200">Create API key</strong>.</li>
                        </ol>
                    </div>
                    <div>
                        <label for="api-key-input-modal" class="form-label" id="api-key-label">Your Gemini API Key</label>
                        <div class="flex items-center gap-2">
                            <div class="relative flex-grow">
                                <input type="password" id="api-key-input-modal" class="form-input w-full pr-10" placeholder="Paste your API key here...">
                                <button type="button" id="toggleApiKeyBtn" class="absolute inset-y-0 right-0 px-3 flex items-center text-slate-400 hover:text-slate-200" aria-label="Toggle API Key visibility">
                                    <i class="fas fa-eye" id="apiKey-eye-icon"></i>
                                </button>
                            </div>
                            <button type="button" id="delete-api-key-btn" class="p-3 btn btn-danger flex-shrink-0" title="Hapus API Key">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-end gap-3 pt-4">
                    <button class="close-modal-btn px-4 py-2 btn btn-secondary" id="cancel-api-btn">Batal</button>
                    <button id="save-api-choice-btn" class="px-6 py-2 btn btn-primary">Simpan</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="libraryModal" class="modal-overlay">
        <div class="modal-content p-6">
            <div class="modal-header flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-white"><i class="fas fa-folder-open mr-2"></i><span id="history-modal-title">Riwayat Cerita</span></h2>
                <button class="close-modal-btn text-slate-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div id="library-list" class="text-slate-300 space-y-2 max-h-[60vh] overflow-y-auto"></div>
            <div class="mt-6 flex justify-end gap-3">
                <button id="clear-library-btn" class="px-4 py-2 btn btn-danger" id="clear-history-btn-text">Bersihkan Riwayat</button>
                <button class="close-modal-btn px-4 py-2 btn btn-secondary" id="close-btn-text">Tutup</button>
            </div>
        </div>
    </div>
    
    <div id="confirmation-modal" class="modal-overlay">
        <div class="modal-content p-8 text-center max-w-sm">
            <h3 id="confirmation-title" class="text-lg font-bold text-white mb-2"></h3>
            <p id="confirmation-message" class="text-slate-300 mb-6"></p>
            <div class="flex justify-center gap-4">
                <button id="confirm-no-btn" class="px-6 py-2 btn btn-secondary"></button>
                <button id="confirm-yes-btn" class="px-6 py-2 btn btn-danger"></button>
            </div>
        </div>
    </div>

    <!-- Custom Alert Container -->
    <div id="custom-alert-overlay" class="custom-alert-overlay">
        <div id="custom-alert-box" class="custom-alert-box">
            <div id="custom-alert-icon" class="custom-alert-icon"></div>
            <h4 id="custom-alert-title" class="font-bold text-lg mb-1 text-white"></h4>
            <p id="custom-alert-message" class="text-sm text-slate-300"></p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            (function () {
                const isAppleDevice = /Mac|iPhone|iPad|iPod/i.test(navigator.userAgent);
                const baseThreshold = 350;
                const appleThreshold = 800; // toleransi lebih besar untuk Apple agar tidak false positive
                const threshold = isAppleDevice ? appleThreshold : baseThreshold;
            
                const showBlockedPage = () => {
                    document.body.innerHTML = `
                        <div id="cyberpunk-access-denied-wrapper" style="height: 100vh;">
                            <style>
                                /* --- CSS Variables for easy theming --- */
                                :root {
                                    --background-color: #010409;
                                    --primary-neon: #ff00c1;
                                    --secondary-neon: #00e5ff;
                                    --text-color: #e6f1ff;
                                    --scanline-color: rgba(0, 229, 255, 0.1);
                                    --glitch-primary: #ff00c1;
                                    --glitch-secondary: #00e5ff;
                                }
            
                                /* --- Base Styles for the Wrapper DIV --- */
                                #cyberpunk-access-denied-wrapper {
                                    background-color: var(--background-color);
                                    color: var(--text-color);
                                    font-family: 'Share Tech Mono', monospace;
                                    display: flex;
                                    justify-content: center;
                                    align-items: center;
                                    height: 100%; /* Atur ke 100vh jika ingin memenuhi seluruh layar */
                                    width: 100%;
                                    margin: 0;
                                    overflow: hidden;
                                    text-align: center;
                                    padding: 2rem;
                                    box-sizing: border-box;
                                    position: relative; /* Diperlukan untuk pseudo-element ::after */
                                    /* Add a subtle grid pattern */
                                    background-image: 
                                        linear-gradient(rgba(255, 255, 255, 0.05) 1px, transparent 1px),
                                        linear-gradient(90deg, rgba(255, 255, 255, 0.05) 1px, transparent 1px);
                                    background-size: 30px 30px;
                                }
            
                                /* --- Scanline Animation --- */
                                #cyberpunk-access-denied-wrapper::after {
                                    content: ' ';
                                    display: block;
                                    position: absolute;
                                    top: 0;
                                    left: 0;
                                    width: 100%;
                                    height: 100%;
                                    background: repeating-linear-gradient(
                                        0deg,
                                        var(--scanline-color),
                                        var(--scanline-color) 1px,
                                        transparent 1px,
                                        transparent 4px
                                    );
                                    animation: scanline 10s linear infinite;
                                    pointer-events: none;
                                    opacity: 0.5;
                                }
            
                                @keyframes scanline {
                                    0% { background-position: 0 0; }
                                    100% { background-position: 0 100vh; }
                                }
            
                                /* --- Main Content Container --- */
                                #cyberpunk-access-denied-wrapper .container {
                                    position: relative;
                                    z-index: 1;
                                    border: 2px solid var(--secondary-neon);
                                    padding: 2rem 3rem;
                                    background: rgba(1, 4, 9, 0.8);
                                    box-shadow: 
                                        0 0 10px var(--secondary-neon),
                                        inset 0 0 10px var(--secondary-neon);
                                    border-radius: 8px;
                                    max-width: 700px;
                                }
            
                                /* --- Glitch Effect on Heading --- */
                                #cyberpunk-access-denied-wrapper .glitch-container {
                                    position: relative;
                                }
            
                                #cyberpunk-access-denied-wrapper .glitch {
                                    font-family: 'Orbitron', sans-serif;
                                    font-size: clamp(2rem, 8vw, 4rem);
                                    font-weight: 700;
                                    text-transform: uppercase;
                                    position: relative;
                                    color: var(--text-color);
                                    text-shadow: 0 0 5px var(--primary-neon), 0 0 10px var(--primary-neon);
                                    animation: glitch-skew 1s infinite linear alternate-reverse;
                                }
            
                                #cyberpunk-access-denied-wrapper .glitch::before,
                                #cyberpunk-access-denied-wrapper .glitch::after {
                                    content: attr(data-text);
                                    position: absolute;
                                    top: 0;
                                    left: 0;
                                    width: 100%;
                                    height: 100%;
                                    background: transparent; /* Dibuat transparan agar tidak menutupi teks utama */
                                    overflow: hidden;
                                }
            
                                #cyberpunk-access-denied-wrapper .glitch::before {
                                    left: 2px;
                                    text-shadow: -2px 0 var(--glitch-primary);
                                    animation: glitch-anim-1 2s infinite linear alternate-reverse;
                                }
            
                                #cyberpunk-access-denied-wrapper .glitch::after {
                                    left: -2px;
                                    text-shadow: -2px 0 var(--glitch-secondary), 2px 2px var(--glitch-primary);
                                    animation: glitch-anim-2 3s infinite linear alternate-reverse;
                                }
            
                                /* --- Glitch Keyframes --- */
                                @keyframes glitch-anim-1 {
                                    0% { clip-path: inset(5% 0 90% 0); }
                                    20% { clip-path: inset(70% 0 15% 0); }
                                    40% { clip-path: inset(45% 0 45% 0); }
                                    60% { clip-path: inset(10% 0 85% 0); }
                                    80% { clip-path: inset(90% 0 5% 0); }
                                    100% { clip-path: inset(60% 0 30% 0); }
                                }
            
                                @keyframes glitch-anim-2 {
                                    0% { clip-path: inset(80% 0 10% 0); }
                                    25% { clip-path: inset(5% 0 70% 0); }
                                    50% { clip-path: inset(75% 0 5% 0); }
                                    75% { clip-path: inset(40% 0 50% 0); }
                                    100% { clip-path: inset(95% 0 2% 0); }
                                }
                                
                                @keyframes glitch-skew {
                                0% { transform: skew(0deg); }
                                5% { transform: skew(1deg); }
                                10% { transform: skew(-0.5deg); }
                                100% { transform: skew(0deg); }
                                }
            
                                /* --- Paragraph and Message Styles --- */
                                #cyberpunk-access-denied-wrapper .message {
                                    font-size: clamp(1rem, 2.5vw, 1.2rem);
                                    margin-top: 1.5rem;
                                    color: var(--text-color);
                                    line-height: 1.6;
                                    text-shadow: 0 0 3px var(--secondary-neon);
                                }
                                
                                #cyberpunk-access-denied-wrapper .message span {
                                    color: var(--primary-neon);
                                    font-weight: bold;
                                }
            
                                /* --- Corner Brackets for decoration --- */
                                #cyberpunk-access-denied-wrapper .corner {
                                    position: absolute;
                                    width: 20px;
                                    height: 20px;
                                    border-color: var(--primary-neon);
                                    border-style: solid;
                                    box-shadow: 0 0 5px var(--primary-neon);
                                }
                                #cyberpunk-access-denied-wrapper .top-left { top: -5px; left: -5px; border-width: 3px 0 0 3px; }
                                #cyberpunk-access-denied-wrapper .top-right { top: -5px; right: -5px; border-width: 3px 3px 0 0; }
                                #cyberpunk-access-denied-wrapper .bottom-left { bottom: -5px; left: -5px; border-width: 0 0 3px 3px; }
                                #cyberpunk-access-denied-wrapper .bottom-right { bottom: -5px; right: -5px; border-width: 0 3px 3px 0; }
                            </style>
            
                            <div class="container">
                                <!-- Decorative corners -->
                                <div class="corner top-left"></div>
                                <div class="corner top-right"></div>
                                <div class="corner bottom-left"></div>
                                <div class="corner bottom-right"></div>
            
                                <!-- Main content -->
                                <div class="glitch-container">
                                    <h1 class="glitch" data-text="AKSES DITOLAK">AKSES DITOLAK</h1>
                                </div>
                                <p class="message">
                                    ANOMALI TERDETEKSI: <span>[DEV_TOOLS_INTERFACE::ACTIVE]</span>.
                                    <br>
                                    Protokol keamanan sistem telah memutus koneksi untuk melindungi integritas data. Nonaktifkan antarmuka developer dan mulai ulang sesi.
                                </p>
                            </div>
                        </div>
                    `; // sama seperti sebelumnya
                };
            
                // Deteksi tambahan: console.log timing trick
                let devtoolsDetected = false;
                const detectConsoleOpen = () => {
                    const start = performance.now();
                    console.log('%c', 'color:transparent;');
                    const time = performance.now() - start;
                    if (time > 100) {
                        devtoolsDetected = true;
                        showBlockedPage();
                    }
                };
            
                const devToolCheck = () => {
                    const widthDiff = Math.abs(window.outerWidth - window.innerWidth);
                    const heightDiff = Math.abs(window.outerHeight - window.innerHeight);
            
                    const isDevToolsBySize = (widthDiff > threshold || heightDiff > threshold) &&
                                             window.outerHeight > 0 && window.innerHeight > 0;
            
                    if (isDevToolsBySize) {
                        // untuk Apple, jangan langsung blokir, cek lagi pakai metode console.log
                        if (isAppleDevice) {
                            detectConsoleOpen();
                        } else {
                            showBlockedPage();
                        }
                    }
                };
            
                // Apple device dicek lebih jarang
                const checkInterval = isAppleDevice ? 8000 : 2000;
                setInterval(devToolCheck, checkInterval);
            
                document.addEventListener('contextmenu', (event) => {
                    const target = event.target;
                    if (!['INPUT', 'TEXTAREA'].includes(target.tagName) && !target.isContentEditable) {
                        event.preventDefault();
                    }
                });
            
                document.addEventListener('keydown', (e) => {
                    const key = e.key.toLowerCase();
                    if (
                        (e.ctrlKey && e.shiftKey && key === 'i') ||
                        (e.ctrlKey && e.shiftKey && key === 'j') ||
                        (e.ctrlKey && key === 'u') ||
                        (e.metaKey && key === 'u') ||
                        (key === 'f12')
                    ) {
                        e.preventDefault();
                        e.stopPropagation();
                        showBlockedPage();
                    }
                });
            
                document.addEventListener('dragstart', e => e.preventDefault());
                document.addEventListener('selectstart', e => e.preventDefault());
            })();

            // --- Global variable for alert timeout ---
            let alertTimeout;

            // --- Get All DOM Elements ---
            const body = document.body;
            const passwordSection = document.getElementById('password-section');
            const generatorFieldset = document.getElementById('generator-fieldset');
            const unlockBtn = document.getElementById('unlockBtn');
            const appPasswordInput = document.getElementById('appPasswordInput');
            const togglePasswordBtn = document.getElementById('togglePasswordBtn');
            const passwordEyeIcon = document.getElementById('password-eye-icon');
            const logoutBtn = document.getElementById('logout-btn');
            const mobileLogoutBtn = document.getElementById('mobile-logout-btn');
            
            const apiKeyModal = document.getElementById('apiKeyModal');
            const apiKeyModalBtn = document.getElementById('api-key-modal-btn');
            const libraryModal = document.getElementById('libraryModal');
            const riwayatBtn = document.getElementById('riwayat-btn');
            const libraryList = document.getElementById('library-list');
            const clearLibraryBtn = document.getElementById('clear-library-btn');
            
            const resultSection = document.getElementById('result-section');
            const outputPromptEl = document.getElementById('outputPrompt');
            const outputPromptEnEl = document.getElementById('outputPromptEn');
            const aiBtn = document.getElementById('aiBtn');
            const generateBtn = document.getElementById('generateBtn');
            const resetBtn = document.getElementById('resetBtn');
            const copyBtn = document.getElementById('copyBtn');
            const copyBtnEn = document.getElementById('copyBtnEn');
            const toggleApiKeyBtn = document.getElementById('toggleApiKeyBtn');
            const apiKeyEyeIcon = document.getElementById('apiKey-eye-icon');
            const translateSection = document.getElementById('translate-section');
            const translateBtn = document.getElementById('translateBtn');
            const englishPromptSection = document.getElementById('english-prompt-section');
            const saveApiChoiceBtn = document.getElementById('save-api-choice-btn');
            const apiKeyInput = document.getElementById('api-key-input-modal');
            const deleteApiKeyBtn = document.getElementById('delete-api-key-btn');
            const promptForm = document.getElementById('promptForm');
            const ceritaKarakterEl = document.getElementById('ceritaKarakter');
            const languageToggle = document.getElementById('language-toggle');
            
            const themeToggle = document.getElementById('theme-toggle');
            const mobileThemeToggle = document.getElementById('mobile-theme-toggle');
            const mobileThemeText = document.getElementById('mobile-theme-text');
            
            const alertOverlay = document.getElementById('custom-alert-overlay');
            const alertBox = document.getElementById('custom-alert-box');
            const alertIcon = document.getElementById('custom-alert-icon');
            const alertTitle = document.getElementById('custom-alert-title');
            const alertMessage = document.getElementById('custom-alert-message');

            const confirmationModal = document.getElementById('confirmation-modal');
            const confirmationTitle = document.getElementById('confirmation-title');
            const confirmationMessage = document.getElementById('confirmation-message');
            let confirmYesBtn = document.getElementById('confirm-yes-btn');
            const confirmNoBtn = document.getElementById('confirm-no-btn');

            const selectSystemApiBtn = document.getElementById('select-system-api-btn');
            const selectYourApiBtn = document.getElementById('select-your-api-btn');
            const systemApiContent = document.getElementById('system-api-content');
            const yourApiContent = document.getElementById('your-api-content');

            const menuToggle = document.getElementById('menu-toggle');
            const offcanvasMenu = document.getElementById('offcanvas-menu');
            const offcanvasOverlay = document.getElementById('offcanvas-overlay');

            const allModals = [apiKeyModal, libraryModal, confirmationModal];

            // --- Function Declarations --- 
            const openModal = (modalElement) => { modalElement.classList.add('show'); }
            const closeModal = (modalElement) => { modalElement.classList.remove('show'); }
            
            const showAlert = (type, title, message) => {
                clearTimeout(alertTimeout); 
                alertIcon.className = 'custom-alert-icon'; 
                alertBox.className = 'custom-alert-box';
                alertIcon.classList.add(type);
                alertBox.classList.add(type);
                
                if (type === 'success') {
                    alertIcon.innerHTML = `<i class="fas fa-check"></i>`;
                } else if (type === 'info') {
                    alertIcon.innerHTML = `<i class="fas fa-info-circle"></i>`;
                } else { 
                    alertIcon.innerHTML = `<i class="fas fa-times"></i>`;
                }
                alertTitle.textContent = title;
                alertMessage.textContent = message;
                alertOverlay.classList.add('show');
                alertTimeout = setTimeout(() => {
                    alertOverlay.classList.remove('show');
                }, 3000); 
            }

            const showConfirmation = (title, message, yesText, noText, onConfirm) => {
                confirmationTitle.textContent = title;
                confirmationMessage.textContent = message;
                
                const newYesBtn = confirmYesBtn.cloneNode(true);
                confirmYesBtn.parentNode.replaceChild(newYesBtn, confirmYesBtn);
                confirmYesBtn = newYesBtn; 
                
                confirmYesBtn.textContent = yesText;
                confirmNoBtn.textContent = noText;

                confirmYesBtn.onclick = () => {
                    onConfirm();
                    closeModal(confirmationModal);
                };
                
                confirmNoBtn.onclick = () => closeModal(confirmationModal);
                openModal(confirmationModal);
            };

            const fetchAI = async (apiKey, payload) => {
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("API Error:", errorData);
                    let errorMessage = errorData.error?.message || 'An unknown error occurred with the AI response.';
                    if (errorMessage.includes('API key not valid')) {
                       errorMessage = 'The provided API key is not valid. Please check it and try again.';
                    } else if (response.status === 429) {
                        errorMessage = 'The model is currently overloaded. Please try again in a few moments.';
                    }
                    throw new Error(errorMessage);
                }
                
                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 && result.candidates[0].content?.parts[0]?.text) {
                    return result.candidates[0].content.parts[0].text;
                } else {
                    console.error("Invalid response structure:", result);
                    throw new Error('Failed to process data from AI due to an invalid format.');
                }
            }
            
            const performApiCall = async (payload) => {
                const apiSource = localStorage.getItem('apiSource') || 'system';
                const defaultApiKeys = ["AIzaSyDEOYJWSN8UhgjGWGo1oYXTA3bcgtPVTLM".split('').reverse().join('')];
                const defaultApiKey = defaultApiKeys[0].split('').reverse().join('');
                const userApiKey = localStorage.getItem('geminiApiKey');

                let apiKeyToUse = (apiSource === 'personal' && userApiKey) ? userApiKey : defaultApiKey;
                
                try {
                    return await fetchAI(apiKeyToUse, payload);
                } catch (error) {
                    console.warn(`API call failed with ${apiSource} key. Error:`, error.message);
                    if (apiSource === 'system' && userApiKey) {
                        showAlert('info', 'System API Failed', 'Attempting to use your personal API key...');
                        try {
                            return await fetchAI(userApiKey, payload);
                        } catch (userKeyError) {
                             throw new Error(`Your personal API key also failed. Error: ${userKeyError.message}`);
                        }
                    }
                    throw new Error(`API call failed. ${error.message}. Consider using your own API key via settings.`);
                }
            }

            const updateApiSelectionUI = (selection) => {
                if (selection === 'system') {
                    selectSystemApiBtn.classList.add('selected');
                    selectYourApiBtn.classList.remove('selected');
                    systemApiContent.style.display = 'block';
                    yourApiContent.style.display = 'none';
                } else { // personal
                    selectSystemApiBtn.classList.remove('selected');
                    selectYourApiBtn.classList.add('selected');
                    systemApiContent.style.display = 'none';
                    yourApiContent.style.display = 'block';
                }
            };

            const getHistory = () => JSON.parse(localStorage.getItem('storyHistory')) || [];
            const saveStoryToHistory = (story) => {
                if (!story || story.trim() === '') return;
                let history = getHistory();
                history = history.filter(item => item !== story);
                history.unshift(story);
                history = history.slice(0, 20);
                localStorage.setItem('storyHistory', JSON.stringify(history));
            }
            
            const loadHistory = () => {
                const history = getHistory();
                libraryList.innerHTML = '';
                if (history.length === 0) {
                    libraryList.innerHTML = `<p>${getCurrentLangData().alerts.emptyHistory}</p>`;
                    return;
                }
                history.forEach((story, index) => {
                    const item = document.createElement('div');
                    item.className = 'p-3 border border-slate-700 rounded-lg flex justify-between items-center gap-2';
                    
                    const storySpan = document.createElement('span');
                    storySpan.className = 'story-text flex-grow mr-3 cursor-pointer hover:text-violet-400 transition-colors';
                    storySpan.textContent = `${story.substring(0, 50)}${story.length > 50 ? '...' : ''}`;
                    storySpan.title = story;
                    storySpan.addEventListener('click', () => {
                        ceritaKarakterEl.value = story;
                        closeModal(libraryModal);
                        showAlert('success', getCurrentLangData().alerts.historyLoadedTitle, getCurrentLangData().alerts.historyLoadedMsg);
                    });

                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'text-red-500 hover:text-red-400 delete-history-btn flex-shrink-0';
                    deleteBtn.innerHTML = `<i class="fas fa-trash"></i>`;
                    deleteBtn.addEventListener('click', () => {
                        let currentHistory = getHistory();
                        currentHistory.splice(index, 1);
                        localStorage.setItem('storyHistory', JSON.stringify(currentHistory));
                        loadHistory();
                    });

                    item.appendChild(storySpan);
                    item.appendChild(deleteBtn);
                    libraryList.appendChild(item);
                });
            }

            const grantAccess = () => {
                passwordSection.style.display = 'none';
                generatorFieldset.disabled = false;
                logoutBtn.classList.remove('hidden');
                mobileLogoutBtn.classList.remove('hidden');
            }
            
            const lockAccess = () => {
                 const langData = translations[localStorage.getItem('language') || 'id'];
                 showConfirmation(
                    langData.textContent.logoutConfirmTitle,
                    langData.textContent.logoutConfirmMessage,
                    langData.textContent.confirmYes,
                    langData.textContent.confirmNo,
                    () => {
                        localStorage.removeItem('unlockTimestamp');
                        location.reload();
                    }
                 );
            }

            const checkAccess = () => {
                const unlockedTime = localStorage.getItem('unlockTimestamp');
                if (unlockedTime) {
                    const oneDay = 24 * 60 * 60 * 1000;
                    if (new Date().getTime() - unlockedTime < oneDay) {
                        grantAccess();
                        return;
                    } else {
                        localStorage.removeItem('unlockTimestamp');
                    }
                }
                passwordSection.style.display = 'block';
                generatorFieldset.disabled = true;
            }
            
            const translations = {
                en: {
                    textContent: { 
                        "nav-title": "Promptique Generator", "lang-btn-text": "EN", "history-btn-text": "History", "api-btn-text": "API Key", 
                        "login-title": "Terminal Access", "password-label": "Access Code", "login-button": "Login", "get-password-btn-text": "Get Access Code", 
                        "hero-title": "Action Figure Prompt Generator", "hero-subtitle": "// Quickly generate AI prompts for Action Figures //", 
                        "ai-assistant-title": "AI Assistant", "story-label": "Briefly describe your character", "theme-label": "Select Theme Nuance", "aiBtnText": "Adjust with AI", 
                        "manual-detail-title": "Manual Details", "name-label": "Character Name", "gender-label": "Gender / Type", "char-desc-label": "Character Description", 
                        "costume-desc-label": "Costume Description", "weapon-label": "Weapon / Item", "pose-label": "Pose & Expression", "creature-label": "Animal/Creature", 
                        "base-detail-label": "Specific Base Details", "base-shape-label": "Base Shape", "visual-style-label": "Visual Style", "generate-by-label": "Generate By", 
                        "reset-btn-text": "Reset", "generate-btn-text": "Generate Prompt", "result-title-id": "Final Prompt (Indonesian):", "copy-text-id": "Copy", 
                        "translateBtnText": "Translate to English", "result-title-en": "Final Prompt (English):", "copy-text-en": "Copy", 
                        "api-modal-title": "API Key Settings", "api-key-label": "Your Gemini API Key", "api-info-text": "Choose the API Key source you want to use.", 
                        "cancel-api-btn": "Cancel", "saveApiSystem": "Use System API", "saveApiUser": "Save & Use Your API", 
                        "history-modal-title": "Story History", "clear-history-btn-text": "Clear History", "close-btn-text": "Close", 
                        "mobile-logout-text": "Relock", "logoutConfirmTitle": "Logout Confirmation", "logoutConfirmMessage": "Are you sure you want to log out and relock the application?", 
                        "confirmYes": "Yes", "confirmNo": "No", "themeLight": "Light Mode", "themeDark": "Dark Mode",
                        "api-select-system-title": "Use System API", "api-select-system-subtitle": "Use the built-in key (rate-limited)",
                        "api-select-your-title": "Use Your Personal API", "api-select-your-subtitle": "Enter your own Gemini API key"
                    },
                    titles: { "logout-btn": "Relock", "theme-toggle": "Change Theme" },
                    placeholders: { "ceritaKarakter": "Example: A knight in silver armor guarding an ancient castle...", "namaKarakter": "Example: Arthur", "deskripsiKarakter": "Blond hair, blue eyes, determined face...", "deskripsiKostum": "Shining silver armor with a red cape...", "senjataAtauBenda": "The sword Excalibur stuck in a stone...", "deskripsiPose": "Standing proudly with a hand on the sword's hilt...", "astralMagis": "A golden griffin by his side...", "lingkungan": "Castle ruins with stone pillars...", "appPasswordInput": "ENTER CODE...", "api-key-input-modal": "Paste your API key here..." },
                    alerts: { loginSuccessTitle: "Access Granted", loginSuccessMessage: "Welcome, operator. You now have full access.", passwordError: "Access Denied. Incorrect code.", aiStoryMissing: "Character data input required.", aiSuccess: "AI has augmented the details!", aiError: "AI Assistant malfunction", promptCopied: "Prompt copied to clipboard!", historyCleared: "History has been purged.", apiSystemSelected: "Now using System API.", apiUserSaved: "Your personal API key is now active.", historyLoadedTitle: "Data Loaded", historyLoadedMsg: "Character data loaded from archive.", emptyHistory: "Archive is empty.", aiLoadingSystem: "System AI analyzing...", aiLoadingUser: "Your AI analyzing...", apiKeyDeletedTitle: "API Key Deleted", apiKeyDeletedMessage: "Your saved API key has been removed." }
                },
                id: {
                    textContent: { 
                        "nav-title": "Promptique Generator", "lang-btn-text": "ID", "history-btn-text": "Riwayat", "api-btn-text": "API Key", 
                        "login-title": "Akses Terminal", "password-label": "Kode Akses", "login-button": "Masuk", "get-password-btn-text": "Dapatkan Kode Akses", 
                        "hero-title": "Action Figure Prompt Generator", "hero-subtitle": "// Generate Prompt AI untuk Action Figure dengan cepat //", 
                        "ai-assistant-title": "AI Assistant", "story-label": "Ceritakan singkat tentang karakter Anda", "theme-label": "Pilih Nuansa Tema", "aiBtnText": "Sesuaikan dengan AI", 
                        "manual-detail-title": "Detail Manual", "name-label": "Nama Karakter", "gender-label": "Gender / Jenis", "char-desc-label": "Deskripsi Karakter", 
                        "costume-desc-label": "Deskripsi Kostum", "weapon-label": "Senjata / Benda", "pose-label": "Pose dan Ekspresi", "creature-label": "Hewan/Makhluk", 
                        "base-detail-label": "Detail Spesifik Alas", "base-shape-label": "Bentuk Alas", "visual-style-label": "Gaya Visual", "generate-by-label": "Generate By", 
                        "reset-btn-text": "Reset", "generate-btn-text": "Hasilkan Prompt", "result-title-id": "Prompt Final (Bahasa Indonesia):", "copy-text-id": "Salin", 
                        "translateBtnText": "Terjemahkan ke Bahasa Inggris", "result-title-en": "Final Prompt (English):", "copy-text-en": "Copy", 
                        "api-modal-title": "Pengaturan API Key", "api-key-label": "API Key Gemini Anda", "api-info-text": "Pilih sumber Kunci API yang ingin Anda gunakan.", 
                        "cancel-api-btn": "Batal", "saveApiSystem": "Gunakan API Sistem", "saveApiUser": "Simpan & Gunakan API Anda", 
                        "history-modal-title": "Riwayat Cerita", "clear-history-btn-text": "Bersihkan Riwayat", "close-btn-text": "Tutup", 
                        "mobile-logout-text": "Kunci Ulang", "logoutConfirmTitle": "Konfirmasi Keluar", "logoutConfirmMessage": "Apakah Anda yakin ingin keluar dan mengunci ulang aplikasi?", 
                        "confirmYes": "Ya", "confirmNo": "Tidak", "themeLight": "Mode Terang", "themeDark": "Mode Gelap",
                        "api-select-system-title": "Gunakan API Sistem", "api-select-system-subtitle": "Menggunakan kunci bawaan (ada batasan)",
                        "api-select-your-title": "Gunakan API Pribadi Anda", "api-select-your-subtitle": "Masukkan kunci API Gemini Anda sendiri"
                    },
                    titles: { "logout-btn": "Kunci Ulang", "theme-toggle": "Ganti Tema" },
                    placeholders: { "ceritaKarakter": "Contoh: Seorang ksatria dengan zirah perak yang menjaga kastil kuno...", "namaKarakter": "Contoh: Arthur", "deskripsiKarakter": "Rambut pirang, mata biru, wajah tegas...", "deskripsiKostum": "Zirah perak berkilauan dengan jubah merah...", "senjataAtauBenda": "Pedang Excalibur yang tertancap di batu...", "deskripsiPose": "Berdiri gagah dengan tangan di gagang pedang...", "astralMagis": "Seekor griffin emas di sampingnya...", "lingkungan": "Reruntuhan kastil dengan pilar-pilar batu...", "appPasswordInput": "MASUKKAN KODE...", "api-key-input-modal": "Masukkan API Key Anda..." },
                    alerts: { loginSuccessTitle: "Akses Diberikan", loginSuccessMessage: "Selamat datang, operator. Anda sekarang memiliki akses penuh.", passwordError: "Akses Ditolak. Kode salah.", aiStoryMissing: "Silakan masukkan cerita karakter terlebih dahulu.", aiSuccess: "AI telah mengisi detail!", aiError: "Asisten AI gagal", promptCopied: "Prompt berhasil disalin!", historyCleared: "Riwayat telah dibersihkan.", apiSystemSelected: "Kini menggunakan API Sistem.", apiUserSaved: "Kunci API Anda telah disimpan dan kini digunakan.", historyLoadedTitle: "Data Dimuat", historyLoadedMsg: "Cerita karakter telah dimuat dari arsip.", emptyHistory: "Arsip kosong.", aiLoadingSystem: "AI Sistem sedang menganalisa...", aiLoadingUser: "AI Anda sedang menganalisa...", apiKeyDeletedTitle: "API Key Dihapus", apiKeyDeletedMessage: "Kunci API Anda yang tersimpan telah dihapus." }
                }
            };
            
            const getCurrentLangData = () => {
                const lang = localStorage.getItem('language') || 'id';
                return translations[lang];
            }

            const applyLanguage = (lang) => {
                const langData = translations[lang];
                if (!langData) return;

                Object.keys(langData.textContent).forEach(key => {
                    const element = document.getElementById(key);
                    if (element) element.textContent = langData.textContent[key];
                });
                
                Object.keys(langData.titles).forEach(key => {
                    const element = document.getElementById(key);
                    if (element) element.title = langData.titles[key];
                });

                Object.keys(langData.placeholders).forEach(key => {
                    const element = document.getElementById(key);
                    if (element) element.placeholder = langData.placeholders[key];
                });
                localStorage.setItem('language', lang);
                document.documentElement.lang = lang;
                
                // Also update theme button text on language change
                const currentTheme = localStorage.getItem('theme') || 'dark';
                mobileThemeText.textContent = currentTheme === 'light' ? langData.textContent.themeDark : langData.textContent.themeLight;

            }

            const applyTheme = (theme) => {
                body.classList.toggle('light-theme', theme === 'light');
                const langData = getCurrentLangData();
                const themeIconClass = theme === 'light' ? 'fas fa-moon' : 'fas fa-sun';
                themeToggle.querySelector('i').className = themeIconClass;
                mobileThemeToggle.querySelector('i').className = `${themeIconClass} w-6`;
                mobileThemeText.textContent = theme === 'light' ? langData.textContent.themeDark : langData.textContent.themeLight;
                localStorage.setItem('theme', theme);
            }

            const handleThemeToggle = () => {
                const currentTheme = localStorage.getItem('theme') || 'dark';
                const newTheme = currentTheme === 'light' ? 'dark' : 'light';
                applyTheme(newTheme);
            };

            // --- Event Listeners ---
            
            alertOverlay.addEventListener('click', (e) => {
                if (e.target === alertOverlay) {
                    clearTimeout(alertTimeout);
                    alertOverlay.classList.remove('show');
                }
            });

            const toggleMenu = () => {
                const isOpen = offcanvasMenu.classList.toggle('open');
                offcanvasOverlay.classList.toggle('hidden', !isOpen);
            };

            menuToggle.addEventListener('click', toggleMenu);
            offcanvasOverlay.addEventListener('click', toggleMenu);

            togglePasswordBtn.addEventListener('click', () => {
                const isPassword = appPasswordInput.type === 'password';
                appPasswordInput.type = isPassword ? 'text' : 'password';
                passwordEyeIcon.className = `fas ${isPassword ? 'fa-eye-slash' : 'fa-eye'}`;
            });

            unlockBtn.addEventListener('click', () => {
                if (appPasswordInput.value === 'promptique975#') {
                    localStorage.setItem('unlockTimestamp', new Date().getTime());
                    grantAccess();
                    const langAlerts = getCurrentLangData().alerts;
                    showAlert('success', langAlerts.loginSuccessTitle, langAlerts.loginSuccessMessage);
                } else {
                    showAlert('error', 'Akses Ditolak', getCurrentLangData().alerts.passwordError);
                    appPasswordInput.value = '';
                }
            });
            
            appPasswordInput.addEventListener('keyup', (event) => {
                if (event.key === 'Enter') unlockBtn.click();
            });

            [logoutBtn, mobileLogoutBtn].forEach(btn => btn.addEventListener('click', lockAccess));
            
            languageToggle.addEventListener('click', () => {
                let newLang = (localStorage.getItem('language') || 'id') === 'id' ? 'en' : 'id';
                applyLanguage(newLang);
            });
            
            themeToggle.addEventListener('click', handleThemeToggle);
            mobileThemeToggle.addEventListener('click', handleThemeToggle);

            // Modal Listeners
            apiKeyModalBtn.addEventListener('click', () => openModal(apiKeyModal));
            riwayatBtn.addEventListener('click', () => {
                loadHistory();
                openModal(libraryModal);
            });
            allModals.forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target.classList.contains('modal-overlay') || e.target.classList.contains('close-modal-btn') || e.target.closest('.close-modal-btn')) {
                        closeModal(modal);
                    }
                });
            });

            // API Modal Logic
            selectSystemApiBtn.addEventListener('click', () => updateApiSelectionUI('system'));
            selectYourApiBtn.addEventListener('click', () => updateApiSelectionUI('personal'));

            toggleApiKeyBtn.addEventListener('click', () => {
                const isPassword = apiKeyInput.type === 'password';
                apiKeyInput.type = isPassword ? 'text' : 'password';
                apiKeyEyeIcon.className = `fas ${isPassword ? 'fa-eye-slash' : 'fa-eye'}`;
            });
            deleteApiKeyBtn.addEventListener('click', () => {
                apiKeyInput.value = '';
                localStorage.removeItem('geminiApiKey');
                const langAlerts = getCurrentLangData().alerts;
                showAlert('success', langAlerts.apiKeyDeletedTitle, langAlerts.apiKeyDeletedMessage);
            });
            saveApiChoiceBtn.addEventListener('click', () => {
                const langAlerts = getCurrentLangData().alerts;
                const apiSource = selectYourApiBtn.classList.contains('selected') ? 'personal' : 'system';
                localStorage.setItem('apiSource', apiSource);

                if (apiSource === 'personal') {
                    localStorage.setItem('geminiApiKey', apiKeyInput.value);
                    showAlert('success', 'Success', langAlerts.apiUserSaved);
                } else {
                    showAlert('success', 'Success', langAlerts.apiSystemSelected);
                }
                closeModal(apiKeyModal);
            });
            
            // History Modal Logic
            clearLibraryBtn.addEventListener('click', () => {
                localStorage.removeItem('storyHistory');
                loadHistory();
                showAlert('success', 'Success', getCurrentLangData().alerts.historyCleared);
            });

            // --- Core Generator Logic ---
            aiBtn.addEventListener('click', async () => {
                const userStory = ceritaKarakterEl.value.trim();
                if (!userStory) {
                    showAlert('error', 'Error', getCurrentLangData().alerts.aiStoryMissing);
                    return;
                }

                const loadingContainer = document.getElementById('aiBtnLoadingContainer');
                const loadingText = document.getElementById('aiBtnLoadingText');
                const btnTextContainer = document.getElementById('aiBtnTextContainer');
                
                loadingContainer.classList.remove('hidden');
                loadingContainer.classList.add('inline-flex');
                btnTextContainer.classList.add('hidden');
                aiBtn.disabled = true;

                const apiSource = localStorage.getItem('apiSource') || 'system';
                const userApiKey = localStorage.getItem('geminiApiKey');
                const langAlerts = getCurrentLangData().alerts;
                
                if (apiSource === 'personal' && userApiKey) {
                    loadingText.textContent = langAlerts.aiLoadingUser;
                } else {
                    loadingText.textContent = langAlerts.aiLoadingSystem;
                }


                const improvedPrompt = `Anda adalah seorang Master Desainer figur aksi AI yang sangat imajinatif dan analitis. Tugas Anda adalah mengambil ide dasar pengguna dan mengubahnya menjadi konsep figur aksi yang **spektakuler** dan **mendalam**. Ikuti aturan dengan **tegas** dan berimprovisasilah secara **kreatif** untuk menciptakan detail yang kaya berdasarkan cerita yang diberikan, dalam format JSON yang ketat.

Berdasarkan cerita pengguna ini: "${userStory}"

Lengkapi **semua** field dalam struktur JSON berikut sesuai aturan yang spesifik:

- **namaKarakter**: (string) Cari nama karakter yang disebut secara eksplisit dalam cerita (contoh: 'Prajurit bernama Aiyra'). Jika nama disebutkan, gunakan nama itu. Jika **TIDAK ADA** nama yang disebutkan, maka **WAJIB** ciptakan satu nama baru yang keren (hanya satu kata nama).
- **gender**: (string) Analisis cerita untuk menentukan jenis karakter. Pilihannya adalah "Pria", "Wanita", "Hewan", "Non-biner". **ATURAN TEGAS:** Jika cerita jelas menggambarkan manusia pria atau wanita, gunakan pilihan itu. Jika cerita jelas menggambarkan seekor hewan (misal 'serigala', 'naga', 'kucing'), **WAJIB** pilih "Hewan". Jika cerita menggambarkan makhluk non-manusia (robot, monster) atau tidak memberikan petunjuk gender yang jelas, **WAJIB** pilih "Non-biner".
- **deskripsiKarakter**: (string) Kembangkan penampilan fisik karakter. **ATURAN PENTING:** Jika gender adalah "Hewan", deskripsi **HARUS** fokus pada ciri-ciri hewan (bulu, sisik, cakar, moncong) dan **HINDARI** deskripsi humanoid, kecuali cerita secara spesifik menyebutkan karakter antropomorfik. Untuk gender lain, kembangkan detail (wajah, rambut, mata) yang kaya dan masuk akal sesuai cerita. Jangan menambahkan elemen visual seperti bekas luka atau tato kecuali diminta.
- **deskripsiKostum**: (string) Rancang kostum/perlengkapan yang **ikonik dan sangat detail**. Jika karakter adalah "Hewan", kostum bisa berupa armor khusus hewan, kalung, atau pelana. Jika tidak ada ide atau tidak disebutkan, isi dengan "Tidak ada deskripsi kostum". Untuk yang lain, kembangkan ide dari cerita dengan material dan tekstur yang rumit. Jangan menambahkan efek energi kecuali diminta.
- **senjataAtauBenda**: (string) **PERIKSA DENGAN TELITI:** Jika cerita secara eksplisit **menyebutkan** sebuah senjata, item, atau benda yang dipegang karakter, deskripsikan benda itu dengan detail yang **kreatif**. Jika cerita **TIDAK** menyebutkan benda apa pun, **WAJIB** isi field ini dengan "Tidak ada senjata atau benda".
- **deskripsiPose**: (string) Rancang pose yang **dinamis dan penuh emosi** yang mencerminkan kepribadian dan situasi karakter sesuai cerita.
- **lingkungan**: (string) Deskripsikan **hanya pemandangan di atas alas figur** itu sendiri. Ciptakan sebuah adegan miniatur yang detail dan nyata yang memperkuat cerita inti karakter. Contoh: 'permukaan tanah retak dari reruntuhan kuil kuno yang ditumbuhi akar pohon'. **PENTING:** Jangan mendeskripsikan latar belakang, siluet, atau elemen apa pun yang berada di luar alas miniatur tersebut.
- **astralMagis**: (string) **PERIKSA DENGAN TELITI:** Jika cerita secara eksplisit **menyebutkan** seekor hewan, makhluk, atau pendamping magis, deskripsikan makhluk itu secara **fantastis dan tak terduga**. Jika cerita **TIDAK** menyebutkan makhluk apa pun, **WAJIB** isi field ini dengan "Tidak ada hewan atau makhluk pendamping".

Output Anda **HARUS** berupa objek JSON yang valid, tanpa teks atau pemformatan tambahan.`;

                const generationPayload = {
                    contents: [{ role: "user", parts: [{ text: improvedPrompt }] }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                "namaKarakter": { "type": "STRING" },
                                "gender": { "type": "STRING", "enum": ["Pria", "Wanita", "Hewan", "Non-biner"] },
                                "deskripsiKarakter": { "type": "STRING" },
                                "deskripsiKostum": { "type": "STRING" },
                                "senjataAtauBenda": { "type": "STRING" },
                                "deskripsiPose": { "type": "STRING" },
                                "lingkungan": { "type": "STRING" },
                                "astralMagis": { "type": "STRING" }
                            },
                           "required": ["namaKarakter", "gender", "deskripsiKarakter", "deskripsiKostum", "senjataAtauBenda", "deskripsiPose", "lingkungan", "astralMagis"]
                        }
                    }
                };

                try {
                    const responseText = await performApiCall(generationPayload);
                    const data = JSON.parse(responseText);
                    
                    document.getElementById('namaKarakter').value = data.namaKarakter || '';
                    document.getElementById('gender').value = data.gender || '';
                    document.getElementById('deskripsiKarakter').value = data.deskripsiKarakter || '';
                    document.getElementById('deskripsiKostum').value = data.deskripsiKostum || '';
                    document.getElementById('senjataAtauBenda').value = data.senjataAtauBenda || '';
                    document.getElementById('deskripsiPose').value = data.deskripsiPose || '';
                    document.getElementById('astralMagis').value = data.astralMagis || '';
                    document.getElementById('lingkungan').value = data.lingkungan || '';
                    
                    saveStoryToHistory(userStory);
                    showAlert('success', 'Success', getCurrentLangData().alerts.aiSuccess);
                    
                    // Hide the previous result to prompt regeneration
                    resultSection.style.display = 'none';

                } catch (error) {
                    console.error('AI Assistant Error:', error);
                    showAlert('error', getCurrentLangData().alerts.aiError, error.message);
                } finally {
                    loadingContainer.classList.add('hidden');
                    loadingContainer.classList.remove('inline-flex');
                    btnTextContainer.classList.remove('hidden');
                    aiBtn.disabled = false;
                }
            });

            generateBtn.addEventListener('click', () => {
                const fields = {
                    gender: document.getElementById('gender').value,
                    deskripsiKarakter: document.getElementById('deskripsiKarakter').value.trim(),
                    deskripsiKostum: document.getElementById('deskripsiKostum').value.trim(),
                    senjataAtauBenda: document.getElementById('senjataAtauBenda').value.trim(),
                    deskripsiPose: document.getElementById('deskripsiPose').value.trim(),
                    astralMagis: document.getElementById('astralMagis').value.trim(),
                    lingkungan: document.getElementById('lingkungan').value.trim(),
                    namaKarakter: document.getElementById('namaKarakter').value.trim().toUpperCase(),
                    generateBy: document.getElementById('generateBy').value.trim(),
                    bentukAlas: document.getElementById('bentukAlas').value,
                    nuansa: document.getElementById('nuansaTemaAi').value
                };
                
                if (!fields.gender || !fields.deskripsiKarakter || !fields.deskripsiPose || !fields.lingkungan || !fields.namaKarakter || !fields.generateBy) {
                    showAlert("error", 'Formulir Belum Lengkap', 'Mohon isi semua kolom yang wajib diisi sebelum menghasilkan prompt.');
                    return;
                }

                const themeDetails = {
                    KlasikStudio: { baseStyle: "marmer poles yang bersih dan minimalis", placement: "diletakkan di atas meja putih", scene: "latar belakang kabur berupa ruangan nyaman dan terang, di mana sebuah Koleksi Aksi Figur dalam Etalase dan figur aksi lainnya terlihat diburamkan di latar belakang" },
                    Cyberpunk: { baseStyle: "panel logam dengan sirkuit terbuka dan kabel fiber optik yang menyala", placement: "ditampilkan di sebuah gang kota cyberpunk yang ramai di malam hari, basah oleh hujan", scene: "papan reklame neon yang menyala terang dan kendaraan terbang melintas di atas" },
                    FantasiMistis: { baseStyle: "batu kuno yang ditumbuhi lumut bercahaya dan diukir dengan rune sihir", placement: "berada di tengah hutan fantasi yang berkilauan di malam hari", scene: "partikel sihir mengambang di udara dan pohon-pohon raksasa menjulang ke langit berbintang" },
                    PascaApokaliptik: { baseStyle: "beton yang retak dan logam berkarat yang dilas menjadi satu", placement: "berdiri di atas puing-puing", scene: "pemandangan kota yang hancur saat matahari terbenam, gedung-gedung pencakar langit yang rusak, dan langit berwarna oranye karena debu" },
                    Steampunk: { baseStyle: "kayu mahoni yang diperkuat dengan lempengan kuningan dan roda gigi yang saling bertautan", placement: "berada di dalam bengkel seorang insinyur steampunk", scene: "dikelilingi oleh cetak biru, mesin yang rumit, dan jendela besar yang memperlihatkan kota industri Victoria" },
                    Kosmik: { baseStyle: "kristal obsidian yang permukaannya memantulkan gugusan bintang", placement: "melayang di angkasa", scene: "pemandangan luar angkasa yang menakjubkan, menampilkan galaksi spiral, gugusan bintang, dan aurora kosmik yang berwarna-warni" },
                    HororGotik: { baseStyle: "batu marmer hitam dengan ukiran gargoyle di sudut-sudutnya", placement: "berdiri di interior kastil Drakula yang remang-remang", scene: "jendela kaca patri tinggi, sarang laba-laba, dan bayangan memanjang yang menakutkan" },
                    BioLuminescent: { baseStyle: "jalinan akar kayu dan jamur yang memancarkan cahaya redup", placement: "berada di dalam gua atau hutan alien di malam hari", scene: "setiap tanaman, serangga, dan aliran air memancarkan cahaya biru, hijau, dan ungu yang lembut" },
                    MesirKuno: { baseStyle: "batu pasir yang diukir dengan hieroglif para dewa", placement: "berada di interior makam firaun yang megah", scene: "dinding yang dilukis, obor yang menyala, dan tumpukan harta karun emas" },
                    KerajaanLangit: { baseStyle: "awan padat yang dipahat dan dihiasi dengan kristal kuarsa", placement: "berdiri di balkon sebuah istana di atas awan", scene: "memandang ke lautan awan keemasan saat matahari terbit, dengan kota-kota melayang lainnya di kejauhan" },
                    PasirPantaiTropis: { baseStyle: "pasir putih halus dengan beberapa kerang dan bintang laut", placement: "berdiri di tepi pantai tropis yang indah", scene: "air laut biru jernih yang membasahi pasir, pohon-pohon palem melambai, dan matahari terbenam di cakrawala" },
                    InteriorDojoJepang: { baseStyle: "lantai kayu tatami dengan pintu geser shoji", placement: "berada di tengah dojo tradisional Jepang yang tenang", scene: "gulungan kaligrafi di dinding, rak senjata kayu, dan cahaya lembut masuk melalui jendela kertas" },
                    LaboratoriumSciFi: { baseStyle: "panel lantai heksagonal yang bersinar dengan cahaya biru", placement: "berada di laboratorium fiksi ilmiah yang steril dan canggih", scene: "dipenuhi dengan layar holografik, tabung stasis, dan lengan robotik" },
                    DekKapalBajakLaut: { baseStyle: "papan kayu lapuk dek kapal dengan tali-temali berserakan", placement: "berdiri di dek kapal bajak laut yang sedang berlayar di laut lepas", scene: "layar terkembang, meriam siap tembak, dan bendera Jolly Roger berkibar di tiang utama" },
                    TamanBungaSakura: { baseStyle: "batu loncatan yang dikelilingi kelopak bunga sakura merah muda", placement: "berada di taman Jepang saat musim semi, di bawah pohon sakura yang sedang mekar penuh", scene: "lentera batu dan jembatan kayu kecil di atas kolam koi" },
                    ReruntuhanHutanKuno: { baseStyle: "balok batu candi kuno yang ditumbuhi tanaman merambat", placement: "berada di reruntuhan kota kuno yang tersembunyi jauh di dalam hutan lebat", scene: "sinar matahari menembus kanopi dan kabut tipis menyelimuti tanah" },
                    KotaBawahAir: { baseStyle: "terumbu karang bercahaya dan reruntuhan Atlantis", placement: "berada di kota bawah laut yang hilang", scene: "bangunan kristal yang megah, ikan-ikan eksotis berenang di antara pilar-pilar kuno, dan cahaya biru dari permukaan laut di atas" },
                    ArenaGladiator: { baseStyle: "pasir dan batu arena Colosseum", placement: "berdiri di tengah arena gladiator Romawi yang megah", scene: "gerbang besi, dinding tribun yang menjulang tinggi dipenuhi penonton, dan bayangan dari arsitektur kuno" },
                    IstanaEsArktik: { baseStyle: "es transparan yang diukir dengan pola kepingan salju", placement: "berada di interior istana es yang berkilauan di Kutub Utara", scene: "pilar-pilar es raksasa, singgasana beku, dan aurora borealis menari di langit melalui atap kristal" },
                    DuniaPermen: { baseStyle: "biskuit wafer yang dilapisi gula warna-warni", placement: "berada di lanskap permen yang fantastis", scene: "sungai cokelat, pohon lolipop, bukit permen karet, dan rumah-rumah jahe di bawah langit pelangi" }
                };
                
                const selectedTheme = themeDetails[fields.nuansa] || themeDetails.Cyberpunk;
                const baseStyle = selectedTheme.baseStyle;
                const placement = selectedTheme.placement;
                const scene = selectedTheme.scene;

                const gayaVisual = document.getElementById('gayaVisual').value;
                
                let firstLine;
                if (gayaVisual === '3D Vector Ilustrasi') {
                    firstLine = 'Buat Gambar Visual Patung Fantasi bergaya komik 3D vektor modern, sangat detail. Tekankan garis-garis vektor yang bersih dan tajam, bayangan tegas bergaya stylized, highlight reflektif, palet warna kaya dan kontras tinggi, saturasi warna tinggi. Pencahayaan sinematik dramatis dengan depth of field tajam. Anatomi realistis yang proporsional dengan kaki panjang dan pose dinamis, Scale 1:16, Aspect Ratio 2:3, full-body. Efek seperti difoto dengan kamera DSLR mirrorless:';
                } else if (gayaVisual === '3D Lego Modern') {
                    firstLine = 'Buat Gambar Visual Patung Fantasi bergaya Lego 3D modern, sangat detail. Tekankan bentuk balok dan sambungan khas Lego yang bersih dan tajam, bayangan tegas bergaya stylized, highlight reflektif, palet warna kaya dan kontras tinggi, saturasi warna tinggi. Anatomi proporsional khas Lego, kepala silinder besar, tangan c-hook, kaki balok pendek, namun tetap dalam pose dinamis full-body. Pencahayaan sinematik dramatis dengan depth of field tajam, Scale 1:16, Aspect Ratio 2:3. Efek visual seperti difoto dengan kamera DSLR mirrorless, menonjolkan detail permukaan plastik Lego yang mengilap dan artistik:';
                } else if (gayaVisual === '3D Brick Block Toy') {
                    firstLine = 'Buat Gambar Visual Patung Fantasi dengan gaya 3D Brick Block Toy Style, Stylized Toy-Like, Blocky Construction, Plastic Texture, Bright and Solid Colors, Chunky Proportions, No Realistic Details, Cute and Playful Design, Miniature Scale 1:16, Aspect Ratio 2:3, Toy Photography Style, Studio Lighting, Clean Background, Visible Studs and Joints, Built Entirely from Brick Pieces, Simple Facial Expressions, Clear Outlines, dan Compact, Modular Body Shapes:';
                }
                else {
                    const styleKeywords = gayaVisual === '4D Hyper Realism'
                        ? '4D Stylized Hyper-Realism, Ultra-Detail, High-Realistic, UHD 8K, Highly Detailed, Hyper Cinematic Lighting, Sharp Depth of Field, High Saturation, Rich Color Palette, Sharp Contrast, Photographed with DSLR Mirrorless Camera, Realistic Proportional Anatomy, Full-body, Scale 1:16, Aspect Ratio 2:3, Long Legs, Balanced Body, HD Focused:'
                        : '3D Chibi Stylized Action Figure, Disney Pixar Style, Cute, Adorable, Soft Round Shapes, Big Expressive Eyes, Vibrant Colors, Claymation look, High Detail, Studio Lighting, Scale 1:16, Aspect Ratio 2:3, on a detailed miniature base:';
                    firstLine = `Buat Gambar Visual Patung Fantasi dengan gaya ${styleKeywords}`;
                }
                
                const defaultCostume = 'Tidak ada deskripsi kostum';
                const defaultWeapon = 'Tidak ada senjata atau benda';
                const defaultAnimal = 'Tidak ada hewan atau makhluk pendamping';

                let promptLines = [
                    firstLine,
                    `\nKarakter: ${fields.gender} ${fields.deskripsiKarakter}`
                ];

                if (fields.deskripsiKostum && fields.deskripsiKostum !== defaultCostume) {
                    promptLines.push(`Kostum: ${fields.deskripsiKostum}`);
                }
                if (fields.senjataAtauBenda && fields.senjataAtauBenda !== defaultWeapon) {
                    promptLines.push(`Benda: ${fields.senjataAtauBenda}`);
                }
                
                promptLines.push(`Pose dan Ekspresi: ${fields.deskripsiPose}`);

                if (fields.astralMagis && fields.astralMagis !== defaultAnimal) {
                    promptLines.push(`Pendamping: ${fields.astralMagis}, pastikan makhluk ini berada sepenuhnya di dalam area alas monumental, meskipun melayang.`);
                }

                promptLines.push(`\nSemua elemen ini dipasang di atas alas base ${fields.bentukAlas} yang terbuat dari bahan ${baseStyle}, di atasnya menampilkan miniatur detail dari ${fields.lingkungan} Dibuat tanpa efek kabut atau efek energi apapun yang membuat karakter tenggelam dan tidak ada elemen yang keluar dari area base.`);
                promptLines.push(`\nName Base: "${fields.namaKarakter}" ukuran: Large, Subtitle: “${fields.generateBy}” ukuran: Medium, terukir dalam tipografi bergaya iblis dan timbul.`);
                const backgroundDescription = `Figur ini ${placement}, dengan Latar Belakang ${scene}. Fokus utama hanya tertuju pada Patung Fantasi Realistis dan alasnya, dengan pencahayaan terang dan lembut. Gaya keseluruhan harus kuat.`;
                promptLines.push(`\n${backgroundDescription}`);
                
                const indonesianPrompt = promptLines.join('\n');
                outputPromptEl.value = indonesianPrompt;
                
                resultSection.style.display = 'block';
                translateSection.style.display = 'block';
                englishPromptSection.style.display = 'none';
                outputPromptEnEl.value = '';
                resultSection.scrollIntoView({ behavior: 'smooth' });
                showAlert('success', 'Prompt Dihasilkan', 'Prompt Bahasa Indonesia sudah siap.');
            });

            resetBtn.addEventListener('click', () => {
                promptForm.reset();
                ceritaKarakterEl.value = '';
                resultSection.style.display = 'none';
                outputPromptEl.value = '';
                outputPromptEnEl.value = '';
            });

            translateBtn.addEventListener('click', async () => {
                const indonesianPrompt = outputPromptEl.value;
                if (!indonesianPrompt) return;

                const spinner = document.getElementById('translateBtnSpinner');
                const btnText = document.getElementById('translateBtnTextContainer');
                spinner.classList.remove('hidden');
                btnText.classList.add('hidden');
                translateBtn.disabled = true;

                const payload = {
                    contents: [{ parts: [{ text: `Translate the following text to English. Maintain the formatting, technical terms like "--ar 16:9", and the "GENERATED BY" line exactly as they are:\n\n${indonesianPrompt}` }] }]
                };

                try {
                    const translatedText = await performApiCall(payload);
                    outputPromptEnEl.value = translatedText.trim();
                    englishPromptSection.style.display = 'block';
                    outputPromptEnEl.style.height = 'auto';
                    outputPromptEnEl.style.height = (outputPromptEnEl.scrollHeight) + 'px';
                } catch (error) {
                    console.error('Translation Error:', error);
                    showAlert('error', 'Translation Failed', error.message);
                } finally {
                    spinner.classList.add('hidden');
                    btnText.classList.remove('hidden');
                    translateBtn.disabled = false;
                }
            });
            
            const copyToClipboard = (elementId, langData) => {
                const textarea = document.getElementById(elementId);
                textarea.select();
                try {
                    document.execCommand('copy');
                    showAlert('success', 'Success', langData.promptCopied);
                } catch (err) {
                    showAlert('error', 'Error', 'Could not copy text.');
                }
                window.getSelection().removeAllRanges();
            };

            copyBtn.addEventListener('click', () => copyToClipboard('outputPrompt', getCurrentLangData().alerts));
            copyBtnEn.addEventListener('click', () => copyToClipboard('outputPromptEn', getCurrentLangData().alerts));

            // --- Initial Load ---
            checkAccess();
            applyLanguage(localStorage.getItem('language') || 'id');
            applyTheme(localStorage.getItem('theme') || 'dark');

            const savedApiSource = localStorage.getItem('apiSource') || 'system';
            apiKeyInput.value = localStorage.getItem('geminiApiKey') || '';
            updateApiSelectionUI(savedApiSource);
            
            // Set default theme to Cyberpunk
            document.getElementById('nuansaTemaAi').value = 'KlasikStudio';
        });
    </script>
</body>
</html>
