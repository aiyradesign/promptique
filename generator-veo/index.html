<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Prompt Generator â€“ Video Veo3 | prompt.ique</title>
    <meta name="description" content="Buat prompt AI untuk video sinematik Veo3 dengan gaya visual ultra realistis atau kreatif melalui Promptique.">
    
    <meta property="og:title" content="Promptique | AI Prompt Generator Video Veo3">
    <meta property="og:description" content="Buat prompt AI untuk video Veo3 berkualitas tinggi. Cepat dan siap digunakan di Gemini dan AI Studio.">
    <meta property="og:image" content="https://promptique.my.id/generator-veo/video_poster.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:url" content="https://promptique.my.id/generator-veo">
    <meta property="og:type" content="website">
    
    <link rel="icon" href="../icon.png" type="image/png" />
    
    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    
    <!-- App Stylesheet -->
    <style>
        html {
            scroll-behavior: smooth;
        }
        /* --- THEME VARIABLES --- */
        :root {
            /* Pastel Dark Theme */
            --theme-font-primary: 'Inter', sans-serif;
            --theme-font-accent: 'Inter', sans-serif;
            --theme-bg: #2a3045; /* Dark Slate Blue */
            --theme-panel-bg: #374151; /* Dark Gray Blue */
            --theme-border: #4a5568;
            --theme-text-primary: #f0f2f5;
            --theme-text-secondary: #a0aec0;
            --theme-accent-1: #c084fc; /* Lavender */
            --theme-accent-2: #6ee7b7; /* Mint */
            --theme-accent-3: #fcd34d; /* Amber */
            --theme-error: #fca5a5;
            --theme-success: #86efac;
        }

        body.light-theme {
            /* Pastel Minimalist (Light) Theme */
            --theme-font-primary: 'Inter', sans-serif;
            --theme-font-accent: 'Inter', sans-serif;
            --theme-bg: #fdf8f6; /* Peachy White */
            --theme-panel-bg: #ffffff;
            --theme-border: #e2e8f0;
            --theme-text-primary: #2d3748;
            --theme-text-secondary: #718096;
            --theme-accent-1: #a855f7; /* A bit more saturated purple for primary actions */
            --theme-accent-2: #10b981; /* Teal */
            --theme-accent-3: #f59e0b; /* Amber */
            --theme-error: #ef4444;
            --theme-success: #22c55e;
        }

        body {
            font-family: var(--theme-font-primary);
            background-color: var(--theme-bg);
            color: var(--theme-text-primary);
            position: relative;
            transition: background-color 0.5s, color 0.5s;
        }

        .gradient-text {
            font-family: var(--theme-font-accent);
            font-weight: 900;
            background: linear-gradient(90deg, var(--theme-accent-2), var(--theme-accent-1), var(--theme-accent-3));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .form-label {
            display: block; margin-bottom: 0.5rem; font-weight: 500;
            color: var(--theme-text-secondary);
            text-transform: uppercase; font-size: 0.8rem; letter-spacing: 1px;
            transition: color 0.3s;
        }

        .form-input, .form-textarea, .form-select {
            width: 100%;
            background-color: var(--theme-panel-bg);
            border: 1px solid var(--theme-border);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            color: var(--theme-text-primary);
            transition: all 0.3s ease;
        }
        body.light-theme .form-input, body.light-theme .form-textarea, body.light-theme .form-select {
            background-color: var(--theme-bg);
        }

        .form-input:focus, .form-textarea:focus, .form-select:focus {
            border-color: var(--theme-accent-1);
            box-shadow: 0 0 0 3px color-mix(in srgb, var(--theme-accent-1) 20%, transparent);
            outline: none;
        }

        .form-textarea.invalid-json {
            border-color: var(--theme-error);
            box-shadow: 0 0 0 3px color-mix(in srgb, var(--theme-error) 20%, transparent);
        }

        .form-select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            -webkit-appearance: none; -moz-appearance: none; appearance: none;
        }

        .card {
            background-color: var(--theme-panel-bg);
            border: 1px solid var(--theme-border);
            border-radius: 16px;
            transition: all 0.5s;
            box-shadow: 0 4px 14px 0 rgba(0,0,0,0.05);
        }
        body:not(.light-theme) .card {
            box-shadow: 0 4px 14px 0 rgba(0,0,0,0.15);
        }

        .btn {
            border-radius: 8px;
            transition: all 0.3s ease;
            text-transform: uppercase;
            font-family: var(--theme-font-accent);
            font-weight: 700;
            letter-spacing: 1px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            border: 1px solid transparent;
        }

        .btn-primary { background-color: var(--theme-accent-1); color: #fff; border-color: var(--theme-accent-1); }
        .btn-primary:hover:not(:disabled) { background-color: color-mix(in srgb, var(--theme-accent-1) 85%, black); transform: translateY(-2px); box-shadow: 0 4px 8px color-mix(in srgb, var(--theme-accent-1) 30%, transparent); }

        .btn-secondary { color: var(--theme-accent-2); border-color: var(--theme-accent-2); }
        .btn-secondary:hover:not(:disabled) { background-color: color-mix(in srgb, var(--theme-accent-2) 15%, transparent); transform: translateY(-2px); }

        .btn-danger { color: var(--theme-error); border-color: var(--theme-error); }
        .btn-danger:hover:not(:disabled) { background-color: color-mix(in srgb, var(--theme-error) 10%, transparent); }

        .btn-neutral { color: var(--theme-text-secondary); border-color: var(--theme-border); }
        .btn-neutral:hover:not(:disabled) { background-color: color-mix(in srgb, var(--theme-text-secondary) 10%, transparent); border-color: var(--theme-text-secondary); color: var(--theme-text-primary); }

        .btn-accent { color: var(--theme-accent-3); border-color: var(--theme-accent-3); }
        .btn-accent:hover:not(:disabled) { background-color: color-mix(in srgb, var(--theme-accent-3) 15%, transparent); }

        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .loader { width: 18px; height: 18px; border: 2px solid currentColor; border-bottom-color: transparent; border-radius: 50%; display: inline-block; box-sizing: border-box; animation: rotation 1s linear infinite; }
        .loader-xs { width: 14px; height: 14px; border: 2px solid currentColor; border-bottom-color: transparent; border-radius: 50%; display: inline-block; box-sizing: border-box; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #history-content {
            scroll-behavior: smooth;
        }

        /* --- PROMPT TABS & ACCORDION --- */
        .prompt-tabs {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 0.75rem 1rem;
            cursor: pointer;
            background-color: transparent;
            border: none;
            color: var(--theme-text-secondary);
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease-in-out;
            font-weight: 600;
            font-size: 0.9rem;
            font-family: var(--theme-font-primary);
            text-transform: none;
            letter-spacing: normal;
        }

        .tab-btn:hover {
            color: var(--theme-text-primary);
        }

        .tab-btn.active {
            color: var(--theme-accent-1);
            border-bottom-color: var(--theme-accent-1);
        }
        
        #json-accordion-container .tab-btn.active {
            color: var(--theme-accent-3);
            border-bottom-color: var(--theme-accent-3);
        }

        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out, padding 0.5s ease-in-out;
            padding: 0 1.5rem;
        }
        
        .accordion-content.open {
            max-height: 2000px; /* Large enough for content */
            padding: 1.5rem;
        }
        .accordion-content.json-accordion-content.open {
            padding: 0;
            max-height: 2000px;
        }

        /* --- OFF-CANVAS MENU --- */
        #offcanvas-menu:not(.open) {
            pointer-events: none;
        }

        #offcanvas-menu-panel {
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
        }

        #offcanvas-menu.open #offcanvas-menu-panel {
            transform: translateX(0);
        }

        #offcanvas-backdrop {
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }

        #offcanvas-menu.open #offcanvas-backdrop {
            opacity: 1;
        }
    </style>
</head>
<body class="antialiased">

    <div id="app-container">
        <!-- Navbar -->
        <header class="bg-[var(--theme-panel-bg)]/80 backdrop-blur-sm shadow-sm sticky top-0 z-40 border-b border-[var(--theme-border)] transition-colors duration-500">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex-shrink-0">
                        <h1 class="text-xl md:text-2xl font-extrabold tracking-tight gradient-text">
                            PROMPTIQUE
                        </h1>
                    </div>
                    <div class="flex items-center space-x-1">
                        <!-- Desktop Buttons -->
                        <div class="hidden md:flex items-center space-x-2">
                            <button data-ui-key-title="langTitle" id="lang-btn-desktop" class="btn btn-neutral h-10 px-3">
                                <span class="font-bold text-sm">ID</span>
                            </button>
                            <button data-ui-key-title="historyTitle" id="history-btn-desktop" class="btn btn-neutral h-10 px-3">
                                <i class="fas fa-history fa-fw text-lg"></i>
                                <span data-ui-key="historyTitle" class="text-sm font-semibold">Riwayat</span>
                            </button>
                            <button data-ui-key-title="apiKeyTitle" id="api-key-btn-desktop" class="btn btn-neutral h-10 px-3">
                                <i class="fas fa-key fa-fw text-lg"></i>
                                <span data-ui-key="apiKeyTitle" class="text-sm font-semibold">Kunci API</span>
                            </button>
                            <button data-ui-key-title="themeTitle" id="theme-btn-desktop" class="btn btn-neutral w-10 h-10 px-0">
                                <i class="fas fa-moon fa-fw text-lg"></i>
                            </button>
                            <button data-ui-key-title="logoutButton" id="logout-btn-desktop" class="btn btn-neutral w-10 h-10 px-0 hidden">
                                <i class="fas fa-sign-out-alt fa-fw text-lg"></i>
                            </button>
                        </div>
                        <!-- Mobile Buttons -->
                        <div class="md:hidden flex items-center space-x-1">
                             <button title="Ganti Bahasa" id="lang-btn-mobile-icon" class="btn btn-neutral w-10 h-10 px-0">
                                <span class="font-bold text-sm">ID</span>
                            </button>
                            <button title="Riwayat" id="history-btn-mobile-icon" class="btn btn-neutral w-10 h-10 px-0">
                                <i class="fas fa-history fa-fw text-lg"></i>
                            </button>
                             <button title="Kunci API" id="api-key-btn-mobile-icon" class="btn btn-neutral w-10 h-10 px-0">
                                <i class="fas fa-key fa-fw text-lg"></i>
                            </button>
                            <button id="hamburger-btn" class="btn btn-neutral w-10 h-10 px-0">
                                <i class="fas fa-bars fa-fw text-lg"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="container mx-auto p-4 sm:p-6 lg:p-8">
            <div class="text-center mb-12 animate__animated animate__fadeInDown animate__faster">
                <h2 data-ui-key="mainTitle" class="text-3xl md:text-4xl font-bold tracking-tight gradient-text">Buat Prompt Video Profesional</h2>
                <p data-ui-key="mainSubtitle" class="mt-3 max-w-2xl mx-auto text-lg text-[var(--theme-text-secondary)]">Isi ide Anda, biarkan AI menyusun detailnya, dan dapatkan prompt yang siap pakai untuk VEO atau generator video AI lainnya.</p>
            </div>

            <div class="max-w-4xl mx-auto">
                <!-- Login Card -->
                <section id="login-card" class="card p-6 sm:p-8 text-center animate__animated animate__fadeInUp animate__faster">
                    <h3 data-ui-key="loginWelcome" class="text-2xl font-bold gradient-text">Selamat Datang! Silakan Login.</h3>
                    <p class="text-[var(--theme-text-secondary)] mt-2 mb-8" data-ui-key="loginSubtitle">Masukkan kata sandi untuk melanjutkan.</p>
                    <form id="login-form" class="max-w-xs mx-auto">
                        <div class="space-y-4">
                            <div class="relative">
                                <label for="password" class="sr-only">Password</label>
                                <input type="password" id="password" class="form-input text-center pr-10" data-ui-key-placeholder="passwordPlaceholder">
                                <i id="toggle-password" class="fas fa-eye absolute top-1/2 right-3 -translate-y-1/2 cursor-pointer text-[var(--theme-text-secondary)] hover:text-[var(--theme-text-primary)]"></i>
                            </div>
                            <button type="submit" class="w-full btn btn-primary py-3 px-6">
                                <span data-ui-key="loginButton">Login</span>
                            </button>
                        </div>
                    </form>
                </section>

                <!-- Generator Content (Initially Hidden) -->
                <div id="generator-content" class="hidden space-y-10">
                    <!-- Step 1: Ide Pokok -->
                    <section id="step-1" class="card p-6 sm:p-8 animate__animated animate__fadeInUp animate__faster">
                        <div>
                            <p class="text-sm font-bold tracking-wider uppercase text-[var(--theme-accent-2)]" data-ui-key="step1Label"></p>
                            <h3 data-ui-key="step1Title" class="text-2xl font-bold gradient-text">Ide Pokok & Pengaturan Video</h3>
                        </div>
                        <p data-ui-key="step1Subtitle" class="text-[var(--theme-text-secondary)] mt-2 mb-8">Mulailah dengan ide dasar, pengaturan umum, dan jumlah adegan.</p>
                        <div class="space-y-6">
                            <div>
                                <label for="story-idea" class="form-label" data-ui-key="storyIdeaLabel">Ide Cerita</label>
                                <textarea id="story-idea" rows="4" class="form-textarea" data-ui-key-placeholder="storyIdeaPlaceholder"></textarea>
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                                <div>
                                    <label for="videoType" class="form-label" data-ui-key="videoTypeLabel">Jenis Video</label>
                                    <select id="videoType" class="form-select"></select>
                                </div>
                                <div>
                                    <label for="visualStyle" class="form-label" data-ui-key="visualStyleLabel">Gaya Visual</label>
                                    <select id="visualStyle" class="form-select"></select>
                                </div>
                                <div>
                                    <label for="soundType" class="form-label" data-ui-key="soundTypeLabel"></label>
                                    <select id="soundType" class="form-select"></select>
                                </div>
                                <div>
                                    <label for="scene-count" class="form-label" data-ui-key="sceneCountLabel">Jumlah Adegan</label>
                                    <select id="scene-count" class="form-select"></select>
                                </div>
                            </div>
                            <div class="flex items-center gap-4 mt-6">
                                <button id="reset-form-btn" data-ui-key-title="resetFormTitle" class="btn btn-danger py-6 px-5">
                                    <i class="fas fa-undo fa-lg"></i>
                                </button>
                                <button id="ai-director-btn" class="flex-grow btn btn-primary py-3 px-8">
                                    <span id="ai-btn-text" class="flex items-center justify-center gap-2">
                                        <i class="fas fa-user-astronaut"></i>
                                        <span data-ui-key="generateButton">Sutradara AI</span>
                                    </span>
                                    <span id="ai-btn-loader" class="hidden"></span>
                                </button>
                            </div>
                        </div>
                    </section>

                    <!-- Step 2: Storyboard Container -->
                    <div id="storyboard-container" class="space-y-10">
                        <!-- Dynamic storyboard will be injected here -->
                    </div>

                    <!-- Step 3: Final Prompts Container -->
                    <div id="final-prompt-step-container" class="hidden space-y-10">
                        <section id="step-3" class="card p-6 sm:p-8 animate__animated animate__fadeInUp animate__faster">
                            <div>
                                <p class="text-sm font-bold tracking-wider uppercase text-[var(--theme-accent-2)]" data-ui-key="step3Label"></p>
                                <h3 data-ui-key="step3Title" class="text-2xl font-bold gradient-text">Prompt Final</h3>
                            </div>
                            <p data-ui-key="step3Subtitle" class="text-[var(--theme-text-secondary)] mt-2 mb-8">Tinjau hasil, lalu hasilkan semua prompt video dengan sekali klik.</p>
                            <div class="space-y-6">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <button id="generate-all-prompts-btn" class="w-full btn btn-primary py-3 px-8">
                                        <span id="gen-all-btn-text" class="flex items-center justify-center gap-2">
                                            <i class="fas fa-wand-magic-sparkles"></i>
                                            <span data-ui-key="generateAllPromptsButton">Hasilkan Semua Prompt</span>
                                        </span>
                                        <span id="gen-all-btn-loader" class="hidden"></span>
                                    </button>
                                    <button id="generate-json-btn" class="w-full btn btn-accent py-3 px-8">
                                        <span id="gen-json-btn-text" class="flex items-center justify-center gap-2">
                                            <i class="fas fa-file-code"></i>
                                            <span data-ui-key="generateAllPromptsJsonButton">Hasilkan Prompt (JSON)</span>
                                        </span>
                                        <span id="gen-json-btn-loader" class="hidden"></span>
                                    </button>
                                </div>
                                <div id="final-results-area" class="hidden pt-6 mt-6 border-t border-[var(--theme-border)]">
                                    <!-- View 1: JSON Accordion Output -->
                                    <div id="json-accordion-container" class="hidden space-y-4">
                                        <!-- JSON accordion will be rendered here -->
                                    </div>
                                    <!-- View 2: Detailed Accordion Output -->
                                    <div id="final-prompts-container" class="space-y-4">
                                        <!-- Final prompts will be rendered here -->
                                    </div>
                                </div>
                            </div>
                        </section>
                    </div>

                </div>
            </div>
        </main>
    </div>

    <!-- Off-canvas Menu -->
    <div id="offcanvas-menu" class="fixed inset-0 z-50 hidden">
        <!-- Backdrop -->
        <div id="offcanvas-backdrop" class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>
        <!-- Menu Panel -->
        <div id="offcanvas-menu-panel" class="absolute top-0 right-0 h-full w-4/5 max-w-xs bg-[var(--theme-panel-bg)] shadow-xl">
            <div class="p-4 flex flex-col h-full">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-bold gradient-text" data-ui-key="mobileMenuTitle">Menu</h3>
                    <button id="offcanvas-close-btn" class="btn btn-neutral w-10 h-10 px-0">
                        <i class="fas fa-times fa-fw text-lg"></i>
                    </button>
                </div>
                <div class="space-y-2">
                    <button id="theme-btn-mobile" class="btn btn-neutral w-full justify-start p-3">
                        <i class="fas fa-moon fa-fw text-lg w-6 text-center"></i>
                        <span data-ui-key="themeTitle">Ganti Tema</span>
                    </button>
                    <button id="logout-btn-mobile-menu" class="btn btn-neutral w-full justify-start p-3 hidden">
                        <i class="fas fa-sign-out-alt fa-fw text-lg w-6 text-center"></i>
                        <span data-ui-key="logoutButton">Logout</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="history-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 hidden items-start justify-center p-4">
        <div class="card p-6 w-full max-w-lg transform transition-all flex flex-col animate__animated animate__faster max-h-[90vh]">
            <div class="flex-shrink-0 flex justify-between items-center mb-4 pb-4 border-b border-[var(--theme-border)]">
                <h3 class="text-2xl font-bold gradient-text"><i class="fas fa-history mr-2"></i><span data-ui-key="historyModalTitle">Riwayat Prompt</span></h3>
                <button class="close-modal-btn text-[var(--theme-text-secondary)] hover:text-[var(--theme-accent-2)] text-2xl">&times;</button>
            </div>
            <div id="history-content" class="flex-grow overflow-y-auto space-y-2 pr-2"></div>
            <div class="flex-shrink-0 mt-4 pt-4 border-t border-[var(--theme-border)] flex justify-end">
                <button id="clear-history-btn" class="btn btn-danger py-2 px-4"><i class="fas fa-trash mr-2"></i><span data-ui-key="clearHistoryButton">Bersihkan Riwayat</span></button>
            </div>
        </div>
    </div>

    <div id="api-key-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 hidden items-start justify-center p-4">
        <div class="card p-6 sm:p-8 w-full max-w-lg transform transition-all animate__animated animate__faster flex flex-col max-h-[90vh]">
            <div class="flex-shrink-0 flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold gradient-text"><i class="fas fa-key mr-2"></i><span data-ui-key="apiKeySettingsTitle"></span></h3>
                <button class="close-modal-btn text-[var(--theme-text-secondary)] hover:text-[var(--theme-accent-2)] text-2xl">&times;</button>
            </div>
            <div class="flex-grow overflow-y-auto -mr-4 pr-4 sm:-mr-6 sm:pr-6">
                <p class="text-[var(--theme-text-secondary)] mb-6" data-ui-key="chooseApiKeySource"></p>
                <div class="space-y-4">
                    <!-- System API Option -->
                    <div id="api-source-system" class="api-source-option border-2 rounded-lg p-4 cursor-pointer transition-all">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="font-bold text-[var(--theme-text-primary)]" data-ui-key="useSystemApi"></p>
                                <p class="text-sm text-[var(--theme-text-secondary)]" data-ui-key="useSystemApiDesc"></p>
                            </div>
                            <i class="fas fa-check-circle text-xl"></i>
                        </div>
                    </div>

                    <!-- Personal API Option -->
                    <div id="api-source-personal" class="api-source-option border-2 rounded-lg p-4 cursor-pointer transition-all">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="font-bold text-[var(--theme-text-primary)]" data-ui-key="usePersonalApi"></p>
                                <p class="text-sm text-[var(--theme-text-secondary)]" data-ui-key="usePersonalApiDesc"></p>
                            </div>
                            <i class="far fa-circle text-xl"></i>
                        </div>
                    </div>
                </div>

                <!-- Personal API Details (hidden by default) -->
                <div id="personal-api-details" class="mt-6 space-y-6 hidden">
                    <div>
                        <h4 class="font-bold text-[var(--theme-text-primary)] mb-2" data-ui-key="howToGetKey"></h4>
                        <ol id="api-key-instructions-desktop" class="list-decimal list-inside text-sm text-[var(--theme-text-secondary)] space-y-1"></ol>
                        <ol id="api-key-instructions-mobile" class="list-decimal list-inside text-sm text-[var(--theme-text-secondary)] space-y-1 hidden"></ol>
                    </div>
                    <div>
                        <label for="api-key-input" class="form-label uppercase text-xs" data-ui-key="yourApiKeyLabel"></label>
                        <div class="relative">
                            <input type="password" id="api-key-input" class="form-input pr-24">
                            <div class="absolute inset-y-0 right-0 flex items-center pr-2 space-x-1">
                                 <button id="toggle-api-key-visibility" class="btn btn-neutral w-8 h-8 p-0"><i class="fas fa-eye"></i></button>
                                <button id="delete-api-key-btn" class="btn btn-danger w-8 h-8 p-0"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- System API Note (visible by default) -->
                <div id="system-api-note" class="mt-6 p-4 bg-blue-500/10 border-l-4 border-blue-400 text-blue-300 rounded-r-lg">
                    <p class="text-sm" data-ui-key="apiKeyNote"></p>
                </div>
            </div>
            <div class="flex-shrink-0 flex gap-4 mt-8 pt-6 border-t border-[var(--theme-border)]">
                <button id="api-modal-cancel-btn" class="w-full btn btn-neutral py-2 px-4" data-ui-key="cancelButton"></button>
                <button id="api-modal-save-btn" class="w-full btn btn-primary py-2 px-4" data-ui-key="saveButton"></button>
            </div>
        </div>
    </div>


    <div id="alert-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
        <div id="alert-modal-content" class="card p-8 w-full max-w-md transform transition-all text-center animate__animated animate__faster flex flex-col max-h-[90vh]">
            <div class="flex-grow overflow-y-auto">
                <div id="alert-icon-container" class="w-16 h-16 rounded-full mx-auto flex items-center justify-center mb-4">
                    <i id="alert-icon" class="fas text-4xl text-white"></i>
                </div>
                <h3 id="alert-title" class="text-2xl font-bold text-[var(--theme-text-primary)] mb-2"></h3>
                <p id="alert-message" class="text-[var(--theme-text-secondary)]"></p>
            </div>
            <div class="flex-shrink-0 mt-6">
                <button id="alert-close-btn" class="btn w-full"></button>
            </div>
        </div>
    </div>

    <div id="confirmation-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
        <div id="confirmation-modal-content" class="card p-8 w-full max-w-md transform transition-all text-center animate__animated animate__faster flex flex-col max-h-[90vh]">
            <div class="flex-grow overflow-y-auto">
                <div class="w-16 h-16 rounded-full mx-auto flex items-center justify-center mb-4 bg-[var(--theme-accent-3)]">
                    <i class="fas fa-exclamation-triangle text-4xl text-[var(--theme-bg)]"></i>
                </div>
                <h3 id="confirmation-title" class="text-2xl font-bold text-[var(--theme-text-primary)] mb-2"></h3>
                <p id="confirmation-message" class="text-[var(--theme-text-secondary)]"></p>
            </div>
            <div class="flex-shrink-0 mt-6">
                <div class="flex gap-4">
                    <button id="confirm-yes-btn" class="w-full btn btn-danger"></button>
                    <button id="confirm-no-btn" class="w-full btn btn-neutral"></button>
                </div>
            </div>
        </div>
    </div>

    <script type="importmap">
      {
        "imports": {
          "@google/genai": "https://esm.sh/@google/genai@^1.4.0"
        }
      }
    </script>
    <script type="module">
        /* tslint:disable */
        /**
         * @license
         * Copyright 2025 Google LLC
         * SPDX-License-Identifier: Apache-2.0
         */
        import { GoogleGenAI, Type } from "@google/genai";

        document.addEventListener('DOMContentLoaded', () => {
            // --- GEMINI API SETUP ---
            const SYSTEM_API_KEY = 'AIzaSyCPw9hFQQ2fnNARCFev29--Pq3l6C5MyRA';

            // --- CONFIGURATION & STATE ---
            const AppState = {
                currentLang: 'id',
                currentTheme: 'dark',
                storyboardData: null,
                isLoggedIn: false,
                personalApiKey: null,
                apiKeySource: 'system', // 'system' or 'personal'
            };

            const UI_STRINGS = {
                id: {
                    langTitle: "Ganti Bahasa",
                    themeTitle: "Ganti Tema",
                    mainTitle: "Buat Prompt Video Profesional",
                    mainSubtitle: "Isi ide Anda, biarkan AI menyusun detailnya, dan dapatkan prompt yang siap pakai untuk VEO atau generator video AI lainnya.",
                    step1Label: "Langkah 1",
                    step2Label: "Langkah 2",
                    step3Label: "Langkah 3",
                    step1Title: "Ide Pokok & Pengaturan Video",
                    step1Subtitle: "Mulailah dengan ide dasar, pengaturan umum, dan jumlah adegan.",
                    step2Title: "Detail Cerita & Karakter",
                    step2Subtitle: "Tinjau dan ubah detail yang dihasilkan AI agar sesuai dengan visi Anda.",
                    step3Title: "Prompt Final",
                    step3Subtitle: "Tinjau hasil, lalu hasilkan semua prompt video dengan sekali klik.",
                    storyIdeaLabel: "Ide Cerita",
                    storyIdeaPlaceholder: "Contoh: Seekor kucing astronot menemukan planet yang terbuat dari benang wol.",
                    sceneCountLabel: "Jumlah Adegan",
                    videoTypeLabel: "Jenis Video",
                    visualStyleLabel: "Gaya Visual",
                    soundTypeLabel: "Jenis Suara atau Musik Latar (Opsional)",
                    generateButton: "Sutradara AI",
                    generateAllPromptsButton: "Hasilkan Semua Prompt",
                    generateAllPromptsJsonButton: "Hasilkan Prompt (JSON)",
                    copyJsonButton: "Salin JSON",
                    jsonOutputPlaceholder: "Output JSON akan muncul di sini...",
                    keyCharactersLabel: "Karakter & Objek Kunci",
                    editButton: "Ubah",
                    saveButton: "Simpan & Perbarui",
                    sceneLabel: "Adegan",
                    combinedPromptTab: "Prompt Gabungan",
                    imageMotionPromptTab: "Gambar + Gerakan",
                    combinedPromptDescription: "Prompt lengkap untuk generasi Teks-ke-Video.",
                    imageMotionPromptDescription: "Hasilkan gambar dulu, lalu gunakan prompt kedua untuk menganimasikannya.",
                    imagePromptStepLabel: "Langkah 1: Prompt Gambar",
                    animationPromptStepLabel: "Langkah 2: Prompt Gerakan & Audio",
                    copyCombinedPrompt: (sceneNumber) => `Salin Prompt Adegan ${sceneNumber}`,
                    copyImagePrompt: "Salin Prompt Gambar",
                    copyAnimationPrompt: "Salin Prompt Gerakan & Audio",
                    copyButton: "Salin",
                    historyTitle: "Riwayat",
                    apiKeyTitle: "Kunci API",
                    logoutButton: "Keluar",
                    historyModalTitle: "Riwayat Ide Cerita",
                    clearHistoryButton: "Bersihkan Riwayat",
                    apiKeySettingsTitle: "Pengaturan API Key",
                    chooseApiKeySource: "Pilih sumber Kunci API yang ingin Anda gunakan.",
                    useSystemApi: "Gunakan API Sistem",
                    useSystemApiDesc: "Menggunakan kunci bawaan (ada batasan)",
                    usePersonalApi: "Gunakan API Pribadi Anda",
                    usePersonalApiDesc: "Masukkan kunci API Gemini Anda sendiri",
                    howToGetKey: "Cara mendapatkan API Key:",
                    apiKeyInstructionsDesktop: [
                        "Kunjungi <a href='https://aistudio.google.com/' target='_blank' class='text-[var(--theme-accent-3)] hover:underline'>Google AI Studio</a>.",
                        "Masuk dengan akun Google Anda.",
                        "Klik tombol <strong>Get API key</strong> yang ada di menu sebelah kiri.",
                        "Pilih atau buat proyek, lalu klik <strong>Create API key</strong>."
                    ],
                    apiKeyInstructionsMobile: [
                        "Kunjungi <a href='https://aistudio.google.com/' target='_blank' class='text-[var(--theme-accent-3)] hover:underline'>Google AI Studio</a>.",
                        "Masuk dengan akun Google Anda.",
                        "Ketuk ikon menu (&#9776;) di pojok kiri atas.",
                        "Pilih menu <strong>Get API key</strong>.",
                        "Pilih atau buat proyek, lalu ketuk <strong>Create API key</strong>."
                    ],
                    yourApiKeyLabel: "API KEY GEMINI ANDA",
                    apiKeyNote: "Catatan: Kunci ini digunakan bersama dan mungkin memiliki batasan. Untuk pengalaman terbaik, kami sangat menyarankan menggunakan Kunci API Anda sendiri.",
                    apiKeyPlaceholder: "Masukkan API Key Anda...",
                    cancelButton: "Batal",
                    deleteButton: "Hapus",
                    alertApiSettingsSaved: "Pengaturan API berhasil disimpan!",
                    alertApiKeyEmpty: "Input API Key tidak boleh kosong.",
                    alertSceneSaved: "Adegan berhasil diperbarui. Silakan hasilkan ulang prompt jika perlu.",
                    alertCharactersUpdatedSuccess: "Detail cerita berhasil dibuat ulang dengan karakter baru!",
                    alertCharactersUpdateFailed: "Gagal memperbarui detail cerita. Silakan coba lagi.",
                    alertCharacterFieldsEmpty: "Judul dan deskripsi karakter tidak boleh kosong.",
                    alertHistoryCleared: "Riwayat berhasil dibersihkan.",
                    alertHistoryEmpty: "Tidak ada riwayat untuk ditampilkan.",
                    alertSceneCopied: "Prompt berhasil disalin!",
                    alertCopyFailed: "Gagal menyalin prompt.",
                    alertIdeaEmpty: "Mohon isi Ide Cerita terlebih dahulu.",
                    alertVideoTypeEmpty: "Mohon pilih Jenis Video.",
                    alertVisualStyleEmpty: "Mohon pilih Gaya Visual.",
                    alertSceneCountEmpty: "Mohon pilih Jumlah Adegan.",
                    alertIdeaIncoherent: "Ide cerita tidak jelas atau tidak dapat dipahami. Mohon berikan ide yang lebih spesifik.",
                    loaderSystemAI: "Ai Sistem Menganalisa...",
                    loaderUserAI: "Ai Anda sedang Menganalisa...",
                    alertGenerated: "Detail cerita berhasil dibuat oleh AI!",
                    promptGenerationProgress: (current, total) => `Membuat prompt untuk Adegan ${current}/${total}...`,
                    allPromptsGenerated: (count, total) => `Semua prompt untuk ${count} dari ${total} adegan berhasil dibuat!`,
                    allPromptsJsonGenerated: "Output JSON berhasil dibuat!",
                    alertSuccessTitle: "Berhasil",
                    alertErrorTitle: "Terjadi Kesalahan",
                    alertInfoTitle: "Informasi",
                    alertCloseButton: "Tutup",
                    confirmLogoutTitle: "Konfirmasi Logout",
                    confirmLogoutMessage: "Apakah Anda yakin ingin keluar?",
                    confirmYes: "Ya, Keluar",
                    confirmNo: "Tidak",
                    alertLoggedOut: "Anda telah berhasil logout.",
                    loginWelcome: "Selamat Datang! Silakan Login.",
                    loginSubtitle: "Masukkan kata sandi untuk melanjutkan.",
                    passwordPlaceholder: "Masukkan Kata Sandi",
                    loginButton: "Login",
                    loginFailed: "Kata sandi salah!",
                    alertTranslationError: "Gagal menerjemahkan adegan.",
                    promptGenerationFailed: "Gagal membuat prompt.",
                    alertSceneTranslated: "Adegan berhasil diterjemahkan.",
                    mobileMenuTitle: "Menu",
                    secondsUnit: "detik",
                    visualDescriptionLabel: "Visual",
                    cameraDescriptionLabel: "Kamera",
                    audioDescriptionLabel: "Audio",
                    elementLabel: "Elemen",
                    motionLabel: "Gerakan",
                    endingLabel: "Akhir",
                    keywordLabel: "Kata Kunci",
                    negativePromptLabel: "Prompt Negatif",
                    lightingLabel: "Pencahayaan",
                    roomLabel: "Lokasi / Ruangan",
                    personalApiLimitReached: "Batas API pribadi Anda tercapai. Proses diselesaikan menggunakan API sistem.",
                    resetFormTitle: "Reset Formulir",
                    alertFormReset: "Formulir berhasil direset!",
                },
                en: {
                    langTitle: "Change Language",
                    themeTitle: "Change Theme",
                    mainTitle: "Create Professional Video Prompts",
                    mainSubtitle: "Enter your idea, let the AI handle the details, and get ready-to-use prompts for VEO or other AI video generators.",
                    step1Label: "Step 1",
                    step2Label: "Step 2",
                    step3Label: "Step 3",
                    step1Title: "Core Idea & Video Settings",
                    step1Subtitle: "Start with the basic idea, general settings, and number of scenes.",
                    step2Title: "Story Details & Characters",
                    step2Subtitle: "Review and edit the AI-generated details to match your vision.",
                    step3Title: "Final Prompts",
                    step3Subtitle: "Review the results, then generate all video prompts with one click.",
                    storyIdeaLabel: "Story Idea",
                    storyIdeaPlaceholder: "e.g., An astronaut cat discovers a planet made of yarn.",
                    sceneCountLabel: "Number of Scenes",
                    videoTypeLabel: "Video Type",
                    visualStyleLabel: "Visual Style",
                    soundTypeLabel: "Sound Type or Background Music (Optional)",
                    generateButton: "AI Director",
                    generateAllPromptsButton: "Generate All Prompts",
                    generateAllPromptsJsonButton: "Generate Prompts (JSON)",
                    copyJsonButton: "Copy JSON",
                    jsonOutputPlaceholder: "JSON output will appear here...",
                    keyCharactersLabel: "Key Characters & Objects",
                    editButton: "Edit",
                    saveButton: "Save & Update",
                    sceneLabel: "Scene",
                    combinedPromptTab: "Combined Prompt",
                    imageMotionPromptTab: "Image + Motion",
                    combinedPromptDescription: "A complete prompt for Text-to-Video generation.",
                    imageMotionPromptDescription: "Generate the image first, then use the second prompt to animate it.",
                    imagePromptStepLabel: "Step 1: Image Prompt",
                    animationPromptStepLabel: "Step 2: Motion & Audio Prompt",
                    copyCombinedPrompt: (sceneNumber) => `Copy Scene ${sceneNumber} Prompt`,
                    copyImagePrompt: "Copy Image Prompt",
                    copyAnimationPrompt: "Copy Motion & Audio Prompt",
                    copyButton: "Copy",
                    historyTitle: "History",
                    apiKeyTitle: "API Key",
                    logoutButton: "Logout",
                    historyModalTitle: "Story Idea History",
                    clearHistoryButton: "Clear History",
                    apiKeySettingsTitle: "API Key Settings",
                    chooseApiKeySource: "Choose the API Key source you want to use.",
                    useSystemApi: "Use System API",
                    useSystemApiDesc: "Use the built-in key (with limitations)",
                    usePersonalApi: "Use Your Personal API",
                    usePersonalApiDesc: "Enter your own Gemini API key",
                    howToGetKey: "How to get an API Key:",
                    apiKeyInstructionsDesktop: [
                        "Visit <a href='https://aistudio.google.com/' target='_blank' class='text-[var(--theme-accent-3)] hover:underline'>Google AI Studio</a>.",
                        "Sign in with your Google account.",
                        "Click the <strong>Get API key</strong> button in the left menu.",
                        "Select or create a project, then click <strong>Create API key</strong>."
                    ],
                    apiKeyInstructionsMobile: [
                        "Visit <a href='https://aistudio.google.com/' target='_blank' class='text-[var(--theme-accent-3)] hover:underline'>Google AI Studio</a>.",
                        "Sign in with your Google account.",
                        "Tap the menu icon (&#9776;) in the top-left corner.",
                        "Select the <strong>Get API key</strong> menu.",
                        "Select or create a project, then tap <strong>Create API key</strong>."
                    ],
                    yourApiKeyLabel: "YOUR GEMINI API KEY",
                    apiKeyNote: "Note: This key is shared and may have limitations. For the best experience, we highly recommend using your own API Key.",
                    apiKeyPlaceholder: "Enter your API Key here...",
                    cancelButton: "Cancel",
                    deleteButton: "Delete",
                    alertApiSettingsSaved: "API settings saved successfully!",
                    alertApiKeyEmpty: "API Key input cannot be empty.",
                    alertSceneSaved: "Scene updated successfully. Please regenerate prompts if needed.",
                    alertCharactersUpdatedSuccess: "Story details regenerated successfully with new characters!",
                    alertCharactersUpdateFailed: "Failed to update story details.",
                    alertCharacterFieldsEmpty: "Character title and description cannot be empty.",
                    alertHistoryCleared: "History cleared successfully.",
                    alertHistoryEmpty: "No history to display.",
                    alertSceneCopied: "Prompt copied successfully!",
                    alertCopyFailed: "Failed to copy prompt.",
                    alertIdeaEmpty: "Please fill in the Story Idea first.",
                    alertVideoTypeEmpty: "Please select a Video Type.",
                    alertVisualStyleEmpty: "Please select a Visual Style.",
                    alertSceneCountEmpty: "Please select the Number of Scenes.",
                    alertIdeaIncoherent: "The story idea is unclear or nonsensical. Please provide a more specific idea.",
                    loaderSystemAI: "System AI Analyzing...",
                    loaderUserAI: "Your AI is Analyzing...",
                    alertGenerated: "Story details generated successfully by AI!",
                    promptGenerationProgress: (current, total) => `Generating prompt for Scene ${current}/${total}...`,
                    allPromptsGenerated: (count, total) => `All prompts for ${count} of ${total} scenes generated successfully!`,
                    allPromptsJsonGenerated: "JSON output created successfully!",
                    alertSuccessTitle: "Success",
                    alertErrorTitle: "An Error Occurred",
                    alertInfoTitle: "Information",
                    alertCloseButton: "Close",
                    confirmLogoutTitle: "Logout Confirmation",
                    confirmLogoutMessage: "Are you sure you want to log out?",
                    confirmYes: "Yes, Logout",
                    confirmNo: "No",
                    alertLoggedOut: "You have been successfully logged out.",
                    loginWelcome: "Welcome! Please Login.",
                    loginSubtitle: "Enter the password to continue.",
                    passwordPlaceholder: "Enter Password",
                    loginButton: "Login",
                    loginFailed: "Incorrect password!",
                    alertTranslationError: "Failed to translate scene.",
                    promptGenerationFailed: "Failed to generate prompt.",
                    alertSceneTranslated: "Scene translated successfully.",
                    mobileMenuTitle: "Menu",
                    secondsUnit: "seconds",
                    visualDescriptionLabel: "Visual",
                    cameraDescriptionLabel: "Camera",
                    audioDescriptionLabel: "Audio",
                    elementLabel: "Elements",
                    motionLabel: "Motion",
                    endingLabel: "Ending",
                    keywordLabel: "Keywords",
                    negativePromptLabel: "Negative Prompt",
                    lightingLabel: "Lighting",
                    roomLabel: "Location / Room",
                    personalApiLimitReached: "Your personal API limit was reached. The process was completed using the system API.",
                    resetFormTitle: "Reset Form",
                    alertFormReset: "Form has been reset!",
                }
            };

            const DROPDOWN_OPTIONS = {
                id: {
                    videoType: [ { value: 'videoType.none', text: 'Pilih Jenis Video' }, { value: 'videoType.productAd', text: 'Iklan Produk' }, { value: 'videoType.shortFilm', text: 'Film Pendek' }, { value: 'videoType.cinematicReels', text: 'Reels Sinematik' }, { value: 'videoType.storytelling', text: 'Bercerita' }, { value: 'videoType.romantic', text: 'Cerita Romantis' }, { value: 'videoType.musicVideo', text: 'Video Musik' }, { value: 'videoType.lyricVideo', text: 'Video Lirik' }, { value: 'videoType.explainer', text: 'Penjelasan / Edukasi' }, { value: 'videoType.tutorial', text: 'Tutorial / Cara Kerja' }, { value: 'videoType.miniDoc', text: 'Dokumenter Mini' }, { value: 'videoType.trailer', text: 'Trailer / Teaser' }, { value: 'videoType.podcast', text: 'Podcast' }, { value: 'videoType.vlog', text: 'Vlog / Pribadi' }, { value: 'videoType.timelapse', text: 'Timelapse / Hyperlapse' }, { value: 'videoType.meditation', text: 'Konten Meditasi' }, { value: 'videoType.dataVis', text: 'Visualisasi Data Abstrak' }, { value: 'videoType.concept', text: 'Presentasi Konsep' }, { value: 'videoType.food', text: 'Video Makanan' }, { value: 'videoType.historical', text: 'Rekonstruksi Sejarah' }, { value: 'videoType.abstract', text: 'Video Seni Abstrak' }, { value: 'videoType.fashion', text: 'Video Fesyen' } ],
                    visualStyle: [ { value: 'visualStyle.none', text: 'Pilih Gaya Visual' }, { value: 'visualStyle.cinematic', text: 'Sinematik' }, { value: 'visualStyle.realistic', text: 'Realistis' }, { value: 'visualStyle.hyperRealistic', text: 'Hiper Realistis' }, { value: 'visualStyle.anime', text: 'Estetika Anime / Manga' }, { value: 'visualStyle.magical', text: 'Magis / Fantasi' }, { value: 'visualStyle.action', text: 'Aksi' }, { value: 'visualStyle.futuristic', text: 'Futuristik / Fiksi Ilmiah' }, { value: 'visualStyle.surreal', text: 'Surealis / Psikedelik' }, { value: 'visualStyle.noir', text: 'Hitam Putih / Noir' }, { value: 'visualStyle.retro', text: 'Retro / Vintage' }, { value: 'visualStyle.warm', text: 'Hangat & Lembut' }, { value: 'visualStyle.gritty', text: 'Kasar / Gelap' }, { value: 'visualStyle.dreamlike', text: 'Seperti Mimpi' }, { value: 'visualStyle.sketch', text: 'Sketsa / Lukisan Tangan' }, { value: 'visualStyle.pixel', text: 'Seni Piksel (Pixel Art)' }, { value: 'visualStyle.stopMotion', text: 'Stop Motion / Claymation' }, { value: 'visualStyle.vaporwave', text: 'Estetika Vaporwave / Lo-fi' }, { value: 'visualStyle.gothic', text: 'Gaya Gothik' }, { value: 'visualStyle.macro', text: 'Fotografi Makro' }, { value: 'visualStyle.infrared', text: 'Fotografi Inframerah' }, { value: 'visualStyle.papercraft', text: 'Seni Kertas (Papercraft)' }, { value: 'visualStyle.cyberpunk', text: 'Cyberpunk' }, { value: 'visualStyle.steampunk', text: 'Steampunk' }, { value: 'visualStyle.wesanderson', text: 'Gaya Wes Anderson' } ],
                    soundType: [ { value: 'soundType.none', text: 'Pilih Jenis Suara (Opsional)' }, { value: 'soundType.epicOrchestral', text: 'Musik Orkestra Epik' }, { value: 'soundType.lofi', text: 'Musik Lo-fi Santai' }, { value: 'soundType.ambient', text: 'Suara Ambient / Alam' }, { value: 'soundType.electronic', text: 'Elektronik / Synthwave' }, { value: 'soundType.acoustic', text: 'Akustik / Folk' }, { value: 'soundType.jazz', text: 'Jazz Halus' }, { value: 'soundType.rock', text: 'Rock / Alternatif' }, { value: 'soundType.hiphop', text: 'Hip Hop / R&B' }, { value: 'soundType.voiceover', text: 'Hanya Suara Narasi (Voice Over)' }, { value: 'soundType.silent', text: 'Hening / Tanpa Audio' } ],
                    sceneCount: [ { value: '0', text: 'Pilih Adegan' }, { value: '1', text: '1 Adegan' }, { value: '2', text: '2 Adegan' }, { value: '3', text: '3 Adegan' } ]
                },
                en: {
                    videoType: [ { value: 'videoType.none', text: 'Select Video Type' }, { value: 'videoType.productAd', text: 'Product Ad' }, { value: 'videoType.shortFilm', text: 'Short Film' }, { value: 'videoType.cinematicReels', text: 'Cinematic Reels' }, { value: 'videoType.storytelling', text: 'Storytelling' }, { value: 'videoType.romantic', text: 'Romantic Story' }, { value: 'videoType.musicVideo', text: 'Music Video' }, { value: 'videoType.lyricVideo', text: 'Lyric Video' }, { value: 'videoType.explainer', text: 'Explainer / Education' }, { value: 'videoType.tutorial', text: 'Tutorial / How-to' }, { value: 'videoType.miniDoc', text: 'Mini Documentary' }, { value: 'videoType.trailer', text: 'Trailer / Teaser' }, { value: 'videoType.podcast', text: 'Podcast' }, { value: 'videoType.vlog', text: 'Vlog / Personal' }, { value: 'videoType.timelapse', text: 'Timelapse / Hyperlapse' }, { value: 'videoType.meditation', text: 'Meditation Content' }, { value: 'videoType.dataVis', text: 'Abstract Data Visualization' }, { value: 'videoType.concept', text: 'Concept Presentation' }, { value: 'videoType.food', text: 'Food Video' }, { value: 'videoType.historical', text: 'Historical Reconstruction' }, { value: 'videoType.abstract', text: 'Abstract Art Video' }, { value: 'videoType.fashion', text: 'Fashion Film' } ],
                    visualStyle: [ { value: 'visualStyle.none', text: 'Select Visual Style' }, { value: 'visualStyle.cinematic', text: 'Cinematic' }, { value: 'visualStyle.realistic', text: 'Realistic' }, { value: 'visualStyle.hyperRealistic', text: 'Hyper Realistic' }, { value: 'visualStyle.anime', text: 'Anime / Manga Aesthetic' }, { value: 'visualStyle.magical', text: 'Magical / Fantasy' }, { value: 'visualStyle.action', text: 'Action' }, { value: 'visualStyle.futuristic', text: 'Futuristic / Sci-Fi' }, { value: 'visualStyle.surreal', text: 'Surreal / Psychedelic' }, { value: 'visualStyle.noir', text: 'Black & White / Noir' }, { value: 'visualStyle.retro', text: 'Retro / Vintage' }, { value: 'visualStyle.warm', text: 'Warm & Soft' }, { value: 'visualStyle.gritty', text: 'Gritty / Dark' }, { value: 'visualStyle.dreamlike', text: 'Dreamlike' }, { value: 'visualStyle.sketch', text: 'Hand-drawn / Sketch' }, { value: 'visualStyle.pixel', text: 'Pixel Art' }, { value: 'visualStyle.stopMotion', text: 'Stop Motion / Claymation' }, { value: 'visualStyle.vaporwave', text: 'Vaporwave / Lo-fi Aesthetic' }, { value: 'visualStyle.gothic', text: 'Gothic Style' }, { value: 'visualStyle.macro', text: 'Macro Photography' }, { value: 'visualStyle.infrared', text: 'Infrared Photography' }, { value: 'visualStyle.papercraft', text: 'Papercraft Art' }, { value: 'visualStyle.cyberpunk', text: 'Cyberpunk' }, { value: 'visualStyle.steampunk', text: 'Steampunk' }, { value: 'visualStyle.wesanderson', text: 'Wes Anderson Style' } ],
                    soundType: [ { value: 'soundType.none', text: 'Select Sound Type (Optional)' }, { value: 'soundType.epicOrchestral', text: 'Epic Orchestral Music' }, { value: 'soundType.lofi', text: 'Relaxing Lo-fi Music' }, { value: 'soundType.ambient', text: 'Ambient / Nature Sounds' }, { value: 'soundType.electronic', text: 'Electronic / Synthwave' }, { value: 'soundType.acoustic', text: 'Acoustic / Folk' }, { value: 'soundType.jazz', text: 'Smooth Jazz' }, { value: 'soundType.rock', text: 'Rock / Alternative' }, { value: 'soundType.hiphop', text: 'Hip Hop / R&B' }, { value: 'soundType.voiceover', text: 'Narration Voice Over Only' }, { value: 'soundType.silent', text: 'Silent / No Audio' } ],
                    sceneCount: [ { value: '0', text: 'Select Scenes' }, { value: '1', text: '1 Scene' }, { value: '2', text: '2 Scenes' }, { value: '3', text: '3 Scenes' } ]
                }
            };

            // --- DOM Selectors ---
            const DOMElements = {
                body: document.body,
                loginCard: document.getElementById('login-card'),
                generatorContent: document.getElementById('generator-content'),
                loginForm: document.getElementById('login-form'),
                passwordInput: document.getElementById('password'),
                togglePassword: document.getElementById('toggle-password'),
                storyIdea: document.getElementById('story-idea'),
                videoType: document.getElementById('videoType'),
                visualStyle: document.getElementById('visualStyle'),
                soundType: document.getElementById('soundType'),
                sceneCount: document.getElementById('scene-count'),
                resetFormBtn: document.getElementById('reset-form-btn'),
                aiDirectorBtn: document.getElementById('ai-director-btn'),
                storyboardContainer: document.getElementById('storyboard-container'),
                finalPromptStepContainer: document.getElementById('final-prompt-step-container'),
                generateAllPromptsBtn: document.getElementById('generate-all-prompts-btn'),
                generateJsonBtn: document.getElementById('generate-json-btn'),
                finalResultsArea: document.getElementById('final-results-area'),
                finalPromptsContainer: document.getElementById('final-prompts-container'),
                jsonAccordionContainer: document.getElementById('json-accordion-container'),
                hamburgerBtn: document.getElementById('hamburger-btn'),
                offcanvasMenu: document.getElementById('offcanvas-menu'),
                offcanvasBackdrop: document.getElementById('offcanvas-backdrop'),
                offcanvasCloseBtn: document.getElementById('offcanvas-close-btn'),
                historyModal: document.getElementById('history-modal'),
                apiKeyModal: document.getElementById('api-key-modal'),
                alertModal: document.getElementById('alert-modal'),
                confirmationModal: document.getElementById('confirmation-modal'),
                allModals: document.querySelectorAll('.fixed.inset-0'),
                themeBtnDesktop: document.getElementById('theme-btn-desktop'),
                themeBtnMobile: document.getElementById('theme-btn-mobile'),
                langBtnDesktop: document.getElementById('lang-btn-desktop'),
                langBtnMobileIcon: document.getElementById('lang-btn-mobile-icon'),
                historyBtnMobileIcon: document.getElementById('history-btn-mobile-icon'),
                apiKeyBtnDesktop: document.getElementById('api-key-btn-desktop'),
                apiKeyBtnMobileIcon: document.getElementById('api-key-btn-mobile-icon'),
                logoutBtnDesktop: document.getElementById('logout-btn-desktop'),
                logoutBtnMobileMenu: document.getElementById('logout-btn-mobile-menu'),
                // API Modal Elements
                apiSourceSystem: document.getElementById('api-source-system'),
                apiSourcePersonal: document.getElementById('api-source-personal'),
                personalApiDetails: document.getElementById('personal-api-details'),
                systemApiNote: document.getElementById('system-api-note'),
                apiKeyInput: document.getElementById('api-key-input'),
                toggleApiKeyVisibility: document.getElementById('toggle-api-key-visibility'),
                deleteApiKeyBtn: document.getElementById('delete-api-key-btn'),
                apiModalSaveBtn: document.getElementById('api-modal-save-btn'),
                apiModalCancelBtn: document.getElementById('api-modal-cancel-btn'),
                apiKeyInstructionsDesktop: document.getElementById('api-key-instructions-desktop'),
                apiKeyInstructionsMobile: document.getElementById('api-key-instructions-mobile'),
            };

            // --- UTILITY & HELPER FUNCTIONS ---
            const getUIText = (key, ...args) => {
                const translation = UI_STRINGS[AppState.currentLang][key];
                return typeof translation === 'function' ? translation(...args) : translation;
            };
            
            const openModal = (modal) => {
                const content = modal.querySelector('.card, .panel');
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                content?.classList.remove('animate__zoomOut', 'animate__fadeOut');
                content?.classList.add('animate__zoomIn', 'animate__faster');
            };

            const closeModal = (modal) => {
                const content = modal.querySelector('.card, .panel');
                content?.classList.remove('animate__zoomIn');
                content?.classList.add('animate__zoomOut', 'animate__faster');
                const handleAnimationEnd = () => {
                    modal.classList.add('hidden');
                    content?.removeEventListener('animationend', handleAnimationEnd);
                };
                content?.addEventListener('animationend', handleAnimationEnd);
            };
            
            const showAlert = (message, type = 'info') => {
                const typeMap = {
                    success: { titleKey: 'alertSuccessTitle', icon: 'fa-check-circle', color: 'bg-[var(--theme-success)]', btn: 'btn-secondary' },
                    error: { titleKey: 'alertErrorTitle', icon: 'fa-times-circle', color: 'bg-[var(--theme-error)]', btn: 'btn-danger' },
                    info: { titleKey: 'alertInfoTitle', icon: 'fa-info-circle', color: 'bg-[var(--theme-accent-2)]', btn: 'btn-primary' }
                };
                const config = typeMap[type];

                document.getElementById('alert-title').textContent = getUIText(config.titleKey);
                document.getElementById('alert-message').textContent = message;
                document.getElementById('alert-icon-container').className = `w-16 h-16 rounded-full mx-auto flex items-center justify-center mb-4 ${config.color}`;
                document.getElementById('alert-icon').className = `fas text-4xl text-white ${config.icon}`;
                const closeBtn = document.getElementById('alert-close-btn');
                closeBtn.textContent = getUIText('alertCloseButton');
                closeBtn.className = `btn w-full ${config.btn}`;
                
                openModal(DOMElements.alertModal);
            };
            
            const showConfirmation = (titleKey, messageKey, onConfirm) => {
                document.getElementById('confirmation-title').textContent = getUIText(titleKey);
                document.getElementById('confirmation-message').textContent = getUIText(messageKey);
                const yesBtn = document.getElementById('confirm-yes-btn');
                const noBtn = document.getElementById('confirm-no-btn');
                
                yesBtn.textContent = getUIText('confirmYes');
                noBtn.textContent = getUIText('confirmNo');

                const newYesBtn = yesBtn.cloneNode(true);
                yesBtn.parentNode.replaceChild(newYesBtn, yesBtn);
                newYesBtn.onclick = () => {
                    onConfirm();
                    closeModal(DOMElements.confirmationModal);
                };
                openModal(DOMElements.confirmationModal);
            };

            // --- CORE APPLICATION LOGIC ---
            const applyTheme = (theme) => {
                AppState.currentTheme = theme;
                localStorage.setItem('promptique_theme', theme);
                
                const sunIcon = '<i class="fas fa-sun fa-fw text-lg"></i>';
                const moonIcon = '<i class="fas fa-moon fa-fw text-lg"></i>';

                if (theme === 'light') {
                    DOMElements.body.classList.add('light-theme');
                    DOMElements.themeBtnDesktop.innerHTML = sunIcon;
                    DOMElements.themeBtnMobile.querySelector('i').className = 'fas fa-sun fa-fw text-lg w-6 text-center';
                } else {
                    DOMElements.body.classList.remove('light-theme');
                    DOMElements.themeBtnDesktop.innerHTML = moonIcon;
                    DOMElements.themeBtnMobile.querySelector('i').className = 'fas fa-moon fa-fw text-lg w-6 text-center';
                }
                
                const accentColor = getComputedStyle(document.documentElement).getPropertyValue('--theme-accent-2').trim();
                const encodedColor = encodeURIComponent(accentColor);
                document.querySelectorAll('.form-select').forEach(el => {
                    el.style.backgroundImage = `url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='${encodedColor}' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e")`;
                });
            };
            
            const updateUI = () => {
                const lang = AppState.currentLang;
                document.documentElement.lang = lang;
                
                document.querySelectorAll('[data-ui-key]').forEach(el => {
                    const key = el.dataset.uiKey;
                    if (UI_STRINGS[lang][key]) {
                        // Check if it's an array for instructions
                        if (Array.isArray(UI_STRINGS[lang][key])) {
                            el.innerHTML = UI_STRINGS[lang][key].map(item => `<li>${item}</li>`).join('');
                        } else {
                            el.textContent = getUIText(key);
                        }
                    }
                });
                
                document.querySelectorAll('[data-ui-key-placeholder]').forEach(el => {
                    const key = el.dataset.uiKeyPlaceholder;
                    if (UI_STRINGS[lang][key]) el.placeholder = getUIText(key);
                });

                document.querySelectorAll('[data-ui-key-title]').forEach(el => {
                    const key = el.dataset.uiKeyTitle;
                    if(UI_STRINGS[lang][key]) el.title = getUIText(key);
                });
                
                DOMElements.langBtnDesktop.querySelector('span').textContent = lang.toUpperCase();
                DOMElements.langBtnMobileIcon.querySelector('span').textContent = lang.toUpperCase();

                ['videoType', 'visualStyle', 'soundType', 'sceneCount'].forEach(id => {
                    const select = DOMElements[id];
                    if (select) {
                        const currentVal = select.value;
                        select.innerHTML = DROPDOWN_OPTIONS[lang][id]
                            .map(opt => `<option value="${opt.value}">${opt.text}</option>`)
                            .join('');
                        if (currentVal) select.value = currentVal;
                    }
                });

                // Update API instructions based on language
                const instructionsDesktop = getUIText('apiKeyInstructionsDesktop');
                DOMElements.apiKeyInstructionsDesktop.innerHTML = instructionsDesktop.map(item => `<li>${item}</li>`).join('');
                const instructionsMobile = getUIText('apiKeyInstructionsMobile');
                DOMElements.apiKeyInstructionsMobile.innerHTML = instructionsMobile.map(item => `<li>${item}</li>`).join('');

                renderStoryboard();
                renderFinalPrompts();
            };

            const setLoginState = (loggedIn) => {
                AppState.isLoggedIn = loggedIn;
                if (loggedIn) {
                    DOMElements.loginCard.classList.add('hidden');
                    DOMElements.generatorContent.classList.remove('hidden');
                    DOMElements.logoutBtnDesktop.classList.remove('hidden');
                    DOMElements.logoutBtnMobileMenu.classList.remove('hidden');
                } else {
                    DOMElements.loginCard.classList.remove('hidden');
                    DOMElements.generatorContent.classList.add('hidden');
                    localStorage.removeItem('promptique_session');
                    DOMElements.logoutBtnDesktop.classList.add('hidden');
                    DOMElements.logoutBtnMobileMenu.classList.add('hidden');
                    DOMElements.passwordInput.value = ''; // Reset password on logout
                }
            };

            async function callGeminiAPI(params, onFallback = () => {}) {
                let apiKeyToUse = (AppState.apiKeySource === 'personal' && AppState.personalApiKey) ? AppState.personalApiKey : SYSTEM_API_KEY;
                let isUsingPersonalKey = AppState.apiKeySource === 'personal' && !!AppState.personalApiKey;

                if (!apiKeyToUse) {
                    showAlert(getUIText('apiKeyNote'), 'error');
                    resetAndOpenApiKeyModal();
                    return null;
                }

                const MAX_RETRIES = 3;
                let attempt = 0;

                while (attempt < MAX_RETRIES) {
                    try {
                        const ai = new GoogleGenAI({ apiKey: apiKeyToUse });
                        const response = await ai.models.generateContent(params);

                        if (params.config?.responseMimeType === 'application/json') {
                            const text = response.text.trim();
                            const jsonMatch = text.match(/```json\s*([\s\S]*?)\s*```|({[\s\S]*})/);
                            if (jsonMatch) {
                                try {
                                    return JSON.parse(jsonMatch[1] || jsonMatch[2]);
                                } catch (e) { /* ignore and try parsing the whole text */ }
                            }
                            try {
                                return JSON.parse(text);
                            } catch (e) {
                                console.error("AI did not return valid JSON, but was expected to.", text);
                                throw new Error("AI did not return valid JSON content.");
                            }
                        }
                        return response.text;
                    } catch (e) {
                        const errorMessage = e.toString();
                        console.error(`Error calling Gemini API (attempt ${attempt + 1} with ${isUsingPersonalKey ? 'personal' : 'system'} key):`, errorMessage);
                        
                        const isRateLimit = errorMessage.includes('429');
                        const isAuthError = errorMessage.includes('400') || errorMessage.includes('403');

                        // Check for fallback condition: personal key failed with a specific error
                        if (isUsingPersonalKey && (isRateLimit || isAuthError)) {
                            console.log("Personal API key failed. Falling back to system API.");
                            apiKeyToUse = SYSTEM_API_KEY;
                            isUsingPersonalKey = false;
                            attempt = 0; // Reset retries for the system key
                            onFallback('system'); // Fire the callback to update UI
                            // Yield to the browser's event loop to allow the UI to repaint before the next API call.
                            await new Promise(resolve => setTimeout(resolve, 10));
                            continue; // Retry immediately with the system key
                        }

                        // Standard retry logic with exponential backoff for the current key
                        if (attempt < MAX_RETRIES - 1) {
                            const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                            console.log(`Retrying with same key in ${delay.toFixed(0)}ms...`);
                            await new Promise(resolve => setTimeout(resolve, delay));
                            attempt++;
                        } else {
                            // Max retries reached for the current key (or it's a non-retryable error)
                            let userMessage = getUIText('promptGenerationFailed');
                            if (isRateLimit) {
                                userMessage = 'Failed to call the Gemini API, quota exceeded: you have reached the daily limit of requests for this model. Please select a different model, or try again tomorrow.';
                            } else if (errorMessage.includes('valid JSON')) {
                                userMessage = 'The AI returned an invalid response. Please try again.';
                            }
                            showAlert(userMessage, 'error');
                            return null;
                        }
                    }
                }
                return null; // Should not be reached
            }

            const renderStoryboard = () => {
                const container = DOMElements.storyboardContainer;
                container.innerHTML = '';
                if (!AppState.storyboardData) return;

                const { key_characters, scenes } = AppState.storyboardData;

                const storyboardHtml = `
                    <section id="step-2" class="card p-6 sm:p-8 animate__animated animate__fadeInUp animate__faster">
                        <div>
                            <p class="text-sm font-bold tracking-wider uppercase text-[var(--theme-accent-2)]" data-ui-key="step2Label"></p>
                            <h3 data-ui-key="step2Title" class="text-2xl font-bold gradient-text"></h3>
                        </div>
                        <p data-ui-key="step2Subtitle" class="text-[var(--theme-text-secondary)] mt-2 mb-8"></p>
                        
                        <!-- Key Characters -->
                        ${key_characters && key_characters.length > 0 ? `
                            <div id="key-characters-section" class="mb-8">
                                <div class="flex justify-between items-center mb-4">
                                    <h4 class="flex items-center text-xl font-bold gradient-text">
                                        <i class="fas fa-users mr-3"></i>
                                        <span data-ui-key="keyCharactersLabel">${getUIText('keyCharactersLabel')}</span>
                                    </h4>
                                    <button id="edit-characters-btn" class="btn btn-secondary text-sm py-1 px-3">
                                        <i class="fas fa-pencil-alt"></i><span>${getUIText('editButton')}</span>
                                    </button>
                                </div>
                                <div id="key-characters-content" class="space-y-4">
                                    ${key_characters.map((char, index) => `
                                        <div class="key-character-item border border-transparent p-2 rounded-lg" data-char-index="${index}">
                                            <p class="identifier-text font-semibold text-[var(--theme-text-primary)]">${char.identifier}</p>
                                            <p class="description-text text-sm text-[var(--theme-text-secondary)]">${char.description}</p>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}

                        <!-- Scenes -->
                        <div id="scenes-list" class="space-y-6">
                             ${scenes.map((scene, index) => `
                                <div id="scene-card-${index}" class="border border-[var(--theme-border)] rounded-lg p-4">
                                    <div class="flex justify-between items-start flex-wrap">
                                        <div class="w-full md:w-auto">
                                            <h4 class="text-xl font-bold text-[var(--theme-accent-2)]">${getUIText('sceneLabel')} ${scene.scene_number}</h4>
                                            <p class="text-sm text-[var(--theme-text-secondary)]">${scene.duration_seconds} ${getUIText('secondsUnit')}</p>
                                        </div>
                                        <div class="w-full md:w-auto flex items-center gap-2 mt-4 md:mt-0">
                                            <button class="btn btn-neutral lang-toggle-btn text-sm py-1 px-3" data-scene-index="${index}">
                                                <span class="font-bold">${scene.currentLang === 'id' ? 'EN' : 'ID'}</span>
                                            </button>
                                            <button class="btn btn-secondary edit-scene-btn text-sm py-1 px-3" data-scene-index="${index}">
                                                <i class="fas fa-pencil-alt"></i><span>${getUIText('editButton')}</span>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="scene-description-content space-y-2 text-sm mt-4">
                                        <p data-desc-type="visual"><strong class="font-semibold text-[var(--theme-text-primary)]">${getUIText('visualDescriptionLabel')}:</strong> <span class="text-[var(--theme-text-secondary)]">${scene.visual[scene.currentLang]}</span></p>
                                        <p data-desc-type="camera"><strong class="font-semibold text-[var(--theme-text-primary)]">${getUIText('cameraDescriptionLabel')}:</strong> <span class="text-[var(--theme-text-secondary)]">${scene.camera[scene.currentLang]}</span></p>
                                        <p data-desc-type="audio"><strong class="font-semibold text-[var(--theme-text-primary)]">${getUIText('audioDescriptionLabel')}:</strong> <span class="text-[var(--theme-text-secondary)]">${scene.audio[scene.currentLang]}</span></p>
                                        <p data-desc-type="lighting"><strong class="font-semibold text-[var(--theme-text-primary)]">${getUIText('lightingLabel')}:</strong> <span class="text-[var(--theme-text-secondary)]">${scene.lighting[scene.currentLang]}</span></p>
                                        <p data-desc-type="room"><strong class="font-semibold text-[var(--theme-text-primary)]">${getUIText('roomLabel')}:</strong> <span class="text-[var(--theme-text-secondary)]">${scene.room[scene.currentLang]}</span></p>
                                        <p data-desc-type="elements"><strong class="font-semibold text-[var(--theme-text-primary)]">${getUIText('elementLabel')}:</strong> <span class="text-[var(--theme-text-secondary)]">${(scene.elements[scene.currentLang] || []).join(', ')}</span></p>
                                        <p data-desc-type="motion"><strong class="font-semibold text-[var(--theme-text-primary)]">${getUIText('motionLabel')}:</strong> <span class="text-[var(--theme-text-secondary)]">${scene.motion[scene.currentLang]}</span></p>
                                        <p data-desc-type="ending"><strong class="font-semibold text-[var(--theme-text-primary)]">${getUIText('endingLabel')}:</strong> <span class="text-[var(--theme-text-secondary)]">${scene.ending[scene.currentLang]}</span></p>
                                        <p data-desc-type="keywords"><strong class="font-semibold text-[var(--theme-text-primary)]">${getUIText('keywordLabel')}:</strong> <span class="text-[var(--theme-text-secondary)]">${(scene.keywords[scene.currentLang] || []).join(', ')}</span></p>
                                        <p data-desc-type="negative_prompt"><strong class="font-semibold text-[var(--theme-text-primary)]">${getUIText('negativePromptLabel')}:</strong> <span class="text-[var(--theme-text-secondary)]">${(scene.negative_prompt[scene.currentLang] || []).join(', ')}</span></p>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </section>
                `;
                container.innerHTML = storyboardHtml;
                // Manually re-translate the static parts of the new section
                container.querySelector('[data-ui-key="step2Label"]').textContent = getUIText('step2Label');
                container.querySelector('[data-ui-key="step2Title"]').textContent = getUIText('step2Title');
                container.querySelector('[data-ui-key="step2Subtitle"]').textContent = getUIText('step2Subtitle');

                DOMElements.finalPromptStepContainer.classList.remove('hidden');
                DOMElements.generateAllPromptsBtn.disabled = false;
                DOMElements.generateJsonBtn.disabled = false;
                DOMElements.finalResultsArea.classList.add('hidden');
            };
            
            const renderFinalPrompts = () => {
                const container = DOMElements.finalPromptsContainer;
                container.innerHTML = '';
                if (!AppState.storyboardData) return;

                let hasAnyPrompts = AppState.storyboardData.scenes.some(s => s.generatedPrompts);
                if (!hasAnyPrompts) {
                    container.innerHTML = '';
                    return;
                }

                AppState.storyboardData.scenes.forEach((scene, index) => {
                    if (!scene.generatedPrompts) return;

                    const prompts = scene.generatedPrompts;
                    const sceneResultHtml = `
                    <div class="border border-[var(--theme-border)] rounded-lg overflow-hidden">
                        <button class="accordion-toggle flex justify-between items-center w-full p-4 bg-[var(--theme-panel-bg)] hover:bg-[var(--theme-border)]/20 transition-colors" data-scene-index="${index}">
                            <span class="font-bold text-lg text-[var(--theme-accent-2)]">${getUIText('sceneLabel')} ${scene.scene_number}</span>
                            <i class="fas fa-chevron-down transition-transform"></i>
                        </button>
                        <div class="accordion-content bg-[var(--theme-bg)]">
                            <div class="prompt-tabs border-b border-[var(--theme-border)]">
                                <button class="tab-btn active" data-tab-target="tab-final-combined-${index}" data-scene-index="${index}">${getUIText('combinedPromptTab')}</button>
                                <button class="tab-btn" data-tab-target="tab-final-image-motion-${index}" data-scene-index="${index}">${getUIText('imageMotionPromptTab')}</button>
                            </div>
                            <div class="tab-content-container mt-4">
                                <div id="tab-final-combined-${index}" class="tab-content space-y-4">
                                    <p class="text-sm text-[var(--theme-text-secondary)]">${getUIText('combinedPromptDescription')}</p>
                                    <div>
                                        <textarea class="form-textarea text-xs h-32" readonly>${prompts.combinedPrompt}</textarea>
                                        <button class="btn btn-primary copy-prompt-btn text-sm py-2 px-4 w-full mt-2" data-prompt-type="combinedPrompt" data-scene-index="${index}">
                                            <i class="fas fa-copy"></i><span>${getUIText('copyCombinedPrompt', scene.scene_number)}</span>
                                        </button>
                                    </div>
                                </div>
                                <div id="tab-final-image-motion-${index}" class="tab-content hidden space-y-6">
                                    <p class="text-sm text-[var(--theme-text-secondary)]">${getUIText('imageMotionPromptDescription')}</p>
                                    <div class="space-y-2">
                                        <label class="form-label !mb-1 text-sm">${getUIText('imagePromptStepLabel')}</label>
                                        <textarea class="form-textarea text-xs h-24" readonly>${prompts.imagePrompt}</textarea>
                                        <button class="btn btn-secondary copy-prompt-btn text-xs py-1 px-3" data-prompt-type="imagePrompt" data-scene-index="${index}">
                                            <i class="fas fa-copy"></i><span>${getUIText('copyImagePrompt')}</span>
                                        </button>
                                    </div>
                                    <div class="space-y-2">
                                        <label class="form-label !mb-1 text-sm">${getUIText('animationPromptStepLabel')}</label>
                                        <textarea class="form-textarea text-xs h-24" readonly>${prompts.animationPrompt}</textarea>
                                        <button class="btn btn-secondary copy-prompt-btn text-xs py-1 px-3" data-prompt-type="animationPrompt" data-scene-index="${index}">
                                            <i class="fas fa-copy"></i><span>${getUIText('copyAnimationPrompt')}</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    `;
                    container.insertAdjacentHTML('beforeend', sceneResultHtml);
                });
            };

            const getHistory = () => JSON.parse(localStorage.getItem('promptique_history')) || [];
            const saveHistory = (history) => localStorage.setItem('promptique_history', JSON.stringify(history));
            
            const renderHistory = () => {
                const history = getHistory();
                const contentEl = document.getElementById('history-content');
                contentEl.innerHTML = '';
                if (history.length === 0) {
                    contentEl.innerHTML = `<div class="text-center text-[var(--theme-text-secondary)] py-10"><i class="fas fa-box-open fa-3x mb-4"></i><p>${getUIText('alertHistoryEmpty')}</p></div>`;
                    return;
                }
                history.reverse().forEach(entry => {
                    const idea = (typeof entry === 'object' && entry.idea) ? entry.idea : entry;
                    
                    const historyItemContainer = document.createElement('div');
                    historyItemContainer.className = 'group flex items-center justify-between w-full text-left p-3 rounded-lg hover:bg-[var(--theme-border)]/20 transition-colors duration-200';

                    const ideaButton = document.createElement('button');
                    ideaButton.className = 'flex-grow text-left truncate pr-2';
                    ideaButton.textContent = idea;
                    ideaButton.onclick = () => {
                        DOMElements.storyIdea.value = idea;
                        closeModal(DOMElements.historyModal);
                    };
                    historyItemContainer.appendChild(ideaButton);

                    if (typeof entry === 'object' && entry.date) {
                        const deleteButton = document.createElement('button');
                        deleteButton.className = 'flex-shrink-0 text-[var(--theme-text-secondary)] hover:text-[var(--theme-error)] transition-opacity';
                        deleteButton.title = getUIText('deleteButton');
                        deleteButton.innerHTML = '<i class="fas fa-trash fa-sm"></i>';
                        deleteButton.onclick = (e) => {
                            e.stopPropagation();
                            const currentHistory = getHistory();
                            const newHistory = currentHistory.filter(item => item.date !== entry.date);
                            saveHistory(newHistory);
                            renderHistory();
                        };
                        historyItemContainer.appendChild(deleteButton);
                    }
                    contentEl.appendChild(historyItemContainer);
                });
            };

            const openOffCanvas = () => {
                const menu = DOMElements.offcanvasMenu;
                if (!menu) return;
                menu.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
                setTimeout(() => {
                    menu.classList.add('open');
                }, 10);
            };

            const closeOffCanvas = () => {
                const menu = DOMElements.offcanvasMenu;
                if (!menu) return;
                menu.classList.remove('open');
                document.body.style.overflow = '';
                const panel = menu.querySelector('#offcanvas-menu-panel');
                if (!panel) return;

                const onTransitionEnd = () => {
                    menu.classList.add('hidden');
                    panel.removeEventListener('transitionend', onTransitionEnd);
                };
                panel.addEventListener('transitionend', onTransitionEnd);
            };

            // --- EVENT HANDLERS ---
            const handleLogin = (e) => {
                e.preventDefault();
                if (DOMElements.passwordInput.value === 'promptique852#') {
                    const now = new Date().getTime();
                    localStorage.setItem('promptique_session', now.toString());
                    setLoginState(true);
                } else {
                    showAlert(getUIText('loginFailed'), 'error');
                    DOMElements.passwordInput.value = ''; // Reset password on failed login
                }
            };

            const handleLogout = () => { showConfirmation('confirmLogoutTitle', 'confirmLogoutMessage', () => { setLoginState(false); showAlert(getUIText('alertLoggedOut'), 'success'); }); };
            const handleLanguageToggle = () => { AppState.currentLang = AppState.currentLang === 'id' ? 'en' : 'id'; localStorage.setItem('promptique_lang', AppState.currentLang); updateUI(); };
            const handleThemeToggle = () => { applyTheme(AppState.currentTheme === 'dark' ? 'light' : 'dark'); };

            const handleResetForm = () => {
                DOMElements.storyIdea.value = '';
                DOMElements.videoType.selectedIndex = 0;
                DOMElements.visualStyle.selectedIndex = 0;
                DOMElements.soundType.selectedIndex = 0;
                DOMElements.sceneCount.selectedIndex = 0;
                AppState.storyboardData = null;
                DOMElements.storyboardContainer.innerHTML = '';
                DOMElements.finalPromptStepContainer.classList.add('hidden');
                DOMElements.finalResultsArea.classList.add('hidden');
                DOMElements.finalPromptsContainer.innerHTML = '';
                DOMElements.jsonAccordionContainer.innerHTML = '';
                DOMElements.generateAllPromptsBtn.disabled = true;
                DOMElements.generateJsonBtn.disabled = true;
                showAlert(getUIText('alertFormReset'), 'info');
            };

            const handleAIDirector = async () => {
                if (!DOMElements.storyIdea.value.trim()) { showAlert(getUIText('alertIdeaEmpty'), 'error'); return; }
                if (DOMElements.videoType.value === 'videoType.none') { showAlert(getUIText('alertVideoTypeEmpty'), 'error'); return; }
                if (DOMElements.visualStyle.value === 'visualStyle.none') { showAlert(getUIText('alertVisualStyleEmpty'), 'error'); return; }
                if (DOMElements.sceneCount.value === '0') { showAlert(getUIText('alertSceneCountEmpty'), 'error'); return; }

                const btn = DOMElements.aiDirectorBtn;
                btn.disabled = true;
                const btnText = btn.querySelector('#ai-btn-text');
                const loaderSpan = btn.querySelector('#ai-btn-loader');
                btnText.classList.add('hidden');
                
                const usePersonalAI = AppState.apiKeySource === 'personal' && AppState.personalApiKey;
                const loaderText = usePersonalAI ? getUIText('loaderUserAI') : getUIText('loaderSystemAI');
                loaderSpan.innerHTML = `<div class="flex items-center justify-center gap-2"><span class="loader"></span><span>${loaderText}</span></div>`;
                loaderSpan.classList.remove('hidden');

                DOMElements.storyboardContainer.innerHTML = '';
                DOMElements.finalPromptStepContainer.classList.add('hidden');
                DOMElements.finalResultsArea.classList.add('hidden');

                const onFallback = (newSource) => {
                    if (newSource === 'system') {
                        const systemLoaderText = getUIText('loaderSystemAI');
                        loaderSpan.innerHTML = `<div class="flex items-center justify-center gap-2"><span class="loader"></span><span>${systemLoaderText}</span></div>`;
                    }
                };

                const storyIdea = DOMElements.storyIdea.value.trim();
                const videoTypeText = DOMElements.videoType.options[DOMElements.videoType.selectedIndex].text;
                const visualStyleText = DOMElements.visualStyle.options[DOMElements.visualStyle.selectedIndex].text;
                const soundType = DOMElements.soundType.value;
                const soundTypeText = DOMElements.soundType.options[DOMElements.soundType.selectedIndex].text;
                const sceneCount = DOMElements.sceneCount.value;
                
                const validationSystemInstruction = "Analyze the following user input. Determine if it is a coherent story idea or just gibberish/random characters. Respond with only 'valid' or 'incoherent'.";
                const validationResponse = await callGeminiAPI({ model: 'gemini-2.5-flash', contents: `Is this a coherent idea? "${storyIdea}"`, config: { systemInstruction: validationSystemInstruction }}, onFallback);

                if (validationResponse && validationResponse.toLowerCase().includes('incoherent')) {
                    showAlert(getUIText('alertIdeaIncoherent'), 'error');
                    btn.disabled = false;
                    btnText.classList.remove('hidden');
                    loaderSpan.classList.add('hidden');
                    return;
                }

                const systemInstruction = "You are a professional storyboard artist and scriptwriter creating a detailed video plan. You MUST obey these critical rules:\n1.  **Foundation: Key Characters:** Your first task is to analyze the user's concept to identify all recurring characters, subjects, or key objects. Create a 'key_characters' list. For each item, provide a highly specific and detailed physical description. This is the absolute source of truth for all visuals.\n2.  **Strict Scene Consistency:** When creating each scene's 'visual' description, you MUST build the description using the *exact, verbatim physical description* from the 'key_characters' list for any character mentioned. This is a non-negotiable rule. Do not summarize, alter, or creatively interpret these descriptions.\n3.  **Style & Duration Adherence:** The user's 'Video Type' and 'Visual Style' are CRITICAL. The 'Visual Style' MUST be intensely reflected in the 'visual' description of every scene. Each scene must be designed for an 8-second duration, so the action must be concise.\n4.  **Integrated Dialogue:** Any spoken dialogue MUST be integrated directly into the `ending` field. For example: `The scene ends with the detective looking up and saying, \"I've found it.\"`. If there is no dialogue for a scene, the `ending` field should only describe the concluding action.\n5.  **Language:** Generate all text content (for key_characters and all scene fields) in Indonesian.";
                let userPrompt = `Video Concept: "${storyIdea}"\nNumber of Scenes: ${sceneCount}`;
                if (videoTypeText && videoTypeText !== 'Pilih Jenis Video' && videoTypeText !== 'Select Video Type') userPrompt += `\nVideo Type: ${videoTypeText}`;
                if (visualStyleText && visualStyleText !== 'Pilih Gaya Visual' && visualStyleText !== 'Select Visual Style') userPrompt += `\nVisual Style: ${visualStyleText}`;
                if (soundType && soundType !== 'soundType.none') userPrompt += `\nSound/Music Style: ${soundTypeText}`;
                
                const sceneProperties = {
                    scene_number: { type: Type.INTEGER, description: "The sequential number of the scene." },
                    visual: { type: Type.STRING, description: "Detailed description of the visuals in the scene, fitting an 8-second duration. Must refer to characters/objects using their 'identifier' and implicitly use their detailed descriptions." },
                    camera: { type: Type.STRING, description: "Description of the camera shot, angle, and movement." },
                    audio: { type: Type.STRING, description: "Description of the audio, including music and sound effects." },
                    lighting: { type: Type.STRING, description: "Description of the scene's lighting (e.g., 'dramatic, moody, soft afternoon light')." },
                    room: { type: Type.STRING, description: "Description of the location or room setting." },
                    elements: { type: Type.ARRAY, description: "List of key visual elements or objects present in the scene.", items: { type: Type.STRING } },
                    motion: { type: Type.STRING, description: "Description of the main motion or action in the scene." },
                    ending: { type: Type.STRING, description: "Description of how the 8-second scene concludes, including any spoken dialogue in Indonesian, clearly attributed to the character speaking." },
                    keywords: { type: Type.ARRAY, description: "List of 3-5 important keywords for the scene.", items: { type: Type.STRING } },
                    negative_prompt: { type: Type.ARRAY, description: "List of things to avoid in the visual generation (e.g., 'blurry, ugly, deformed').", items: { type: Type.STRING } }
                };

                const schema = {
                    type: Type.OBJECT,
                    properties: {
                        key_characters: { type: Type.ARRAY, description: "List of main recurring characters, subjects, or key objects with highly detailed descriptions for visual consistency.", items: { type: Type.OBJECT, properties: { identifier: { type: Type.STRING, description: "A short, memorable name like 'The Detective' or 'The Antique Locket'." }, description: { type: Type.STRING, description: "A highly detailed, specific, and consistent physical description (e.g., 'a 20-year-old man with messy blonde hair, blue eyes, and a small scar on his left cheek')." } }, required: ["identifier", "description"] } },
                        scenes: { type: Type.ARRAY, description: "A scene-by-scene storyboard.", items: { type: Type.OBJECT, properties: sceneProperties, required: Object.keys(sceneProperties) } }
                    },
                    required: ["key_characters", "scenes"]
                };

                const generatedStoryboard = await callGeminiAPI(
                    { model: 'gemini-2.5-flash', contents: userPrompt, config: { systemInstruction, responseMimeType: 'application/json', responseSchema: schema }},
                    onFallback
                );

                if (generatedStoryboard && generatedStoryboard.scenes) {
                    const createLangObject = (value) => ({ id: value || '', en: null });
                    const createLangArray = (value) => ({ id: value || [], en: null });

                    const processedScenes = generatedStoryboard.scenes.map(scene => ({
                         ...scene,
                         duration_seconds: 8,
                         visual: createLangObject(scene.visual),
                         camera: createLangObject(scene.camera),
                         audio: createLangObject(scene.audio),
                         lighting: createLangObject(scene.lighting),
                         room: createLangObject(scene.room),
                         elements: createLangArray(scene.elements),
                         motion: createLangObject(scene.motion),
                         ending: createLangObject(scene.ending),
                         keywords: createLangArray(scene.keywords),
                         negative_prompt: createLangArray(scene.negative_prompt),
                         currentLang: 'id'
                    }));
                    AppState.storyboardData = { ...generatedStoryboard, scenes: processedScenes };
                    renderStoryboard();
                    const history = getHistory();
                    if(!history.some(item => (typeof item === 'string' && item === storyIdea) || (typeof item === 'object' && item.idea === storyIdea))){
                        const newHistory = [{idea: storyIdea, date: new Date().toISOString()}, ...history];
                        saveHistory(newHistory.slice(0, 20));
                    }
                    showAlert(getUIText('alertGenerated'), 'success');
                    DOMElements.storyboardContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }

                btn.disabled = false;
                btnText.classList.remove('hidden');
                loaderSpan.classList.add('hidden');
            };
            
            const regenerateStoryboardFromCharacters = async (onFallback) => {
                const storyIdea = DOMElements.storyIdea.value.trim();
                const videoTypeText = DOMElements.videoType.options[DOMElements.videoType.selectedIndex].text;
                const visualStyleText = DOMElements.visualStyle.options[DOMElements.visualStyle.selectedIndex].text;
                const soundType = DOMElements.soundType.value;
                const soundTypeText = DOMElements.soundType.options[DOMElements.soundType.selectedIndex].text;
                const sceneCount = DOMElements.sceneCount.value;
                const updatedCharacters = AppState.storyboardData.key_characters;

                const systemInstruction = "You are a professional storyboard artist revising a storyboard. Your task is to regenerate scenes based on the user's original concept. You MUST strictly and exclusively use the new 'key_characters' list provided as the *absolute and non-negotiable source of truth* for all character and object descriptions. Discard any conflicting character descriptions from the original idea. The descriptions you generate for each scene's visuals must perfectly match what's in the provided list to ensure consistency. Each scene must be 8 seconds long and have all the required fields. Any dialogue must be integrated into the 'ending' field. IMPORTANT: Generate all scene descriptions in Indonesian. The 'key_characters' list is for your reference only and should NOT be in the final JSON output.";

                let userPrompt = `Original Video Concept: "${storyIdea}"\nNumber of Scenes: ${sceneCount}\nVideo Type: ${videoTypeText}\nVisual Style: ${visualStyleText}`;
                if (soundType && soundType !== 'soundType.none') {
                    userPrompt += `\nSound/Music Style: ${soundTypeText}`;
                }
                userPrompt += `\n\n**CRITICAL: Use these exact characters and descriptions for the new scenes:**\n${updatedCharacters.map(c => `- ${c.identifier}: ${c.description}`).join('\n')}`;

                const sceneProperties = {
                    scene_number: { type: Type.INTEGER }, visual: { type: Type.STRING }, camera: { type: Type.STRING }, audio: { type: Type.STRING }, lighting: { type: Type.STRING }, room: { type: Type.STRING }, elements: { type: Type.ARRAY, items: { type: Type.STRING } }, motion: { type: Type.STRING }, ending: { type: Type.STRING }, keywords: { type: Type.ARRAY, items: { type: Type.STRING } }, negative_prompt: { type: Type.ARRAY, items: { type: Type.STRING } }
                };
                const schema = {
                    type: Type.OBJECT,
                    properties: { scenes: { type: Type.ARRAY, description: "A scene-by-scene storyboard, regenerated based on the updated characters.", items: { type: Type.OBJECT, properties: sceneProperties, required: Object.keys(sceneProperties) } } },
                    required: ["scenes"]
                };

                const newStoryboard = await callGeminiAPI(
                    { model: 'gemini-2.5-flash', contents: userPrompt, config: { systemInstruction, responseMimeType: 'application/json', responseSchema: schema }},
                    onFallback
                );

                if (newStoryboard && newStoryboard.scenes) {
                    const createLangObject = (value) => ({ id: value || '', en: null });
                    const createLangArray = (value) => ({ id: value || [], en: null });
                    const processedScenes = newStoryboard.scenes.map(scene => ({ 
                        ...scene,
                         duration_seconds: 8,
                         visual: createLangObject(scene.visual),
                         camera: createLangObject(scene.camera),
                         audio: createLangObject(scene.audio),
                         lighting: createLangObject(scene.lighting),
                         room: createLangObject(scene.room),
                         elements: createLangArray(scene.elements),
                         motion: createLangObject(scene.motion),
                         ending: createLangObject(scene.ending),
                         keywords: createLangArray(scene.keywords),
                         negative_prompt: createLangArray(scene.negative_prompt),
                         currentLang: 'id'
                    }));
                    AppState.storyboardData.scenes = processedScenes;
                    renderStoryboard();
                    renderFinalPrompts();
                    return true;
                } else {
                    console.error("Failed to regenerate storyboard:", newStoryboard);
                    return false;
                }
            };

            const translateScene = async (sceneIndex, targetLang, onFallback) => {
                const scene = AppState.storyboardData.scenes[sceneIndex];
                const sourceLang = targetLang === 'en' ? 'id' : 'en';

                const contentToTranslate = {
                    visual: scene.visual[sourceLang],
                    camera: scene.camera[sourceLang],
                    audio: scene.audio[sourceLang],
                    lighting: scene.lighting[sourceLang],
                    room: scene.room[sourceLang],
                    elements: scene.elements[sourceLang],
                    motion: scene.motion[sourceLang],
                    ending: scene.ending[sourceLang],
                    keywords: scene.keywords[sourceLang],
                    negative_prompt: scene.negative_prompt[sourceLang]
                };

                const systemInstruction = `You are an expert translator. Your task is to translate the JSON object provided by the user from ${sourceLang} to ${targetLang}. You MUST obey this critical rule: For the 'ending' field, translate the descriptive parts but you MUST identify and preserve any text inside quotation marks (e.g., "...") in its original language. For all other fields (string values and strings within arrays), translate them fully. Respond ONLY with the translated JSON object, maintaining the original structure and keys. DO NOT add any explanations or markdown formatting.`;
                
                const schema = {
                    type: Type.OBJECT,
                    properties: {
                        visual: { type: Type.STRING },
                        camera: { type: Type.STRING },
                        audio: { type: Type.STRING },
                        lighting: { type: Type.STRING },
                        room: { type: Type.STRING },
                        elements: { type: Type.ARRAY, items: { type: Type.STRING } },
                        motion: { type: Type.STRING },
                        ending: { type: Type.STRING, description: "The translated ending, with dialogue in quotes preserved in the original language." },
                        keywords: { type: Type.ARRAY, items: { type: Type.STRING } },
                        negative_prompt: { type: Type.ARRAY, items: { type: Type.STRING } }
                    },
                    required: ["visual", "camera", "audio", "lighting", "room", "elements", "motion", "ending", "keywords", "negative_prompt"]
                };

                return await callGeminiAPI(
                    { model: 'gemini-2.5-flash', contents: JSON.stringify(contentToTranslate), config: { systemInstruction, responseMimeType: 'application/json', responseSchema: schema }},
                    onFallback
                );
            };

            const generatePromptForScene = async (sceneIndex, onFallback, characters) => {
                const scene = AppState.storyboardData.scenes[sceneIndex];
                const fieldsToTranslate = ['visual', 'camera', 'audio', 'lighting', 'room', 'elements', 'motion', 'ending', 'keywords', 'negative_prompt'];
                
                const needsTranslation = fieldsToTranslate.some(field => {
                    const value = scene[field];
                    return !value.en || (Array.isArray(value.en) && value.en.length === 0 && value.id.length > 0);
                });

                if (needsTranslation) {
                    const translatedContent = await translateScene(sceneIndex, 'en', onFallback);
                    if (translatedContent) {
                        for (const field of fieldsToTranslate) {
                            if (translatedContent[field] !== undefined) {
                                scene[field].en = translatedContent[field];
                            }
                        }
                    } else {
                        showAlert(`${getUIText('alertTranslationError')} ${getUIText('promptGenerationFailed')}`, 'error');
                        return false;
                    }
                }

                const systemInstruction = "You are an expert prompt engineer for generative AI models. Your output MUST adhere to these non-negotiable rules:\n\n1.  **Language & Style:** The final prompts must be in English. You will be given scene details; all details (visual, camera, etc.) are already in English. However, within the 'ending' field, any dialogue in quotes will be in Indonesian. The user will also provide a 'Visual Style'. This is the most important instruction. ALL of your generated prompts, especially 'imagePrompt' and 'combinedPrompt', MUST strictly and vividly embody this specified 'Visual Style'.\n2.  **Character Consistency:** If a 'KEY CHARACTERS & OBJECTS' list is provided, it is the *only* source for subject descriptions. You MUST inject the *exact, verbatim English descriptions* from this list into your prompts whenever a character or object from that list is mentioned in the scene.\n3.  **Dialogue Handling:** The 'ending' field contains the full concluding description, which may include dialogue in Indonesian inside quotation marks. You MUST incorporate this entire `ending` text into your `combinedPrompt` naturally. For the `imagePrompt` and `animationPrompt`, you MUST NOT include the dialogue.\n4.  **Prompt Generation:** Create a JSON object with three keys: 'combinedPrompt', 'imagePrompt', and 'animationPrompt'.\n    - `'combinedPrompt'`: This is a single, coherent, detailed paragraph for a video AI. Construct it based on all the English scene details provided.\n    - `'imagePrompt'`: A highly detailed prompt for text-to-image, combining `visual`, `elements`, `lighting`, `room`, and the main `Visual Style`. It should be artistic and descriptive. It must NOT include dialogue.\n    - `'animationPrompt'`: A concise prompt to animate the resulting image, describing `motion`, `camera` movement, and `audio`. It must NOT include dialogue from the `ending` text.";

                const videoTypeText = DOMElements.videoType.options[DOMElements.videoType.selectedIndex].text;
                const visualStyleText = DOMElements.visualStyle.options[DOMElements.visualStyle.selectedIndex].text;
                const soundType = DOMElements.soundType.value;
                const soundTypeText = DOMElements.soundType.options[DOMElements.soundType.selectedIndex].text;
                
                let userPrompt = `**CRITICAL CONTEXT:**
                Video Type: ${videoTypeText}
                Visual Style: ${visualStyleText}`;
                if (soundType && soundType !== 'soundType.none') {
                    userPrompt += `\nSound/Music Style: ${soundTypeText}`;
                }

                userPrompt += `\n\n${characters && characters.length > 0 ? `**KEY CHARACTERS & OBJECTS (Source of Truth):**\n${characters.map(c => `- ${c.identifier}: ${c.description}`).join('\n')}\n` : ""}`;

                userPrompt += `**SCENE DETAILS (English, except for quoted dialogue):**
                - Visual: ${scene.visual.en}
                - Camera: ${scene.camera.en}
                - Audio: ${scene.audio.en}
                - Lighting: ${scene.lighting.en}
                - Room: ${scene.room.en}
                - Elements: ${JSON.stringify(scene.elements.en)}
                - Motion: ${scene.motion.en}
                - Ending: ${scene.ending.en}
                - Keywords: ${JSON.stringify(scene.keywords.en)}
                - Negative Prompt: ${JSON.stringify(scene.negative_prompt.en)}
                - Estimated Duration: ${scene.duration_seconds} seconds`;

                const promptSchema = { type: Type.OBJECT, properties: { combinedPrompt: { type: Type.STRING }, imagePrompt: { type: Type.STRING }, animationPrompt: { type: Type.STRING } }, required: ["combinedPrompt", "imagePrompt", "animationPrompt"] };
                
                const generatedPrompts = await callGeminiAPI(
                    { model: 'gemini-2.5-flash', contents: userPrompt, config: { systemInstruction, responseMimeType: 'application/json', responseSchema: promptSchema, temperature: 0.8, topP: 0.95 } },
                    onFallback
                );

                if (generatedPrompts) {
                    // Overwrite the combined prompt to follow the user's new template structure exactly
                    generatedPrompts.combinedPrompt = `Create a video in a ${visualStyleText} style, featuring ${scene.visual.en}. The camera uses ${scene.camera.en}, with ${scene.lighting.en} lighting. The location is ${scene.room.en}. Include visual elements like ${(scene.elements.en || []).join(', ')}. The video motion shows ${scene.motion.en}, and ends with ${scene.ending.en}. Focus on the keywords: ${(scene.keywords.en || []).join(', ')}. Avoid visuals like ${(scene.negative_prompt.en || []).join(', ')}.`;
                    
                    AppState.storyboardData.scenes[sceneIndex].generatedPrompts = generatedPrompts;
                    return true;
                }
                return false;
            };

            const ensureAllPromptsAreGenerated = async (btn) => {
                const btnText = btn.querySelector('span:not(.hidden)');
                const loaderSpan = btn.querySelector('span.hidden');
                
                btn.disabled = true;
                DOMElements.generateAllPromptsBtn.disabled = true;
                DOMElements.generateJsonBtn.disabled = true;

                btnText.classList.add('hidden');
                loaderSpan.classList.remove('hidden');

                let fallbackOccurred = false;
                const onFallback = () => { fallbackOccurred = true; };
                
                const charactersToUse = AppState.storyboardData.key_characters;

                const scenesToProcess = AppState.storyboardData.scenes
                    .map((scene, index) => ({ scene, index }))
                    .filter(item => !item.scene.generatedPrompts);

                let successCount = AppState.storyboardData.scenes.length - scenesToProcess.length;

                for (let i = 0; i < scenesToProcess.length; i++) {
                    const item = scenesToProcess[i];
                    const overallIndex = item.index;
                    const loaderTextContent = getUIText('promptGenerationProgress', successCount + 1, AppState.storyboardData.scenes.length);
                    loaderSpan.innerHTML = `<div class="flex items-center justify-center gap-2"><span class="loader"></span><span>${loaderTextContent}</span></div>`;
                    
                    const success = await generatePromptForScene(overallIndex, onFallback, charactersToUse);
                    if (success) {
                        successCount++;
                    } else {
                        btn.disabled = false;
                        DOMElements.generateAllPromptsBtn.disabled = false;
                        DOMElements.generateJsonBtn.disabled = false;
                        btnText.classList.remove('hidden');
                        loaderSpan.classList.add('hidden');
                        return false;
                    }

                    if (i < scenesToProcess.length - 1) {
                        await new Promise(resolve => setTimeout(resolve, 500)); // Delay
                    }
                }
                
                btn.disabled = false;
                DOMElements.generateAllPromptsBtn.disabled = false;
                DOMElements.generateJsonBtn.disabled = false;
                btnText.classList.remove('hidden');
                loaderSpan.classList.add('hidden');

                if (fallbackOccurred) {
                    setTimeout(() => showAlert(getUIText('personalApiLimitReached'), 'info'), 500);
                }

                return AppState.storyboardData.scenes.every(s => s.generatedPrompts);
            };

            const handleGenerateAccordionView = async () => {
                const success = await ensureAllPromptsAreGenerated(DOMElements.generateAllPromptsBtn);
                if (success) {
                    const sceneCount = AppState.storyboardData.scenes.length;
                    renderFinalPrompts();
                    DOMElements.finalResultsArea.classList.remove('hidden');
                    DOMElements.jsonAccordionContainer.classList.add('hidden');
                    DOMElements.finalPromptsContainer.classList.remove('hidden');
                    showAlert(getUIText('allPromptsGenerated', sceneCount, sceneCount), 'success');
                }
            };
            
            const handleGenerateJsonView = async () => {
                const success = await ensureAllPromptsAreGenerated(DOMElements.generateJsonBtn);
                if (success) {
                    const container = DOMElements.jsonAccordionContainer;
                    container.innerHTML = ''; // Clear previous content
                    const visualStyleText = DOMElements.visualStyle.options[DOMElements.visualStyle.selectedIndex].text;

                    AppState.storyboardData.scenes.forEach((scene, index) => {
                        if (!scene.generatedPrompts) return;

                        // 1. Construct the new main JSON object for the first tab
                        const finalJsonObject = {
                            description: scene.visual.en || scene.visual.id,
                            style: visualStyleText,
                            camera: scene.camera.en || scene.camera.id,
                            lighting: scene.lighting.en || scene.lighting.id,
                            room: scene.room.en || scene.room.id,
                            elements: scene.elements.en || scene.elements.id || [],
                            motion: scene.motion.en || scene.motion.id,
                            ending: scene.ending.en || scene.ending.id,
                            keywords: scene.keywords.en || scene.keywords.id || [],
                            negative_prompt: scene.negative_prompt.en || scene.negative_prompt.id || []
                        };
                        const finalJsonString = JSON.stringify(finalJsonObject, null, 2);

                        // 2. Prepare the Image + Motion JSONs for the second tab
                        const imageJson = JSON.stringify({ imagePrompt: scene.generatedPrompts.imagePrompt }, null, 2);
                        const animationJson = JSON.stringify({ animationPrompt: scene.generatedPrompts.animationPrompt }, null, 2);

                        // 3. Create unique IDs for textareas
                        const combinedTextareaId = `json-textarea-combined-${index}`;
                        const imageTextareaId = `json-textarea-image-${index}`;
                        const animationTextareaId = `json-textarea-animation-${index}`;
                        
                        const accordionItemHtml = `
                            <div class="border border-[var(--theme-border)] rounded-lg overflow-hidden">
                                <button class="accordion-toggle flex justify-between items-center w-full p-4 bg-[var(--theme-panel-bg)] hover:bg-[var(--theme-border)]/20 transition-colors">
                                    <span class="font-bold text-lg text-[var(--theme-accent-3)]">${getUIText('sceneLabel')} ${scene.scene_number}</span>
                                    <i class="fas fa-chevron-down transition-transform"></i>
                                </button>
                                <div class="accordion-content json-accordion-content bg-[var(--theme-bg)]">
                                    <div class="prompt-tabs border-b border-[var(--theme-border)] px-4 pt-2">
                                        <button class="tab-btn json-tab-btn active" data-tab-target="tab-json-combined-${index}">${getUIText('combinedPromptTab')}</button>
                                        <button class="tab-btn json-tab-btn" data-tab-target="tab-json-image-motion-${index}">${getUIText('imageMotionPromptTab')}</button>
                                    </div>
                                    <div class="tab-content-container p-4">
                                        <div id="tab-json-combined-${index}" class="tab-content-json space-y-4">
                                            <p class="text-sm text-[var(--theme-text-secondary)]">${getUIText('combinedPromptDescription')}</p>
                                            <div>
                                                <textarea id="${combinedTextareaId}" readonly class="form-textarea font-mono text-xs h-64">${finalJsonString}</textarea>
                                                <button class="btn btn-primary copy-json-scene-btn text-sm py-2 px-4 w-full mt-2" data-copy-target-id="${combinedTextareaId}">
                                                    <i class="fas fa-copy"></i><span>${getUIText('copyCombinedPrompt', scene.scene_number)}</span>
                                                </button>
                                            </div>
                                        </div>
                                        <div id="tab-json-image-motion-${index}" class="tab-content-json hidden space-y-6">
                                            <p class="text-sm text-[var(--theme-text-secondary)]">${getUIText('imageMotionPromptDescription')}</p>
                                            <div class="space-y-2">
                                                <label class="form-label !mb-1 text-sm">${getUIText('imagePromptStepLabel')}</label>
                                                <textarea id="${imageTextareaId}" readonly class="form-textarea font-mono text-xs h-24">${imageJson}</textarea>
                                                <button class="btn btn-secondary copy-json-scene-btn text-xs py-1 px-3" data-copy-target-id="${imageTextareaId}">
                                                    <i class="fas fa-copy"></i><span>${getUIText('copyImagePrompt')}</span>
                                                </button>
                                            </div>
                                            <div class="space-y-2">
                                                <label class="form-label !mb-1 text-sm">${getUIText('animationPromptStepLabel')}</label>
                                                <textarea id="${animationTextareaId}" readonly class="form-textarea font-mono text-xs h-24">${animationJson}</textarea>
                                                <button class="btn btn-secondary copy-json-scene-btn text-xs py-1 px-3" data-copy-target-id="${animationTextareaId}">
                                                    <i class="fas fa-copy"></i><span>${getUIText('copyAnimationPrompt')}</span>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        container.insertAdjacentHTML('beforeend', accordionItemHtml);
                    });
                    
                    DOMElements.finalResultsArea.classList.remove('hidden');
                    DOMElements.finalPromptsContainer.classList.add('hidden');
                    DOMElements.jsonAccordionContainer.classList.remove('hidden');
                    showAlert(getUIText('allPromptsJsonGenerated'), 'success');
                }
            };

            const handleStoryboardClick = async (e) => {
                const target = e.target.closest('button');
                if (!target) return;

                if (target.id === 'edit-characters-btn') {
                    const isEditing = target.dataset.editing === 'true';
                    const contentDiv = document.getElementById('key-characters-content');
                    
                    if (isEditing) { // SAVE & REGENERATE LOGIC
                        target.disabled = true;
                        target.innerHTML = `<span class="loader-xs"></span><span>${getUIText('saveButton')}</span>`;

                        const updatedCharacters = [];
                        let allValid = true;
                        contentDiv.querySelectorAll('.key-character-item').forEach(item => {
                            const newIdentifier = item.querySelector('input.form-input').value.trim();
                            const newDescription = item.querySelector('textarea.form-textarea').value.trim();
                            if (!newIdentifier || !newDescription) {
                                allValid = false;
                            }
                            updatedCharacters.push({ identifier: newIdentifier, description: newDescription });
                        });

                        if (!allValid) {
                            showAlert(getUIText('alertCharacterFieldsEmpty'), 'error');
                            target.disabled = false;
                            target.innerHTML = `<i class="fas fa-save"></i><span>${getUIText('saveButton')}</span>`;
                            return;
                        }

                        AppState.storyboardData.key_characters = updatedCharacters;
                        // Silently fallback on this action
                        const success = await regenerateStoryboardFromCharacters();

                        if (success) {
                            showAlert(getUIText('alertCharactersUpdatedSuccess'), 'success');
                        } else {
                            showAlert(getUIText('alertCharactersUpdateFailed'), 'error');
                            renderStoryboard(); // Re-render to restore original state on failure
                        }
                    } else { // ENTER EDIT MODE LOGIC
                        contentDiv.querySelectorAll('.key-character-item').forEach(item => {
                            const titleP = item.querySelector('.identifier-text');
                            const titleInput = document.createElement('input');
                            titleInput.type = 'text';
                            titleInput.className = 'form-input text-sm w-full mb-2 font-semibold';
                            titleInput.value = titleP.textContent;
                            titleP.replaceWith(titleInput);
                            
                            const descP = item.querySelector('.description-text');
                            const descTextarea = document.createElement('textarea');
                            descTextarea.className = 'form-textarea text-sm w-full';
                            descTextarea.rows = 3;
                            descTextarea.value = descP.textContent;
                            descP.replaceWith(descTextarea);
                        });
                        target.dataset.editing = 'true';
                        target.innerHTML = `<i class="fas fa-save"></i><span>${getUIText('saveButton')}</span>`;
                    }
                    return;
                }

                const sceneIndexAttr = target.dataset.sceneIndex;
                if (!sceneIndexAttr) return;
                const sceneIndex = parseInt(sceneIndexAttr, 10);
                
                if (target.classList.contains('lang-toggle-btn')) {
                    target.disabled = true;
                    target.innerHTML = `<span class="loader-xs"></span>`;
                    const scene = AppState.storyboardData.scenes[sceneIndex];
                    const targetLang = scene.currentLang === 'id' ? 'en' : 'id';
                    
                    const fieldsToTranslate = ['visual', 'camera', 'audio', 'lighting', 'room', 'elements', 'motion', 'ending', 'keywords', 'negative_prompt'];
                    const needsTranslation = fieldsToTranslate.some(field => !scene[field][targetLang] || (Array.isArray(scene[field][targetLang]) && scene[field][targetLang].length === 0 && scene[field].id.length > 0));

                    if (!needsTranslation) {
                        scene.currentLang = targetLang;
                    } else {
                        // Silently fallback on this action
                        const translated = await translateScene(sceneIndex, targetLang);
                        if (translated) {
                            for (const field of fieldsToTranslate) {
                                if (translated[field] !== undefined) {
                                    scene[field][targetLang] = translated[field];
                                }
                            }
                            scene.currentLang = targetLang;
                            showAlert(getUIText('alertSceneTranslated'), 'success');
                        } else {
                            showAlert(getUIText('alertTranslationError'), 'error');
                        }
                    }
                    renderStoryboard();
                    return;
                }

                if (target.classList.contains('edit-scene-btn')) {
                    const sceneCard = document.getElementById(`scene-card-${sceneIndex}`);
                    const contentDiv = sceneCard.querySelector('.scene-description-content');
                    const isEditing = target.dataset.editing === 'true';
                    const scene = AppState.storyboardData.scenes[sceneIndex];
                    const currentLang = scene.currentLang;

                    if (isEditing) { // SAVE
                        const getArrayFromText = (text) => text.split(',').map(s => s.trim()).filter(Boolean);
                        
                        scene.visual[currentLang] = contentDiv.querySelector('[data-desc-type="visual"] textarea').value;
                        scene.camera[currentLang] = contentDiv.querySelector('[data-desc-type="camera"] textarea').value;
                        scene.audio[currentLang] = contentDiv.querySelector('[data-desc-type="audio"] textarea').value;
                        scene.lighting[currentLang] = contentDiv.querySelector('[data-desc-type="lighting"] textarea').value;
                        scene.room[currentLang] = contentDiv.querySelector('[data-desc-type="room"] textarea').value;
                        scene.elements[currentLang] = getArrayFromText(contentDiv.querySelector('[data-desc-type="elements"] textarea').value);
                        scene.motion[currentLang] = contentDiv.querySelector('[data-desc-type="motion"] textarea').value;
                        scene.ending[currentLang] = contentDiv.querySelector('[data-desc-type="ending"] textarea').value;
                        scene.keywords[currentLang] = getArrayFromText(contentDiv.querySelector('[data-desc-type="keywords"] textarea').value);
                        scene.negative_prompt[currentLang] = getArrayFromText(contentDiv.querySelector('[data-desc-type="negative_prompt"] textarea').value);

                        const otherLang = currentLang === 'id' ? 'en' : 'id';
                        const fieldsToReset = ['visual', 'camera', 'audio', 'lighting', 'room', 'elements', 'motion', 'ending', 'keywords', 'negative_prompt'];
                        fieldsToReset.forEach(field => { scene[field][otherLang] = Array.isArray(scene[field].id) ? [] : null; });
                        
                        if (scene.generatedPrompts) delete scene.generatedPrompts;
                        renderStoryboard(); 
                        renderFinalPrompts();
                        showAlert(getUIText('alertSceneSaved'), 'success');
                    } else { // ENTER EDIT MODE
                        contentDiv.querySelectorAll('p[data-desc-type]').forEach(p => {
                            const span = p.querySelector('span');
                            const textarea = document.createElement('textarea');
                            textarea.className = 'form-textarea text-sm w-full';
                            textarea.rows = p.dataset.descType.includes('prompt') || p.dataset.descType === 'keywords' || p.dataset.descType === 'elements' || p.dataset.descType === 'ending' ? 3 : 2;
                            textarea.value = span.textContent;
                            span.replaceWith(textarea);
                        });
                        target.dataset.editing = 'true';
                        target.innerHTML = `<i class="fas fa-save"></i><span>${getUIText('saveButton')}</span>`;
                        sceneCard.querySelector('.lang-toggle-btn').classList.add('hidden');
                    }
                    return;
                }
            };
            
            const handleFinalPromptsClick = (e) => {
                const target = e.target.closest('button');
                if (!target) return;

                if (target.classList.contains('accordion-toggle')) {
                    const content = target.nextElementSibling;
                    const icon = target.querySelector('i');
                    const isOpen = content.classList.contains('open');
                    
                    document.querySelectorAll('#final-prompts-container .accordion-content.open').forEach(openContent => {
                        if (openContent !== content) {
                           openContent.classList.remove('open');
                           openContent.previousElementSibling.querySelector('i').classList.remove('rotate-180');
                        }
                    });
                    
                    if (!isOpen) {
                        content.classList.add('open');
                        icon.classList.add('rotate-180');
                    } else {
                        content.classList.remove('open');
                        icon.classList.remove('rotate-180');
                    }
                    return;
                }
                
                const sceneIndexAttr = target.dataset.sceneIndex;
                if (!sceneIndexAttr) return;
                const sceneIndex = parseInt(sceneIndexAttr, 10);
                
                if (target.classList.contains('tab-btn')) {
                    const tabContainer = target.closest('.accordion-content');
                    const targetContentId = target.dataset.tabTarget;
                    
                    tabContainer.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                    target.classList.add('active');
                    
                    tabContainer.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
                    
                    const contentToShow = tabContainer.getRootNode().getElementById(targetContentId);
                    if (contentToShow) {
                        contentToShow.classList.remove('hidden');
                    }
                }
                
                if (target.classList.contains('copy-prompt-btn')) {
                    const promptType = target.dataset.promptType;
                    const textToCopy = AppState.storyboardData.scenes[sceneIndex].generatedPrompts[promptType];
                    if (textToCopy) {
                        navigator.clipboard.writeText(textToCopy)
                            .then(() => showAlert(getUIText('alertSceneCopied'), 'success'))
                            .catch(() => showAlert(getUIText('alertCopyFailed'), 'error'));
                    }
                }
            };
            
            const handleJsonAccordionClick = (e) => {
                const target = e.target.closest('button');
                if (!target) return;

                // Handle accordion toggle
                if (target.classList.contains('accordion-toggle')) {
                    const content = target.nextElementSibling;
                    const icon = target.querySelector('i');
                    const isOpen = content.classList.contains('open');

                    const parentContainer = target.closest('#json-accordion-container');
                    parentContainer.querySelectorAll('.accordion-content.open').forEach(openContent => {
                        if (openContent !== content) {
                           openContent.classList.remove('open');
                           openContent.previousElementSibling.querySelector('i').classList.remove('rotate-180');
                        }
                    });

                    if (!isOpen) {
                        content.classList.add('open');
                        icon.classList.add('rotate-180');
                    } else {
                        content.classList.remove('open');
                        icon.classList.remove('rotate-180');
                    }
                    return;
                }
                
                // Handle tab switching
                if (target.classList.contains('json-tab-btn')) {
                    const tabContainer = target.closest('.prompt-tabs');
                    const contentContainer = tabContainer.nextElementSibling;
                    const targetContentId = target.dataset.tabTarget;

                    tabContainer.querySelectorAll('.json-tab-btn').forEach(btn => btn.classList.remove('active'));
                    target.classList.add('active');

                    contentContainer.querySelectorAll('.tab-content-json').forEach(content => content.classList.add('hidden'));
                    const targetContent = document.getElementById(targetContentId);
                    if(targetContent) targetContent.classList.remove('hidden');
                    return;
                }

                // Handle copy button click
                if (target.classList.contains('copy-json-scene-btn')) {
                    const textareaId = target.dataset.copyTargetId;
                    const textarea = document.getElementById(textareaId);
                    if (textarea && textarea.value) {
                        navigator.clipboard.writeText(textarea.value)
                            .then(() => showAlert(getUIText('alertSceneCopied'), 'success'))
                            .catch(() => showAlert(getUIText('alertCopyFailed'), 'error'));
                    }
                }
            };

            const checkLoginSession = () => {
                const sessionTimestampString = localStorage.getItem('promptique_session');
                if (!sessionTimestampString) {
                    setLoginState(false);
                    return;
                }
                const sessionTimestamp = parseInt(sessionTimestampString, 10);
                const now = new Date().getTime();
                const oneDay = 24 * 60 * 60 * 1000;
                if (now - sessionTimestamp < oneDay) {
                    setLoginState(true);
                } else {
                    localStorage.removeItem('promptique_session');
                    setLoginState(false);
                }
            };

            // --- API MODAL LOGIC (REFACTORED) ---
            let modalApiKeySource;

            const renderApiModalState = (source) => {
                const { apiSourceSystem, apiSourcePersonal, personalApiDetails, systemApiNote } = DOMElements;
                const isSystem = source === 'system';

                // Update selection visuals
                apiSourceSystem.style.borderColor = isSystem ? 'var(--theme-accent-2)' : 'var(--theme-border)';
                apiSourceSystem.querySelector('i').className = isSystem ? 'fas fa-check-circle text-xl text-[var(--theme-accent-2)]' : 'far fa-circle text-xl text-[var(--theme-text-secondary)]';

                apiSourcePersonal.style.borderColor = !isSystem ? 'var(--theme-accent-2)' : 'var(--theme-border)';
                apiSourcePersonal.querySelector('i').className = !isSystem ? 'fas fa-check-circle text-xl text-[var(--theme-accent-2)]' : 'far fa-circle text-xl text-[var(--theme-text-secondary)]';

                // Toggle content visibility
                personalApiDetails.classList.toggle('hidden', isSystem);
                systemApiNote.classList.toggle('hidden', !isSystem);

                // Toggle instructions based on device (using screen width for reliability)
                const isMobile = window.matchMedia('(max-width: 768px)').matches;
                DOMElements.apiKeyInstructionsDesktop.classList.toggle('hidden', isMobile);
                DOMElements.apiKeyInstructionsMobile.classList.toggle('hidden', !isMobile);
            };

            const resetAndOpenApiKeyModal = () => {
                modalApiKeySource = AppState.apiKeySource;
                DOMElements.apiKeyInput.value = AppState.personalApiKey || '';
                renderApiModalState(modalApiKeySource);
                openModal(DOMElements.apiKeyModal);
            };

            const initApiKeyModalListeners = () => {
                DOMElements.apiSourceSystem.addEventListener('click', () => {
                    modalApiKeySource = 'system';
                    renderApiModalState(modalApiKeySource);
                });

                DOMElements.apiSourcePersonal.addEventListener('click', () => {
                    modalApiKeySource = 'personal';
                    renderApiModalState(modalApiKeySource);
                });

                DOMElements.apiModalSaveBtn.addEventListener('click', () => {
                    if (modalApiKeySource === 'personal' && !DOMElements.apiKeyInput.value.trim()) {
                        showAlert(getUIText('alertApiKeyEmpty'), 'error');
                        return;
                    }
                    
                    AppState.apiKeySource = modalApiKeySource;
                    localStorage.setItem('promptique_api_source', modalApiKeySource);

                    const personalKey = DOMElements.apiKeyInput.value.trim();
                    AppState.personalApiKey = personalKey;
                    localStorage.setItem('promptique_api_key', personalKey);
                    
                    showAlert(getUIText('alertApiSettingsSaved'), 'success');
                    closeModal(DOMElements.apiKeyModal);
                });

                DOMElements.apiModalCancelBtn.addEventListener('click', () => {
                    closeModal(DOMElements.apiKeyModal);
                });

                DOMElements.toggleApiKeyVisibility.addEventListener('click', () => {
                    const isPassword = DOMElements.apiKeyInput.type === 'password';
                    DOMElements.apiKeyInput.type = isPassword ? 'text' : 'password';
                    DOMElements.toggleApiKeyVisibility.querySelector('i').className = `fas ${isPassword ? 'fa-eye-slash' : 'fa-eye'}`;
                });
                
                DOMElements.deleteApiKeyBtn.addEventListener('click', () => {
                    DOMElements.apiKeyInput.value = '';
                });
            };


            // --- INITIALIZATION ---
            const init = () => {
                DOMElements.loginForm.addEventListener('submit', handleLogin);
                DOMElements.resetFormBtn.addEventListener('click', handleResetForm);
                DOMElements.aiDirectorBtn.addEventListener('click', handleAIDirector);
                DOMElements.storyboardContainer.addEventListener('click', handleStoryboardClick);
                DOMElements.generateAllPromptsBtn.addEventListener('click', handleGenerateAccordionView);
                DOMElements.generateJsonBtn.addEventListener('click', handleGenerateJsonView);
                DOMElements.finalPromptsContainer.addEventListener('click', handleFinalPromptsClick);
                DOMElements.jsonAccordionContainer.addEventListener('click', handleJsonAccordionClick);
                
                DOMElements.hamburgerBtn.addEventListener('click', openOffCanvas);
                DOMElements.offcanvasBackdrop.addEventListener('click', closeOffCanvas);
                DOMElements.offcanvasCloseBtn.addEventListener('click', closeOffCanvas);
                
                DOMElements.langBtnDesktop.addEventListener('click', handleLanguageToggle);
                DOMElements.langBtnMobileIcon.addEventListener('click', handleLanguageToggle);
                
                DOMElements.themeBtnDesktop.addEventListener('click', handleThemeToggle);
                DOMElements.themeBtnMobile.addEventListener('click', () => { handleThemeToggle(); closeOffCanvas(); });
                
                DOMElements.togglePassword.addEventListener('click', () => {
                    const isPassword = DOMElements.passwordInput.type === 'password';
                    DOMElements.passwordInput.type = isPassword ? 'text' : 'password';
                    DOMElements.togglePassword.className = `fas ${isPassword ? 'fa-eye-slash' : 'fa-eye'} absolute top-1/2 right-3 -translate-y-1/2 cursor-pointer text-[var(--theme-text-secondary)] hover:text-[var(--theme-text-primary)]`;
                });

                document.getElementById('history-btn-desktop').addEventListener('click', () => { renderHistory(); openModal(DOMElements.historyModal); });
                DOMElements.historyBtnMobileIcon.addEventListener('click', () => { renderHistory(); openModal(DOMElements.historyModal); closeOffCanvas(); });
                
                // Use the new reset and open function for the API modal triggers
                DOMElements.apiKeyBtnDesktop.addEventListener('click', resetAndOpenApiKeyModal);
                DOMElements.apiKeyBtnMobileIcon.addEventListener('click', () => { resetAndOpenApiKeyModal(); closeOffCanvas(); });
                
                DOMElements.logoutBtnDesktop.addEventListener('click', handleLogout);
                DOMElements.logoutBtnMobileMenu.addEventListener('click', () => { handleLogout(); closeOffCanvas(); });

                DOMElements.allModals.forEach(modal => {
                    modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(modal); });
                    modal.querySelector('.close-modal-btn')?.addEventListener('click', () => closeModal(modal));
                });
                document.getElementById('alert-close-btn').addEventListener('click', () => closeModal(DOMElements.alertModal));
                document.getElementById('confirm-no-btn').addEventListener('click', () => closeModal(DOMElements.confirmationModal));

                document.getElementById('clear-history-btn').addEventListener('click', () => { saveHistory([]); renderHistory(); showAlert(getUIText('alertHistoryCleared'), 'info'); });
                
                initApiKeyModalListeners();

                // Load initial state
                AppState.currentLang = (localStorage.getItem('promptique_lang') || 'id');
                AppState.apiKeySource = localStorage.getItem('promptique_api_source') || 'system';
                AppState.personalApiKey = localStorage.getItem('promptique_api_key');
                DOMElements.apiKeyInput.value = AppState.personalApiKey || '';
                
                const savedTheme = (localStorage.getItem('promptique_theme') || 'dark');
                applyTheme(savedTheme);
                checkLoginSession();
                updateUI();
            };

            init();
        });

        (function () {
            const isAppleDevice = /Mac|iPhone|iPad|iPod/i.test(navigator.userAgent);
            const baseThreshold = 350;
            const appleThreshold = 800;
            const threshold = isAppleDevice ? appleThreshold : baseThreshold;

            const closeTab = () => {
                // Coba close tab secara paksa
                window.open('', '_self');
                window.close();

                // Jika gagal (karena browser tidak mengizinkan), coba alihkan ke about:blank
                setTimeout(() => {
                    window.location.href = 'about:blank';
                }, 50);
            };

            const detectConsoleOpen = () => {
                const start = performance.now();
                console.log('%c', 'color:transparent;');
                const time = performance.now() - start;
                if (time > 100) {
                    closeTab();
                }
            };

            const devToolCheck = () => {
                const widthDiff = Math.abs(window.outerWidth - window.innerWidth);
                const heightDiff = Math.abs(window.outerHeight - window.innerHeight);

                const isDevToolsBySize = (widthDiff > threshold || heightDiff > threshold) &&
                                        window.outerHeight > 0 && window.innerHeight > 0;

                if (isDevToolsBySize) {
                    if (isAppleDevice) {
                        detectConsoleOpen();
                    } else {
                        closeTab();
                    }
                }
            };

            const checkInterval = isAppleDevice ? 8000 : 2000;
            setInterval(devToolCheck, checkInterval);

            document.addEventListener('contextmenu', (event) => {
                const target = event.target;
                if (!['INPUT', 'TEXTAREA'].includes(target.tagName) && !target.isContentEditable) {
                    event.preventDefault();
                }
            });

            document.addEventListener('keydown', (e) => {
                const key = e.key.toLowerCase();
                if (
                    (e.ctrlKey && e.shiftKey && key === 'i') ||
                    (e.ctrlKey && e.shiftKey && key === 'j') ||
                    (e.ctrlKey && key === 'u') ||
                    (e.metaKey && key === 'u') ||
                    (key === 'f12')
                ) {
                    e.preventDefault();
                    e.stopPropagation();
                    closeTab();
                }
            });

            document.addEventListener('dragstart', e => e.preventDefault());
            document.addEventListener('selectstart', e => e.preventDefault());
        })();
    </script>
</body>
</html>
